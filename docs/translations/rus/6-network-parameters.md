[<- Назад: Синхронизация времени](5-timing-security.md) | [Содержание](index.md) | [Далее: Справочник по RPC ->](7-rpc-reference.md)

---

# Глава 6: Сетевые параметры и конфигурация

Полный справочник по конфигурации сети Bitcoin-PoCX для всех типов сетей.

---

## Содержание

1. [Параметры генезис-блока](#параметры-генезис-блока)
2. [Конфигурация Chainparams](#конфигурация-chainparams)
3. [Параметры консенсуса](#параметры-консенсуса)
4. [Coinbase и вознаграждения за блок](#coinbase-и-вознаграждения-за-блок)
5. [Динамическое масштабирование](#динамическое-масштабирование)
6. [Конфигурация сети](#конфигурация-сети)
7. [Структура каталога данных](#структура-каталога-данных)

---

## Параметры генезис-блока

### Вычисление базовой цели

**Формула**: `genesis_base_target = 2^42 / block_time_seconds`

**Обоснование**:
- Каждый нонс представляет 256 КиБ (64 байта x 4096 скупов)
- 1 ТиБ = 2^22 нонсов (допущение о начальной ёмкости сети)
- Ожидаемое минимальное качество для n нонсов примерно = 2^64 / n
- Для 1 ТиБ: E(качество) = 2^64 / 2^22 = 2^42
- Следовательно: base_target = 2^42 / block_time

**Вычисленные значения**:
- Mainnet/Testnet/Signet (120с): `36650387592`
- Regtest (1с): Использует режим калибровки для малой ёмкости

### Сообщение генезиса

Все сети используют сообщение генезиса Bitcoin:
```
"The Times 03/Jan/2009 Chancellor on brink of second bailout for banks"
```

**Реализация**: `src/kernel/chainparams.cpp`

---

## Конфигурация Chainparams

### Параметры Mainnet

**Идентификация сети**:
- **Magic Bytes**: `0xa7 0x3c 0x91 0x5e`
- **Порт по умолчанию**: `8888`
- **Bech32 HRP**: `pocx`

**Префиксы адресов** (Base58):
- PUBKEY_ADDRESS: `85` (адреса начинаются с 'P')
- SCRIPT_ADDRESS: `90` (адреса начинаются с 'R')
- SECRET_KEY: `128`

**Время блоков**:
- **Целевое время блока**: `120` секунд (2 минуты)
- **Целевой период**: `1209600` секунд (14 дней)
- **MAX_FUTURE_BLOCK_TIME**: `15` секунд

**Вознаграждения за блок**:
- **Начальная субсидия**: `10 BTC`
- **Интервал халвинга**: `1050000` блоков (~4 года)
- **Количество халвингов**: Максимум 64 халвинга

**Корректировка сложности**:
- **Скользящее окно**: `24` блока
- **Корректировка**: Каждый блок
- **Алгоритм**: Экспоненциальное скользящее среднее

**Задержки делегирования**:
- **Активация**: `30` блоков (~1 час)
- **Отзыв**: `720` блоков (~24 часа)

### Параметры Testnet

**Идентификация сети**:
- **Magic Bytes**: `0x6d 0xf2 0x48 0xb3`
- **Порт по умолчанию**: `18888`
- **Bech32 HRP**: `tpocx`

**Префиксы адресов** (Base58):
- PUBKEY_ADDRESS: `127`
- SCRIPT_ADDRESS: `132`
- SECRET_KEY: `255`

**Время блоков**:
- **Целевое время блока**: `120` секунд
- **MAX_FUTURE_BLOCK_TIME**: `15` секунд
- **Разрешить минимальную сложность**: `true`

**Вознаграждения за блок**:
- **Начальная субсидия**: `10 BTC`
- **Интервал халвинга**: `1050000` блоков

**Корректировка сложности**:
- **Скользящее окно**: `24` блока

**Задержки делегирования**:
- **Активация**: `30` блоков (~1 час)
- **Отзыв**: `720` блоков (~24 часа)

### Параметры Regtest

**Идентификация сети**:
- **Magic Bytes**: `0xfa 0xbf 0xb5 0xda`
- **Порт по умолчанию**: `18444`
- **Bech32 HRP**: `rpocx`

**Префиксы адресов** (совместимые с Bitcoin):
- PUBKEY_ADDRESS: `111`
- SCRIPT_ADDRESS: `196`
- SECRET_KEY: `239`

**Время блоков**:
- **Целевое время блока**: `1` секунда (мгновенный майнинг для тестирования)
- **Целевой период**: `86400` секунд (1 день)
- **MAX_FUTURE_BLOCK_TIME**: `15` секунд

**Вознаграждения за блок**:
- **Начальная субсидия**: `10 BTC`
- **Интервал халвинга**: `500` блоков

**Корректировка сложности**:
- **Скользящее окно**: `24` блока
- **Разрешить минимальную сложность**: `true`
- **Без пересчёта цели**: `true`
- **Калибровка малой ёмкости**: `true` (использует калибровку на 16 нонсов вместо 1 ТиБ)

**Задержки делегирования**:
- **Активация**: `4` блока (~4 секунды)
- **Отзыв**: `8` блоков (~8 секунд)

### Параметры Signet

**Идентификация сети**:
- **Magic Bytes**: Первые 4 байта SHA256d(signet_challenge)
- **Порт по умолчанию**: `38333`
- **Bech32 HRP**: `tpocx`

**Время блоков**:
- **Целевое время блока**: `120` секунд
- **MAX_FUTURE_BLOCK_TIME**: `15` секунд

**Вознаграждения за блок**:
- **Начальная субсидия**: `10 BTC`
- **Интервал халвинга**: `1050000` блоков

**Корректировка сложности**:
- **Скользящее окно**: `24` блока

---

## Параметры консенсуса

### Параметры времени

**MAX_FUTURE_BLOCK_TIME**: `15` секунд
- Специфично для PoCX (Bitcoin использует 2 часа)
- Обоснование: Синхронизация времени PoC требует валидации близкой к реальному времени
- Блоки более чем на 15с в будущем отклоняются

**Предупреждение о временном смещении**: `10` секунд
- Операторы предупреждаются когда часы узла отклоняются >10с от сетевого времени
- Без принуждения, только информационное

**Целевое время блока**:
- Mainnet/Testnet/Signet: `120` секунд
- Regtest: `1` секунда

**TIMESTAMP_WINDOW**: `15` секунд (равно MAX_FUTURE_BLOCK_TIME)

**Реализация**: `src/chain.h`, `src/validation.cpp`

### Параметры корректировки сложности

**Размер скользящего окна**: `24` блока (все сети)
- Экспоненциальное скользящее среднее недавних времён блоков
- Корректировка каждый блок
- Реагирует на изменения ёмкости

**Реализация**: `src/consensus/params.h`, логика сложности при создании блока

### Параметры системы делегирования

**nForgingAssignmentDelay** (задержка активации):
- Mainnet: `30` блоков (~1 час)
- Testnet: `30` блоков (~1 час)
- Regtest: `4` блока (~4 секунды)

**nForgingRevocationDelay** (задержка отзыва):
- Mainnet: `720` блоков (~24 часа)
- Testnet: `720` блоков (~24 часа)
- Regtest: `8` блоков (~8 секунд)

**Обоснование**:
- Задержка активации предотвращает быстрое переназначение во время гонок блоков
- Задержка отзыва обеспечивает стабильность и предотвращает злоупотребления

**Реализация**: `src/consensus/params.h`

---

## Coinbase и вознаграждения за блок

### График субсидии блоков

**Начальная субсидия**: `10 BTC` (все сети)

**График халвинга**:
- Каждые `1050000` блоков (mainnet/testnet)
- Каждые `500` блоков (regtest)
- Продолжается максимум 64 халвинга

**Прогрессия халвинга**:
```
Халвинг 0: 10.00000000 BTC  (блоки 0 - 1049999)
Халвинг 1:  5.00000000 BTC  (блоки 1050000 - 2099999)
Халвинг 2:  2.50000000 BTC  (блоки 2100000 - 3149999)
Халвинг 3:  1.25000000 BTC  (блоки 3150000 - 4199999)
...
```

**Общее предложение**: ~21 миллион BTC (как у Bitcoin)

### Правила выхода Coinbase

**Адрес назначения платежа**:
- **Без делегирования**: Coinbase платит адресу графика (proof.account_id)
- **С делегированием**: Coinbase платит адресу форджинга (эффективный подписант)

**Формат выхода**: Только P2WPKH
- Coinbase должен платить на bech32 SegWit v0 адрес
- Генерируется из публичного ключа эффективного подписанта

**Разрешение делегирования**:
```cpp
effective_signer = GetEffectiveSigner(plot_address, height, view);
coinbase_script = P2WPKH(effective_signer);
```

**Реализация**: `src/pocx/mining/scheduler.cpp:ForgeBlock()`

---

## Динамическое масштабирование

### Границы масштабирования

**Цель**: Увеличение сложности генерации графиков по мере созревания сети для предотвращения инфляции ёмкости

**Структура**:
```cpp
struct CompressionBounds {
    uint8_t nPoCXMinCompression;     // Минимальный принимаемый уровень
    uint8_t nPoCXTargetCompression;  // Рекомендуемый уровень
};
```

**Соотношение**: `target = min + 1` (всегда на один уровень выше минимума)

### График увеличения масштабирования

Уровни масштабирования увеличиваются по **экспоненциальному графику** на основе интервалов халвинга:

| Период | Высота блока | Халвинги | Мин | Цель |
|--------|--------------|----------|-----|------|
| Годы 0-4 | 0 до 1049999 | 0 | X1 | X2 |
| Годы 4-12 | 1050000 до 3149999 | 1-2 | X2 | X3 |
| Годы 12-28 | 3150000 до 7349999 | 3-6 | X3 | X4 |
| Годы 28-60 | 7350000 до 15749999 | 7-14 | X4 | X5 |
| Годы 60-124 | 15750000 до 32549999 | 15-30 | X5 | X6 |
| Годы 124+ | 32550000+ | 31+ | X6 | X7 |

**Ключевые высоты** (годы -> халвинги -> блоки):
- Год 4: Халвинг 1 на блоке 1050000
- Год 12: Халвинг 3 на блоке 3150000
- Год 28: Халвинг 7 на блоке 7350000
- Год 60: Халвинг 15 на блоке 15750000
- Год 124: Халвинг 31 на блоке 32550000

### Сложность уровня масштабирования

**Масштабирование PoW**:
- Уровень масштабирования X0: Базовая линия POC2 (теоретический)
- Уровень масштабирования X1: Базовая линия XOR-транспонирования
- Уровень масштабирования Xn: 2^(n-1) × встроенной работы X1
- Каждый уровень удваивает работу по генерации графика

**Экономическое согласование**:
- Вознаграждения за блок уменьшаются вдвое -> сложность генерации графика увеличивается
- Поддерживает запас безопасности: стоимость создания графика > стоимость поиска
- Предотвращает инфляцию ёмкости от улучшений оборудования

### Валидация графиков

**Правила валидации**:
- Отправленные доказательства должны иметь уровень масштабирования >= минимума
- Доказательства с масштабированием > цели принимаются, но неэффективны
- Доказательства ниже минимума: отклоняются (недостаточно PoW)

**Получение границ**:
```cpp
auto bounds = GetPoCXCompressionBounds(height, halving_interval);
```

**Реализация**: `src/pocx/algorithms/algorithms.h:GetPoCXCompressionBounds()`, `src/pocx/consensus/params.cpp`

---

## Конфигурация сети

### Seed-узлы и DNS Seeds

**Статус**: Заглушка для запуска mainnet

**Планируемая конфигурация**:
- Seed-узлы: Будет определено
- DNS seeds: Будет определено

**Текущее состояние** (testnet/regtest):
- Нет выделенной seed-инфраструктуры
- Поддерживается ручное подключение пиров через `-addnode`

**Реализация**: `src/kernel/chainparams.cpp`

### Контрольные точки

**Контрольная точка генезиса**: Всегда блок 0

**Дополнительные контрольные точки**: В настоящее время не настроены

**Будущее**: Контрольные точки будут добавлены по мере развития mainnet

---

## Конфигурация P2P-протокола

### Версия протокола

**База**: Протокол Bitcoin Core v30.0
- **Версия протокола**: Унаследована от Bitcoin Core
- **Биты сервисов**: Стандартные сервисы Bitcoin
- **Типы сообщений**: Стандартные P2P-сообщения Bitcoin

**Расширения PoCX**:
- Заголовки блоков включают специфичные для PoCX поля
- Сообщения блоков включают данные доказательства PoCX
- Правила валидации применяют консенсус PoCX

**Совместимость**: Узлы PoCX несовместимы с узлами Bitcoin PoW (разный консенсус)

**Реализация**: `src/protocol.h`, `src/net_processing.cpp`

---

## Структура каталога данных

### Каталог по умолчанию

**Расположение**: `.bitcoin/` (такое же, как у Bitcoin Core)
- Linux: `~/.bitcoin/`
- macOS: `~/Library/Application Support/Bitcoin/`
- Windows: `%APPDATA%\Bitcoin\`

### Содержимое каталога

```
.bitcoin/
├── blocks/              # Данные блоков
│   ├── blk*.dat        # Файлы блоков
│   ├── rev*.dat        # Данные отмены
│   └── index/          # Индекс блоков (LevelDB)
├── chainstate/         # Набор UTXO + делегирования форджинга (LevelDB)
├── wallets/            # Файлы кошелька
│   └── wallet.dat      # Кошелёк по умолчанию
├── bitcoin.conf        # Файл конфигурации
├── debug.log           # Отладочный лог
├── peers.dat           # Адреса пиров
├── mempool.dat         # Сохранение мемпула
└── banlist.dat         # Заблокированные пиры
```

### Ключевые отличия от Bitcoin

**База данных Chainstate**:
- Стандартно: Набор UTXO
- **Дополнение PoCX**: Состояние делегирования форджинга
- Атомарные обновления: UTXO + делегирования обновляются вместе
- Данные отмены, безопасные при реорганизациях, для делегирований

**Файлы блоков**:
- Стандартный формат блоков Bitcoin
- **Дополнение PoCX**: Расширены полями доказательства PoCX (account_id, seed, nonce, signature, pubkey)

### Пример файла конфигурации

**bitcoin.conf**:
```ini
# Выбор сети
#testnet=1
#regtest=1

# Сервер майнинга PoCX (требуется для внешних майнеров)
miningserver=1

# Настройки RPC
server=1
rpcuser=yourusername
rpcpassword=yourpassword
rpcallowip=127.0.0.1
rpcport=8332

# Настройки подключения
listen=1
port=8888
maxconnections=125

# Целевое время блока (информационное, обеспечивается консенсусом)
# 120 секунд для mainnet/testnet
```

---

## Ссылки на код

**Chainparams**: `src/kernel/chainparams.cpp`
**Параметры консенсуса**: `src/consensus/params.h`
**Границы сжатия**: `src/pocx/algorithms/algorithms.h`, `src/pocx/consensus/params.cpp`
**Вычисление базовой цели генезиса**: `src/pocx/consensus/params.cpp`
**Логика платежа Coinbase**: `src/pocx/mining/scheduler.cpp:ForgeBlock()`
**Хранение состояния делегирования**: `src/coins.h`, `src/coins.cpp` (расширения CCoinsViewCache)

---

## Перекрёстные ссылки

Связанные главы:
- [Глава 2: Формат графиков](2-plot-format.md) — Уровни масштабирования при генерации графиков
- [Глава 3: Консенсус и майнинг](3-consensus-and-mining.md) — Валидация масштабирования, система делегирования
- [Глава 4: Делегирование форджинга](4-forging-assignments.md) — Параметры задержки делегирования
- [Глава 5: Безопасность синхронизации времени](5-timing-security.md) — Обоснование MAX_FUTURE_BLOCK_TIME

---

[<- Назад: Синхронизация времени](5-timing-security.md) | [Содержание](index.md) | [Далее: Справочник по RPC ->](7-rpc-reference.md)
