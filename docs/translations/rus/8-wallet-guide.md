[<- Назад: Справочник по RPC](7-rpc-reference.md) | [Содержание](index.md)

---

# Глава 8: Руководство по кошельку и графическому интерфейсу

Полное руководство по Qt-кошельку Bitcoin-PoCX и управлению делегированием форджинга.

---

## Содержание

1. [Обзор](#обзор)
2. [Единицы валюты](#единицы-валюты)
3. [Диалог делегирования форджинга](#диалог-делегирования-форджинга)
4. [История транзакций](#история-транзакций)
5. [Требования к адресам](#требования-к-адресам)
6. [Интеграция майнинга](#интеграция-майнинга)
7. [Устранение неполадок](#устранение-неполадок)
8. [Лучшие практики безопасности](#лучшие-практики-безопасности)

---

## Обзор

### Функции кошелька Bitcoin-PoCX

Qt-кошелёк Bitcoin-PoCX (`bitcoin-qt`) предоставляет:
- Стандартную функциональность кошелька Bitcoin Core (отправка, получение, управление транзакциями)
- **Менеджер делегирования форджинга**: GUI для создания/отзыва делегирования графиков
- **Режим сервера майнинга**: Флаг `-miningserver` включает функции, связанные с майнингом
- **История транзакций**: Отображение транзакций делегирования и отзыва

### Запуск кошелька

**Только узел** (без майнинга):
```bash
./build/bin/bitcoin-qt
```

**С майнингом** (включает диалог делегирования):
```bash
./build/bin/bitcoin-qt -server -miningserver
```

**Альтернатива командной строки**:
```bash
./build/bin/bitcoind -miningserver
```

### Требования для майнинга

**Для операций майнинга**:
- Требуется флаг `-miningserver`
- Кошелёк с P2WPKH-адресами и приватными ключами
- Внешний плоттер (`pocx_plotter`) для генерации графиков
- Внешний майнер (`pocx_miner`) для майнинга

**Для пул-майнинга**:
- Создать делегирование форджинга на адрес пула
- Кошелёк не требуется на сервере пула (пул управляет ключами)

---

## Единицы валюты

### Отображение единиц

Bitcoin-PoCX использует единицу валюты **BTCX** (не BTC):

| Единица | Сатоши | Отображение |
|---------|--------|-------------|
| **BTCX** | 100000000 | 1.00000000 BTCX |
| **mBTCX** | 100000 | 1000.00 mBTCX |
| **µBTCX** | 100 | 1000000.00 µBTCX |
| **satoshi** | 1 | 100000000 sat |

**Настройки GUI**: Настройки -> Отображение -> Единица

---

## Диалог делегирования форджинга

### Доступ к диалогу

**Меню**: `Кошелёк -> Делегирование форджинга`
**Панель инструментов**: Иконка майнинга (видна только с флагом `-miningserver`)
**Размер окна**: 600x450 пикселей

### Режимы диалога

#### Режим 1: Создание делегирования

**Цель**: Делегирование прав форджинга пулу или другому адресу с сохранением владения графиком.

**Варианты использования**:
- Пул-майнинг (делегирование адресу пула)
- Холодное хранение (ключ майнинга отделён от владения графиком)
- Общая инфраструктура (делегирование горячему кошельку)

**Требования**:
- Адрес графика (P2WPKH bech32, должен владеть приватным ключом)
- Адрес форджинга (P2WPKH bech32, отличный от адреса графика)
- Кошелёк разблокирован (если зашифрован)
- Адрес графика имеет подтверждённые UTXO

**Шаги**:
1. Выберите режим «Создать делегирование»
2. Выберите адрес графика из выпадающего списка или введите вручную
3. Введите адрес форджинга (пула или делегата)
4. Нажмите «Отправить делегирование» (кнопка активна когда входные данные валидны)
5. Транзакция транслируется немедленно
6. Делегирование активируется после `nForgingAssignmentDelay` блоков:
   - Mainnet/Testnet: 30 блоков (~1 час)
   - Regtest: 4 блока (~4 секунды)

**Комиссия транзакции**: По умолчанию 10x `minRelayFee` (настраивается)

**Структура транзакции**:
- Вход: UTXO от адреса графика (подтверждает владение)
- Выход OP_RETURN: маркер `POCX` + plot_address + forging_address (46 байт)
- Выход сдачи: Возвращается в кошелёк

#### Режим 2: Отзыв делегирования

**Цель**: Отмена делегирования форджинга и возврат прав владельцу графика.

**Требования**:
- Адрес графика (должен владеть приватным ключом)
- Кошелёк разблокирован (если зашифрован)
- Адрес графика имеет подтверждённые UTXO

**Шаги**:
1. Выберите режим «Отозвать делегирование»
2. Выберите адрес графика
3. Нажмите «Отправить отзыв»
4. Транзакция транслируется немедленно
5. Отзыв вступает в силу после `nForgingRevocationDelay` блоков:
   - Mainnet/Testnet: 720 блоков (~24 часа)
   - Regtest: 8 блоков (~8 секунд)

**Эффект**:
- Адрес форджинга всё ещё может форджить в период задержки
- Владелец графика восстанавливает права после завершения отзыва
- Можно создать новое делегирование после

**Структура транзакции**:
- Вход: UTXO от адреса графика (подтверждает владение)
- Выход OP_RETURN: маркер `XCOP` + plot_address (26 байт)
- Выход сдачи: Возвращается в кошелёк

#### Режим 3: Проверка статуса делегирования

**Цель**: Запрос текущего состояния делегирования для любого адреса графика.

**Требования**: Нет (только чтение, кошелёк не нужен)

**Шаги**:
1. Выберите режим «Проверить статус делегирования»
2. Введите адрес графика
3. Нажмите «Проверить статус»
4. Поле статуса отображает текущее состояние с деталями

**Индикаторы состояния** (цветовая кодировка):

**Серый - UNASSIGNED (НЕ ДЕЛЕГИРОВАНО)**
```
UNASSIGNED - Делегирование не существует
```

**Оранжевый - ASSIGNING (ДЕЛЕГИРОВАНИЕ)**
```
ASSIGNING - Делегирование ожидает активации
Адрес форджинга: pocx1qforger...
Создано на высоте: 12000
Активируется на высоте: 12030 (осталось 5 блоков)
```

**Зелёный - ASSIGNED (ДЕЛЕГИРОВАНО)**
```
ASSIGNED - Активное делегирование
Адрес форджинга: pocx1qforger...
Создано на высоте: 12000
Активировано на высоте: 12030
```

**Красно-оранжевый - REVOKING (ОТЗЫВ)**
```
REVOKING - Отзыв в ожидании
Адрес форджинга: pocx1qforger... (всё ещё активен)
Делегирование создано на высоте: 12000
Отозвано на высоте: 12300
Отзыв вступит в силу на высоте: 13020 (осталось 50 блоков)
```

**Красный - REVOKED (ОТОЗВАНО)**
```
REVOKED - Делегирование отозвано
Ранее делегировано: pocx1qforger...
Делегирование создано на высоте: 12000
Отозвано на высоте: 12300
Отзыв вступил в силу на высоте: 13020
```

---

## История транзакций

### Отображение транзакции делегирования

**Тип**: «Assignment» (Делегирование)
**Иконка**: Иконка майнинга (такая же, как у добытых блоков)

**Столбец адреса**: Адрес графика (адрес, чьи права форджинга делегируются)
**Столбец суммы**: Комиссия транзакции (отрицательная, исходящая транзакция)
**Столбец статуса**: Количество подтверждений (0-6+)

**Детали** (при нажатии):
- ID транзакции
- Адрес графика
- Адрес форджинга (извлечён из OP_RETURN)
- Создано на высоте
- Высота активации
- Комиссия транзакции
- Временная метка

### Отображение транзакции отзыва

**Тип**: «Revocation» (Отзыв)
**Иконка**: Иконка майнинга

**Столбец адреса**: Адрес графика
**Столбец суммы**: Комиссия транзакции (отрицательная)
**Столбец статуса**: Количество подтверждений

**Детали** (при нажатии):
- ID транзакции
- Адрес графика
- Отозвано на высоте
- Высота вступления отзыва в силу
- Комиссия транзакции
- Временная метка

### Фильтрация транзакций

**Доступные фильтры**:
- «Все» (по умолчанию, включает делегирования/отзывы)
- Диапазон дат
- Диапазон сумм
- Поиск по адресу
- Поиск по ID транзакции
- Поиск по метке (если адрес помечен)

**Примечание**: Транзакции делегирования/отзыва в настоящее время отображаются под фильтром «Все». Выделенный фильтр по типу ещё не реализован.

### Сортировка транзакций

**Порядок сортировки** (по типу):
- Generated (сгенерировано) (тип 0)
- Received (получено) (тип 1-3)
- Assignment (делегирование) (тип 4)
- Revocation (отзыв) (тип 5)
- Sent (отправлено) (тип 6+)

---

## Требования к адресам

### Только P2WPKH (SegWit v0)

**Операции форджинга требуют**:
- Адреса в кодировке Bech32 (начинаются с «pocx1q» mainnet, «tpocx1q» testnet, «rpocx1q» regtest)
- Формат P2WPKH (Pay-to-Witness-Public-Key-Hash)
- 20-байтный хеш ключа

**НЕ поддерживается**:
- P2PKH (устаревший, начинается с «1»)
- P2SH (обёрнутый SegWit, начинается с «3»)
- P2TR (Taproot, начинается с «bc1p»)

**Обоснование**: Подписи блоков PoCX требуют специфичного формата witness v0 для валидации доказательства.

### Фильтрация выпадающего списка адресов

**ComboBox адреса графика**:
- Автоматически заполняется адресами получения кошелька
- Отфильтровывает не-P2WPKH адреса
- Показывает формат: «Метка (адрес)» если помечен, иначе просто адрес
- Первый элемент: «-- Ввести адрес вручную --» для ручного ввода

**Ручной ввод**:
- Проверяет формат при вводе
- Должен быть валидный bech32 P2WPKH
- Кнопка неактивна при неверном формате

### Сообщения об ошибках валидации

**Ошибки диалога**:
- «Адрес графика должен быть P2WPKH (bech32)»
- «Адрес форджинга должен быть P2WPKH (bech32)»
- «Неверный формат адреса»
- «Нет монет по адресу графика. Невозможно подтвердить владение.»
- «Невозможно создавать транзакции с кошельком только для просмотра»
- «Кошелёк недоступен»
- «Кошелёк заблокирован» (от RPC)

---

## Интеграция майнинга

### Требования к настройке

**Конфигурация узла**:
```bash
# bitcoin.conf
miningserver=1
server=1
```

**Требования к кошельку**:
- P2WPKH-адреса для владения графиком
- Приватные ключи для майнинга (или адреса форджинга если используется делегирование)
- Подтверждённые UTXO для создания транзакций

**Внешние инструменты**:
- `pocx_plotter`: Генерация файлов графиков
- `pocx_miner`: Сканирование графиков и отправка нонсов

### Рабочий процесс

#### Соло-майнинг

1. **Генерация файлов графиков**:
   ```bash
   pocx_plotter --account <plot_address_hash160> --seed <32_bytes> --nonces <count>
   ```

2. **Запуск узла** с сервером майнинга:
   ```bash
   bitcoin-qt -server -miningserver
   ```

3. **Настройка майнера**:
   - Указать на RPC-эндпоинт узла
   - Указать каталоги файлов графиков
   - Настроить ID аккаунта (из адреса графика)

4. **Запуск майнинга**:
   ```bash
   pocx_miner --rpc-url http://localhost:8332 --plots /path/to/plots
   ```

5. **Мониторинг**:
   - Майнер вызывает `get_mining_info` каждый блок
   - Сканирует графики на лучший дедлайн
   - Вызывает `submit_nonce` когда решение найдено
   - Узел валидирует и автоматически форджит блок

#### Пул-майнинг

1. **Генерация файлов графиков** (как при соло-майнинге)

2. **Создание делегирования форджинга**:
   - Откройте диалог делегирования форджинга
   - Выберите адрес графика
   - Введите адрес форджинга пула
   - Нажмите «Отправить делегирование»
   - Дождитесь задержки активации (30 блоков testnet)

3. **Настройка майнера**:
   - Указать на эндпоинт **пула** (не локального узла)
   - Пул обрабатывает `submit_nonce` в цепочку

4. **Работа пула**:
   - Кошелёк пула имеет приватные ключи адреса форджинга
   - Пул валидирует отправки от майнеров
   - Пул вызывает `submit_nonce` в блокчейн
   - Пул распределяет награды по политике пула

### Награды Coinbase

**Без делегирования**:
- Coinbase платит напрямую адресу владельца графика
- Проверяйте баланс на адресе графика

**С делегированием**:
- Coinbase платит адресу форджинга
- Пул получает награды
- Майнер получает долю от пула

**График наград**:
- Начальная: 10 BTCX за блок
- Халвинг: Каждые 1050000 блоков (~4 года)
- График: 10 -> 5 -> 2.5 -> 1.25 -> ...

---

## Устранение неполадок

### Типичные проблемы

#### «Кошелёк не имеет приватного ключа для адреса графика»

**Причина**: Кошелёк не владеет адресом
**Решение**:
- Импортировать приватный ключ через RPC `importprivkey`
- Или использовать другой адрес графика, принадлежащий кошельку

#### «Делегирование уже существует для этого графика»

**Причина**: Графику уже делегирован другому адресу
**Решение**:
1. Отозвать существующее делегирование
2. Дождаться задержки отзыва (720 блоков testnet)
3. Создать новое делегирование

#### «Формат адреса не поддерживается»

**Причина**: Адрес не P2WPKH bech32
**Решение**:
- Использовать адреса, начинающиеся с «pocx1q» (mainnet) или «tpocx1q» (testnet)
- Сгенерировать новый адрес если нужно: `getnewaddress "" "bech32"`

#### «Комиссия транзакции слишком низкая»

**Причина**: Перегрузка мемпула сети или слишком низкая комиссия для ретрансляции
**Решение**:
- Увеличить параметр ставки комиссии
- Дождаться очистки мемпула

#### «Делегирование ещё не активно»

**Причина**: Задержка активации ещё не истекла
**Решение**:
- Проверить статус: сколько блоков осталось до активации
- Дождаться завершения периода задержки

#### «Нет монет по адресу графика»

**Причина**: Адрес графика не имеет подтверждённых UTXO
**Решение**:
1. Отправить средства на адрес графика
2. Дождаться 1 подтверждения
3. Повторить создание делегирования

#### «Невозможно создавать транзакции с кошельком только для просмотра»

**Причина**: Кошелёк импортировал адрес без приватного ключа
**Решение**: Импортировать полный приватный ключ, а не только адрес

#### «Вкладка делегирования форджинга не видна»

**Причина**: Узел запущен без флага `-miningserver`
**Решение**: Перезапустить с `bitcoin-qt -server -miningserver`

### Шаги отладки

1. **Проверка статуса кошелька**:
   ```bash
   bitcoin-cli getwalletinfo
   ```

2. **Проверка владения адресом**:
   ```bash
   bitcoin-cli getaddressinfo pocx1qplot...
   # Проверьте: "iswatchonly": false, "ismine": true
   ```

3. **Проверка статуса делегирования**:
   ```bash
   bitcoin-cli get_assignment pocx1qplot...
   ```

4. **Просмотр недавних транзакций**:
   ```bash
   bitcoin-cli listtransactions "*" 10
   ```

5. **Проверка синхронизации узла**:
   ```bash
   bitcoin-cli getblockchaininfo
   # Проверьте: blocks == headers (полностью синхронизирован)
   ```

---

## Лучшие практики безопасности

### Безопасность адреса графика

**Управление ключами**:
- Храните приватные ключи адреса графика безопасно
- Транзакции делегирования подтверждают владение через подпись
- Только владелец графика может создавать/отзывать делегирования

**Резервное копирование**:
- Регулярно делайте резервные копии кошелька (`dumpwallet` или `backupwallet`)
- Храните wallet.dat в безопасном месте
- Записывайте фразы восстановления если используете HD-кошелёк

### Делегирование адреса форджинга

**Модель безопасности**:
- Адрес форджинга получает награды за блок
- Адрес форджинга может подписывать блоки (майнинг)
- Адрес форджинга **не может** изменять или отзывать делегирование
- Владелец графика сохраняет полный контроль

**Варианты использования**:
- **Делегирование горячему кошельку**: Ключ графика в холодном хранилище, ключ форджинга в горячем кошельке для майнинга
- **Пул-майнинг**: Делегирование пулу, сохранение владения графиком
- **Общая инфраструктура**: Несколько майнеров, один адрес форджинга

### Синхронизация сетевого времени

**Важность**:
- Консенсус PoCX требует точного времени
- Отклонение часов >10с вызывает предупреждение
- Отклонение часов >15с предотвращает майнинг

**Решение**:
- Держите системные часы синхронизированными с NTP
- Мониторьте: `bitcoin-cli getnetworkinfo` для предупреждений о временном смещении
- Используйте надёжные серверы NTP

### Задержки делегирования

**Задержка активации** (30 блоков testnet):
- Предотвращает быстрое переназначение при форках цепочки
- Позволяет сети достичь консенсуса
- Не может быть обойдена

**Задержка отзыва** (720 блоков testnet):
- Обеспечивает стабильность для пулов майнинга
- Предотвращает атаки «гриферства» делегирования
- Адрес форджинга остаётся активным в период задержки

### Шифрование кошелька

**Включение шифрования**:
```bash
bitcoin-cli encryptwallet "your_passphrase"
```

**Разблокировка для транзакций**:
```bash
bitcoin-cli walletpassphrase "your_passphrase" 300
```

**Лучшие практики**:
- Используйте надёжную парольную фразу (20+ символов)
- Не храните парольную фразу в открытом виде
- Блокируйте кошелёк после создания делегирований

---

## Ссылки на код

**Диалог делегирования форджинга**: `src/qt/forgingassignmentdialog.cpp`, `src/qt/forgingassignmentdialog.h`
**Отображение транзакций**: `src/qt/transactionrecord.cpp`, `src/qt/transactiontablemodel.cpp`
**Разбор транзакций**: `src/qt/transactionrecord.cpp`
**Интеграция кошелька**: `src/pocx/assignments/transactions.cpp`
**RPC делегирования**: `src/pocx/rpc/assignments_wallet.cpp`
**Главное GUI**: `src/qt/bitcoingui.cpp`

---

## Перекрёстные ссылки

Связанные главы:
- [Глава 3: Консенсус и майнинг](3-consensus-and-mining.md) — Процесс майнинга
- [Глава 4: Делегирование форджинга](4-forging-assignments.md) — Архитектура делегирования
- [Глава 6: Сетевые параметры](6-network-parameters.md) — Значения задержки делегирования
- [Глава 7: Справочник по RPC](7-rpc-reference.md) — Детали RPC-команд

---

[<- Назад: Справочник по RPC](7-rpc-reference.md) | [Содержание](index.md)
