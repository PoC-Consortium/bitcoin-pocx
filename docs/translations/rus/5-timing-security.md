[<- Назад: Делегирование форджинга](4-forging-assignments.md) | [Содержание](index.md) | [Далее: Сетевые параметры ->](6-network-parameters.md)

---

# Глава 5: Синхронизация времени и безопасность

## Обзор

Консенсус PoCX требует точной синхронизации времени по всей сети. В этой главе документированы механизмы безопасности, связанные со временем, допуск отклонения часов и поведение защитного форджинга.

**Ключевые механизмы**:
- 15-секундный допуск на будущее для временных меток блоков
- Система предупреждений об отклонении часов на 10 секунд
- Защитный форджинг (противодействие манипуляции часами)
- Интеграция алгоритма искривления времени

---

## Содержание

1. [Требования к синхронизации времени](#требования-к-синхронизации-времени)
2. [Обнаружение отклонения часов и предупреждения](#обнаружение-отклонения-часов-и-предупреждения)
3. [Механизм защитного форджинга](#механизм-защитного-форджинга)
4. [Анализ угроз безопасности](#анализ-угроз-безопасности)
5. [Лучшие практики для операторов узлов](#лучшие-практики-для-операторов-узлов)

---

## Требования к синхронизации времени

### Константы и параметры

**Конфигурация Bitcoin-PoCX:**
```cpp
// src/chain.h:31
static constexpr int64_t MAX_FUTURE_BLOCK_TIME = 15;  // 15 секунд

// src/node/timeoffsets.h:27
static constexpr std::chrono::seconds WARN_THRESHOLD{10};  // 10 секунд
```

### Проверки валидации

**Валидация временной метки блока** (`src/validation.cpp:4547-4561`):
```cpp
// 1. Монотонная проверка: временная метка >= временная метка предыдущего блока
if (block.nTime < pindexPrev->nTime) {
    return state.Invalid("time-too-old");
}

// 2. Проверка на будущее: временная метка <= сейчас + 15 секунд
if (block.Time() > NodeClock::now() + std::chrono::seconds{MAX_FUTURE_BLOCK_TIME}) {
    return state.Invalid("time-too-new");
}

// 3. Проверка дедлайна: прошедшее время >= дедлайн
uint32_t elapsed_time = block.nTime - pindexPrev->nTime;
if (result.deadline > elapsed_time) {
    return state.Invalid("bad-pocx-timing");
}
```

### Таблица влияния отклонения часов

| Смещение часов | Может синхронизироваться? | Может майнить? | Статус валидации | Конкурентный эффект |
|----------------|---------------------------|----------------|------------------|---------------------|
| -30с отстаёт | НЕТ - Проверка на будущее не проходит | Н/П | **МЁРТВЫЙ УЗЕЛ** | Не может участвовать |
| -14с отстаёт | Да | Да | Поздний форджинг, проходит валидацию | Проигрывает гонки |
| 0с точно | Да | Да | Оптимально | Оптимально |
| +14с спешит | Да | Да | Ранний форджинг, проходит валидацию | Выигрывает гонки |
| +16с спешит | Да | НЕТ - Проверка на будущее не проходит | Не может распространять блоки | Может синхронизироваться, не может майнить |

**Ключевой вывод**: 15-секундное окно симметрично для участия (+/-14.9с), но быстрые часы дают несправедливое конкурентное преимущество в пределах допуска.

### Интеграция искривления времени

Алгоритм искривления времени (подробно в [Глава 3](3-consensus-and-mining.md#вычисление-искривления-времени)) преобразует сырые дедлайны с использованием кубического корня:

```
time_bended_deadline = scale * (deadline_seconds)^(1/3)
```

**Взаимодействие с отклонением часов**:
- Лучшие решения форджатся раньше (кубический корень усиливает различия качества)
- Отклонение часов влияет на время форджинга относительно сети
- Защитный форджинг обеспечивает конкуренцию на основе качества несмотря на временную дисперсию

---

## Обнаружение отклонения часов и предупреждения

### Система предупреждений

Bitcoin-PoCX отслеживает временное смещение между локальным узлом и сетевыми пирами.

**Сообщение предупреждения** (когда отклонение превышает 10 секунд):
> «Дата и время вашего компьютера, похоже, отклоняются более чем на 10 секунд от сети, это может привести к сбою консенсуса PoCX. Пожалуйста, проверьте системные часы.»

**Реализация**: `src/node/timeoffsets.cpp`

### Обоснование дизайна

**Почему 10 секунд?**
- Обеспечивает 5-секундный запас безопасности до 15-секундного предела допуска
- Строже, чем стандартное значение Bitcoin Core (10 минут)
- Подходит для требований к синхронизации времени PoC

**Превентивный подход**:
- Раннее предупреждение до критического сбоя
- Позволяет операторам исправить проблемы проактивно
- Уменьшает фрагментацию сети из-за проблем со временем

---

## Механизм защитного форджинга

### Что это такое

Защитный форджинг — это стандартное поведение майнера в Bitcoin-PoCX, которое устраняет преимущества на основе времени в производстве блоков. Когда ваш майнер получает конкурирующий блок на той же высоте, он автоматически проверяет, есть ли у вас лучшее решение. Если да — немедленно форджит ваш блок, обеспечивая конкуренцию на основе качества, а не на основе манипуляции часами.

### Проблема

Консенсус PoCX допускает блоки с временными метками до 15 секунд в будущем. Этот допуск необходим для глобальной синхронизации сети. Однако он создаёт возможность для манипуляции часами:

**Без защитного форджинга:**
- Майнер A: Правильное время, качество 800 (лучше), ждёт правильный дедлайн
- Майнер B: Быстрые часы (+14с), качество 1000 (хуже), форджит на 14 секунд раньше
- Результат: Майнер B выигрывает гонку несмотря на худшую работу proof-of-capacity

**Проблема:** Манипуляция часами даёт преимущество даже с худшим качеством, подрывая принцип proof-of-capacity.

### Решение: Двухуровневая защита

#### Уровень 1: Предупреждение об отклонении часов (превентивный)

Bitcoin-PoCX отслеживает временное смещение между вашим узлом и сетевыми пирами. Если ваши часы отклоняются более чем на 10 секунд от консенсуса сети, вы получаете предупреждение, оповещающее вас исправить проблемы с часами до того, как они вызовут проблемы.

#### Уровень 2: Защитный форджинг (реактивный)

Когда другой майнер публикует блок на той же высоте, которую вы майните:

1. **Обнаружение**: Ваш узел идентифицирует конкуренцию на той же высоте
2. **Валидация**: Извлекает и валидирует качество конкурирующего блока
3. **Сравнение**: Проверяет, лучше ли ваше качество
4. **Реакция**: Если лучше — немедленно форджит ваш блок

**Результат:** Сеть получает оба блока и выбирает блок с лучшим качеством через стандартное разрешение форков.

### Как это работает

#### Сценарий: Конкуренция на одной высоте

```
Время 150с: Майнер B (часы +10с) форджит с качеством 1000
           -> Временная метка блока показывает 160с (10с в будущем)

Время 150с: Ваш узел получает блок Майнера B
           -> Обнаруживает: та же высота, качество 1000
           -> У вас: качество 800 (лучше!)
           -> Действие: Форджить немедленно с правильной временной меткой (150с)

Время 152с: Сеть валидирует оба блока
           -> Оба валидны (в пределах 15с допуска)
           -> Качество 800 побеждает (меньше = лучше)
           -> Ваш блок становится вершиной цепочки
```

#### Сценарий: Настоящий реорг

```
Ваша высота майнинга 100, конкурент публикует блок 99
-> Не конкуренция на той же высоте
-> Защитный форджинг НЕ срабатывает
-> Стандартная обработка реорга продолжается
```

### Преимущества

**Нулевой стимул для манипуляции часами**
- Быстрые часы помогают только если у вас уже лучшее качество
- Манипуляция часами становится экономически бессмысленной

**Обеспечена конкуренция на основе качества**
- Заставляет майнеров конкурировать по фактической работе proof-of-capacity
- Сохраняет целостность консенсуса PoCX

**Безопасность сети**
- Устойчива к стратегиям игры на времени
- Не требуются изменения консенсуса — чистое поведение майнера

**Полностью автоматический**
- Не требуется конфигурация
- Срабатывает только когда необходимо
- Стандартное поведение во всех узлах Bitcoin-PoCX

### Компромиссы

**Минимальное увеличение уровня осиротевших блоков**
- Намеренное — атакующие блоки осиротевают
- Происходит только во время фактических попыток манипуляции часами
- Естественный результат разрешения форков на основе качества

**Кратковременная конкуренция в сети**
- Сеть кратковременно видит два конкурирующих блока
- Разрешается за секунды через стандартную валидацию
- То же поведение, что при одновременном майнинге в Bitcoin

### Технические детали

**Влияние на производительность:** Незначительное
- Срабатывает только при конкуренции на той же высоте
- Использует данные в памяти (без дискового ввода-вывода)
- Валидация завершается за миллисекунды

**Использование ресурсов:** Минимальное
- ~20 строк основной логики
- Переиспользует существующую инфраструктуру валидации
- Единственный захват блокировки

**Совместимость:** Полная
- Без изменений правил консенсуса
- Работает со всеми функциями Bitcoin Core
- Опциональный мониторинг через отладочные логи

**Статус**: Активно во всех релизах Bitcoin-PoCX
**Впервые введено**: 2025-10-10

---

## Анализ угроз безопасности

### Атака быстрых часов (смягчена защитным форджингом)

**Вектор атаки**:
Майнер с часами **+14с вперёд** может:
1. Получать блоки нормально (кажутся ему старыми)
2. Форджить блоки немедленно когда дедлайн проходит
3. Транслировать блоки, которые кажутся на 14с «раньше» для сети
4. **Блоки принимаются** (в пределах 15с допуска)
5. **Выигрывает гонки** против честных майнеров

**Влияние без защитного форджинга**:
Преимущество ограничено 14.9 секундами (недостаточно для пропуска значительной работы PoC), но обеспечивает постоянное преимущество в гонках блоков.

**Смягчение (защитный форджинг)**:
- Честные майнеры обнаруживают конкуренцию на той же высоте
- Сравнивают значения качества
- Немедленно форджат если качество лучше
- **Результат**: Быстрые часы помогают только если у вас уже лучшее качество
- **Стимул**: Нулевой — манипуляция часами становится экономически бессмысленной

### Сбой медленных часов (критический)

**Режим сбоя**:
Узел **>15с позади** — это катастрофа:
- Не может валидировать входящие блоки (проверка на будущее не проходит)
- Становится изолированным от сети
- Не может майнить или синхронизироваться

**Смягчение**:
- Строгое предупреждение при 10с отклонении даёт 5-секундный буфер до критического сбоя
- Операторы могут исправить проблемы с часами проактивно
- Понятные сообщения об ошибках направляют устранение неполадок

---

## Лучшие практики для операторов узлов

### Настройка синхронизации времени

**Рекомендуемая конфигурация**:
1. **Включите NTP**: Используйте Network Time Protocol для автоматической синхронизации
   ```bash
   # Linux (systemd-timesyncd)
   sudo timedatectl set-ntp true

   # Проверка статуса
   timedatectl status
   ```

2. **Проверьте точность часов**: Регулярно проверяйте временное смещение
   ```bash
   # Проверка статуса синхронизации NTP
   ntpq -p

   # Или с chrony
   chronyc tracking
   ```

3. **Мониторьте предупреждения**: Следите за предупреждениями Bitcoin-PoCX об отклонении часов в логах

### Для майнеров

**Никаких действий не требуется**:
- Функция всегда активна
- Работает автоматически
- Просто держите системные часы точными

**Лучшие практики**:
- Используйте синхронизацию времени NTP
- Мониторьте предупреждения об отклонении часов
- Устраняйте предупреждения оперативно если они появляются

**Ожидаемое поведение**:
- Соло-майнинг: Защитный форджинг срабатывает редко (нет конкуренции)
- Сетевой майнинг: Защищает от попыток манипуляции часами
- Прозрачная работа: Большинство майнеров её не замечают

### Устранение неполадок

**Предупреждение: «10 секунд рассинхронизации»**
- Действие: Проверьте и исправьте синхронизацию системных часов
- Влияние: 5-секундный буфер до критического сбоя
- Инструменты: NTP, chrony, systemd-timesyncd

**Ошибка: «time-too-new» на входящих блоках**
- Причина: Ваши часы отстают >15 секунд
- Влияние: Не может валидировать блоки, узел изолирован
- Исправление: Немедленно синхронизируйте системные часы

**Ошибка: Не может распространять сформированные блоки**
- Причина: Ваши часы спешат >15 секунд
- Влияние: Блоки отклоняются сетью
- Исправление: Немедленно синхронизируйте системные часы

---

## Проектные решения и обоснование

### Почему 15-секундный допуск?

**Обоснование**:
- Переменное время дедлайна Bitcoin-PoCX менее критично ко времени, чем консенсус с фиксированным временем
- 15с обеспечивает адекватную защиту, предотвращая фрагментацию сети

**Компромиссы**:
- Более строгий допуск = больше фрагментации сети от незначительного отклонения
- Более свободный допуск = больше возможностей для атак на время
- 15с балансирует безопасность и устойчивость

### Почему 10-секундное предупреждение?

**Обоснование**:
- Обеспечивает 5-секундный запас безопасности
- Более подходит для PoC, чем 10-минутное значение по умолчанию Bitcoin
- Позволяет проактивные исправления до критического сбоя

### Почему защитный форджинг?

**Решаемая проблема**:
- 15-секундный допуск позволяет преимущество быстрых часов
- Консенсус на основе качества мог быть подорван манипуляцией временем

**Преимущества решения**:
- Защита с нулевой стоимостью (без изменений консенсуса)
- Автоматическая работа
- Устраняет стимул для атаки
- Сохраняет принципы proof-of-capacity

### Почему нет внутрисетевой синхронизации времени?

**Обоснование безопасности**:
- Современный Bitcoin Core удалил корректировку времени на основе пиров
- Уязвима для Sybil-атак на воспринимаемое сетевое время
- PoCX намеренно избегает полагаться на внутренние источники времени сети
- Системные часы более надёжны, чем консенсус пиров
- Операторы должны синхронизироваться с использованием NTP или эквивалентного внешнего источника времени
- Узлы мониторят собственное отклонение и выдают предупреждения если локальные часы расходятся с недавними временными метками блоков

---

## Ссылки на реализацию

**Основные файлы**:
- Валидация времени: `src/validation.cpp:4547-4561`
- Константа допуска на будущее: `src/chain.h:31`
- Порог предупреждения: `src/node/timeoffsets.h:27`
- Мониторинг временного смещения: `src/node/timeoffsets.cpp`
- Защитный форджинг: `src/pocx/mining/scheduler.cpp`

**Связанная документация**:
- Алгоритм искривления времени: [Глава 3: Консенсус и майнинг](3-consensus-and-mining.md#вычисление-искривления-времени)
- Валидация блоков: [Глава 3: Валидация блоков](3-consensus-and-mining.md#валидация-блоков)

---

**Создано**: 2025-10-10
**Статус**: Полная реализация
**Покрытие**: Требования к синхронизации времени, обработка отклонения часов, защитный форджинг

---

[<- Назад: Делегирование форджинга](4-forging-assignments.md) | [Содержание](index.md) | [Далее: Сетевые параметры ->](6-network-parameters.md)
