[<- Назад: Введение](1-introduction.md) | [Содержание](index.md) | [Далее: Консенсус и майнинг ->](3-consensus-and-mining.md)

---

# Глава 2: Спецификация формата графиков PoCX

В этом документе описывается формат графиков PoCX — улучшенная версия формата POC2 с повышенной безопасностью, оптимизациями SIMD и масштабируемым доказательством работы.

## Обзор формата

Файлы графиков PoCX содержат предварительно вычисленные значения хешей Shabal256, организованные для эффективных операций майнинга. Следуя традиции PoC с POC1, **все метаданные встроены в имя файла** — заголовка файла нет.

### Расширение файла
- **Стандартное**: `.pocx` (завершённые графики)
- **В процессе**: `.tmp` (во время построения графика, переименовывается в `.pocx` по завершении)

## Исторический контекст и эволюция уязвимостей

### Формат POC1 (устаревший)
**Две основные уязвимости (компромиссы время-память):**

1. **Дефект распределения PoW**
   - Неравномерное распределение доказательства работы по скупам
   - Скупы с низкими номерами можно было вычислять на лету
   - **Влияние**: Уменьшенные требования к хранилищу для злоумышленников

2. **Атака XOR-сжатия** (50% компромисс время-память)
   - Эксплуатация математических свойств для достижения 50% сокращения хранилища
   - **Влияние**: Злоумышленники могли майнить с половиной требуемого хранилища

**Оптимизация компоновки**: Базовая последовательная компоновка скупов для эффективности HDD

### Формат POC2 (Burstcoin)
- Исправлен дефект распределения PoW
- Уязвимость XOR-транспонирования осталась неисправленной
- **Компоновка**: Сохранена последовательная оптимизация скупов

### Формат PoCX (текущий)
- **Исправлено распределение PoW** (унаследовано от POC2)
- **Исправлена уязвимость XOR-транспонирования** (уникально для PoCX)
- **Улучшенная компоновка SIMD/GPU**, оптимизированная для параллельной обработки и объединения обращений к памяти
- **Масштабируемое доказательство работы** предотвращает компромиссы время-память по мере роста вычислительной мощности (PoW выполняется только при создании или обновлении файлов графиков)

## Кодирование XOR-транспонирования

### Проблема: 50% компромисс время-память

В форматах POC1/POC2 злоумышленники могли эксплуатировать математическую связь между скупами, храня только половину данных и вычисляя остальное на лету во время майнинга. Эта «атака XOR-сжатия» подрывала гарантию хранения.

### Решение: Укрепление XOR-транспонированием

PoCX выводит свой формат майнинга (X1), применяя кодирование XOR-транспонированием к парам базовых варпов (X0):

**Для построения скупа S нонса N в варпе X1:**
1. Взять скуп S нонса N из первого варпа X0 (прямая позиция)
2. Взять скуп N нонса S из второго варпа X0 (транспонированная позиция)
3. Применить XOR к двум 64-байтным значениям для получения скупа X1

Шаг транспонирования меняет местами индексы скупа и нонса. В терминах матрицы — где строки представляют скупы, а столбцы представляют нонсы — он объединяет элемент в позиции (S, N) в первом варпе с элементом в (N, S) во втором.

### Почему это устраняет атаку

XOR-транспонирование связывает каждый скуп с целой строкой и целым столбцом базовых данных X0. Восстановление одного скупа X1 требует доступа к данным, охватывающим все 4096 индексов скупов. Любая попытка вычислить недостающие данные потребует регенерации 4096 полных нонсов, а не одного нонса — устраняя асимметричную структуру затрат, эксплуатируемую атакой XOR.

В результате хранение полного варпа X1 становится единственной вычислительно жизнеспособной стратегией для майнеров.

## Структура метаданных имени файла

Все метаданные графика кодируются в имени файла с использованием этого точного формата:

```
{ACCOUNT_PAYLOAD}_{SEED}_{WARPS}_{SCALING}.pocx
```

### Компоненты имени файла

1. **ACCOUNT_PAYLOAD** (40 шестнадцатеричных символов)
   - Сырая 20-байтная полезная нагрузка аккаунта в виде шестнадцатеричного числа в верхнем регистре
   - Независимо от сети (без идентификатора сети или контрольной суммы)
   - Пример: `DEADBEEFCAFEBABE1337C0DEBADC0FFEE15DEAD`

2. **SEED** (64 шестнадцатеричных символа)
   - 32-байтное значение seed в виде шестнадцатеричного числа в нижнем регистре
   - **Новое в PoCX**: Случайный 32-байтный seed в имени файла заменяет последовательную нумерацию нонсов — предотвращает перекрытие графиков
   - Пример: `c0ffeebeefcafebabedeadbeef1337c0de42424242feedfacecafed00dabad1dea`

3. **WARPS** (десятичное число)
   - **НОВАЯ единица размера в PoCX**: Заменяет размерность на основе нонсов из POC1/POC2
   - **Дизайн, устойчивый к XOR-транспонированию**: Каждый варп = ровно 4096 нонсов (размер раздела, необходимый для устойчивого к XOR-транспонированию преобразования)
   - **Размер**: 1 варп = 1073741824 байт = 1 ГиБ (удобная единица)
   - Пример: `1024` (график 1 ТиБ = 1024 варпа)

4. **SCALING** (десятичное число с префиксом X)
   - Уровень масштабирования как `X{уровень}`
   - Более высокие значения = больше требуемого доказательства работы
   - Пример: `X4` (2^4 = 16× сложность POC2)

### Примеры имён файлов
```
DEADBEEFCAFEBABE1337C0DEBADC0FFEE15DEAD_c0ffeebeefcafebabedeadbeef1337c0de42424242feedfacecafed00dabad1dea_1024_X4.pocx
FEEDFACEDEADC0DE123456789ABCDEF012345678_b00b1e5feedc0debabeface5dea1deadc0de1337c0ffeebabeface5bad1dea5_2048_X1.pocx
```


## Компоновка файла и структура данных

### Иерархическая организация
```
Файл графика (БЕЗ ЗАГОЛОВКА)
├── Скуп 0
│   ├── Варп 0 (Все нонсы для этого скупа/варпа)
│   ├── Варп 1
│   └── ...
├── Скуп 1
│   ├── Варп 0
│   ├── Варп 1
│   └── ...
└── Скуп 4095
    ├── Варп 0
    └── ...
```

### Константы и размеры

| Константа       | Размер                  | Описание                                        |
| --------------- | ----------------------- | ----------------------------------------------- |
| **HASH\_SIZE**  | 32 Б                    | Выход одного хеша Shabal256                     |
| **SCOOP\_SIZE** | 64 Б (2 × HASH\_SIZE)   | Пара хешей, читаемая в раунде майнинга          |
| **NUM\_SCOOPS** | 4096 (2^12)             | Скупов на нонс; один выбирается за раунд        |
| **NONCE\_SIZE** | 262144 Б (256 КиБ)      | Все скупы нонса (наименьшая единица PoC1/PoC2)  |
| **WARP\_SIZE**  | 1073741824 Б (1 ГиБ)    | Наименьшая единица в PoCX                       |

### SIMD-оптимизированная компоновка файла графика

PoCX реализует SIMD-осведомлённый паттерн доступа к нонсам, который позволяет векторизованную обработку нескольких нонсов одновременно. Он основан на концепциях из [исследования оптимизации POC2×16](https://www.reddit.com/r/burstcoin/comments/a1qyoq/cip_announcement_poc2x16_a_new_optimized_plot/) для максимизации пропускной способности памяти и эффективности SIMD.

---

#### Традиционная последовательная компоновка

Последовательное хранение нонсов:

```
[Нонс 0: Данные скупа] [Нонс 1: Данные скупа] [Нонс 2: Данные скупа] ...
```

Неэффективность SIMD: Каждой линии SIMD нужно одно и то же слово из разных нонсов:

```
Слово 0 из Нонса 0 -> смещение 0
Слово 0 из Нонса 1 -> смещение 512
Слово 0 из Нонса 2 -> смещение 1024
...
```

Scatter-gather доступ снижает пропускную способность.

---

#### SIMD-оптимизированная компоновка PoCX

PoCX хранит **позиции слов по 16 нонсам** последовательно:

```
Линия кеша (64 байта):

Word0_N0 Word0_N1 Word0_N2 ... Word0_N15
Word1_N0 Word1_N1 Word1_N2 ... Word1_N15
...
```

**ASCII-диаграмма**

```
Традиционная компоновка:

Нонс0: [W0][W1][W2][W3]...
Нонс1: [W0][W1][W2][W3]...
Нонс2: [W0][W1][W2][W3]...

Компоновка PoCX:

Слово0: [N0][N1][N2][N3]...[N15]
Слово1: [N0][N1][N2][N3]...[N15]
Слово2: [N0][N1][N2][N3]...[N15]
```

---

#### Преимущества доступа к памяти

- Одна линия кеша обеспечивает все линии SIMD.
- Устраняет scatter-gather операции.
- Уменьшает промахи кеша.
- Полностью последовательный доступ к памяти для векторизованных вычислений.
- GPU также выигрывают от выравнивания по 16 нонсам, максимизируя эффективность кеша.

---

#### Масштабирование SIMD

| SIMD       | Ширина вектора* | Нонсов | Циклов обработки на линию кеша |
|------------|-----------------|--------|--------------------------------|
| SSE2/AVX   | 128-бит         | 4      | 4 цикла                        |
| AVX2       | 256-бит         | 8      | 2 цикла                        |
| AVX512     | 512-бит         | 16     | 1 цикл                         |

\* Для целочисленных операций

---



## Масштабирование доказательства работы

### Уровни масштабирования
- **X0**: Базовые нонсы без кодирования XOR-транспонированием (теоретический, не используется для майнинга)
- **X1**: Базовая линия XOR-транспонирования — первый укреплённый формат (1× работа)
- **X2**: 2× работа X1 (XOR по 2 варпам)
- **X3**: 4× работа X1 (XOR по 4 варпам)
- **...**
- **Xn**: 2^(n-1) × встроенной работы X1

### Преимущества
- **Регулируемая сложность PoW**: Увеличивает вычислительные требования для соответствия более быстрому оборудованию
- **Долговечность формата**: Обеспечивает гибкое масштабирование сложности майнинга со временем

### Обновление графиков / Обратная совместимость

Когда сеть увеличивает масштаб PoW (доказательства работы) на 1, существующие графики требуют обновления для поддержания того же эффективного размера графика. По сути, теперь вам нужно вдвое больше PoW в файлах графиков для достижения того же вклада в ваш аккаунт.

Хорошая новость в том, что PoW, который вы уже выполнили при создании файлов графиков, не теряется — вам просто нужно добавить дополнительный PoW к существующим файлам. Не нужно перестраивать графики заново.

В качестве альтернативы вы можете продолжать использовать текущие графики без обновления, но учтите, что теперь они будут вносить только 50% своего прежнего эффективного размера в ваш аккаунт. Ваше программное обеспечение для майнинга может масштабировать файл графика на лету.

## Сравнение с устаревшими форматами

| Функция | POC1 | POC2 | PoCX |
|---------|------|------|------|
| Распределение PoW | Дефектное | Исправлено | Исправлено |
| Устойчивость к XOR-транспонированию | Уязвим | Уязвим | Исправлено |
| Оптимизация SIMD | Нет | Нет | Продвинутая |
| Оптимизация GPU | Нет | Нет | Оптимизировано |
| Масштабируемое доказательство работы | Нет | Нет | Да |
| Поддержка Seed | Нет | Нет | Да |

Формат PoCX представляет собой современное состояние искусства в форматах графиков Proof of Capacity, устраняя все известные уязвимости и обеспечивая значительные улучшения производительности для современного оборудования.

## Ссылки и дополнительное чтение

- **Основы POC1/POC2**: [Обзор майнинга Burstcoin](https://www.burstcoin.community/burstcoin-mining/) — Всеобъемлющее руководство по традиционным форматам майнинга Proof of Capacity
- **Исследование POC2×16**: [Анонс CIP: POC2×16 — Новый оптимизированный формат графиков](https://www.reddit.com/r/burstcoin/comments/a1qyoq/cip_announcement_poc2x16_a_new_optimized_plot/) — Оригинальное исследование оптимизации SIMD, вдохновившее PoCX
- **Алгоритм хеширования Shabal**: [Проект Saphir: Shabal, заявка на конкурс криптографических хеш-алгоритмов NIST](https://www.cs.rit.edu/~ark/20090927/Round2Candidates/Shabal.pdf) — Техническая спецификация алгоритма Shabal256, используемого в майнинге PoC

---

[<- Назад: Введение](1-introduction.md) | [Содержание](index.md) | [Далее: Консенсус и майнинг ->](3-consensus-and-mining.md)
