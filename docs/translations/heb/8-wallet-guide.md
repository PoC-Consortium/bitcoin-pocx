[← הקודם: עיון ב-RPC](7-rpc-reference.md) | [📘 תוכן העניינים](index.md)

---

# פרק 8: מדריך ארנק וממשק גרפי

מדריך מלא לארנק Qt של Bitcoin-PoCX וניהול הקצאות כרייה.

---

## תוכן העניינים

1. [סקירה](#סקירה)
2. [יחידות מטבע](#יחידות-מטבע)
3. [דיאלוג הקצאות כרייה](#דיאלוג-הקצאות-כרייה)
4. [היסטוריית עסקאות](#היסטוריית-עסקאות)
5. [דרישות כתובות](#דרישות-כתובות)
6. [אינטגרציית כרייה](#אינטגרציית-כרייה)
7. [פתרון בעיות](#פתרון-בעיות)
8. [שיטות עבודה מומלצות לאבטחה](#שיטות-עבודה-מומלצות-לאבטחה)

---

## סקירה

### תכונות ארנק Bitcoin-PoCX

ארנק Qt של Bitcoin-PoCX (`bitcoin-qt`) מספק:
- פונקציונליות ארנק Bitcoin Core סטנדרטית (שליחה, קבלה, ניהול עסקאות)
- **מנהל הקצאות כרייה**: ממשק גרפי ליצירה/ביטול הקצאות plot
- **מצב שרת כרייה**: דגל `-miningserver` מאפשר תכונות הקשורות לכרייה
- **היסטוריית עסקאות**: תצוגת עסקאות הקצאה וביטול

### הפעלת הארנק

**צומת בלבד** (ללא כרייה):
```bash
./build/bin/bitcoin-qt
```

**עם כרייה** (מאפשר דיאלוג הקצאות):
```bash
./build/bin/bitcoin-qt -server -miningserver
```

**חלופת שורת פקודה**:
```bash
./build/bin/bitcoind -miningserver
```

### דרישות כרייה

**לפעולות כרייה**:
- דגל `-miningserver` נדרש
- ארנק עם כתובות P2WPKH ומפתחות פרטיים
- Plotter חיצוני (`pocx_plotter`) לייצור plot
- Miner חיצוני (`pocx_miner`) לכרייה

**לכריית בריכה**:
- יצירת הקצאת כרייה לכתובת בריכה
- ארנק לא נדרש בשרת בריכה (הבריכה מנהלת מפתחות)

---

## יחידות מטבע

### תצוגת יחידות

Bitcoin-PoCX משתמש ביחידת מטבע **BTCX** (לא BTC):

| יחידה | סטושים | תצוגה |
|------|----------|---------|
| **BTCX** | 100000000 | 1.00000000 BTCX |
| **mBTCX** | 100000 | 1000.00 mBTCX |
| **µBTCX** | 100 | 1000000.00 µBTCX |
| **satoshi** | 1 | 100000000 sat |

**הגדרות ממשק**: העדפות → תצוגה → יחידה

---

## דיאלוג הקצאות כרייה

### גישה לדיאלוג

**תפריט**: `ארנק → הקצאות כרייה`
**סרגל כלים**: אייקון כרייה (נראה רק עם דגל `-miningserver`)
**גודל חלון**: 600×450 פיקסלים

### מצבי דיאלוג

#### מצב 1: יצירת הקצאה

**מטרה**: האצלת זכויות כרייה לבריכה או כתובת אחרת תוך שמירה על בעלות plot.

**מקרי שימוש**:
- כריית בריכה (הקצאה לכתובת בריכה)
- אחסון קר (מפתח כרייה נפרד מבעלות plot)
- תשתית משותפת (האצלה לארנק חם)

**דרישות**:
- כתובת plot (P2WPKH bech32, חייב להחזיק מפתח פרטי)
- כתובת כרייה (P2WPKH bech32, שונה מכתובת plot)
- ארנק פתוח (אם מוצפן)
- לכתובת plot יש UTXOs מאושרים

**שלבים**:
1. בחר מצב "יצירת הקצאה"
2. בחר כתובת plot מהתפריט הנפתח או הזן ידנית
3. הזן כתובת כרייה (בריכה או נציג)
4. לחץ "שלח הקצאה" (כפתור מופעל כאשר קלטים תקפים)
5. עסקה משודרת מיד
6. הקצאה פעילה לאחר `nForgingAssignmentDelay` בלוקים:
   - Mainnet/Testnet: 30 בלוקים (~שעה)
   - Regtest: 4 בלוקים (~4 שניות)

**עמלת עסקה**: ברירת מחדל 10× `minRelayFee` (ניתן להתאמה אישית)

**מבנה עסקה**:
- קלט: UTXO מכתובת plot (מוכיח בעלות)
- פלט OP_RETURN: סמן `POCX` + plot_address + forging_address (46 בתים)
- פלט עודף: חוזר לארנק

#### מצב 2: ביטול הקצאה

**מטרה**: ביטול הקצאת כרייה והחזרת זכויות לבעל plot.

**דרישות**:
- כתובת plot (חייב להחזיק מפתח פרטי)
- ארנק פתוח (אם מוצפן)
- לכתובת plot יש UTXOs מאושרים

**שלבים**:
1. בחר מצב "ביטול הקצאה"
2. בחר כתובת plot
3. לחץ "שלח ביטול"
4. עסקה משודרת מיד
5. ביטול אפקטיבי לאחר `nForgingRevocationDelay` בלוקים:
   - Mainnet/Testnet: 720 בלוקים (~24 שעות)
   - Regtest: 8 בלוקים (~8 שניות)

**אפקט**:
- כתובת כרייה יכולה עדיין לכרות במהלך תקופת עיכוב
- בעל plot מחזיר זכויות לאחר השלמת ביטול
- ניתן ליצור הקצאה חדשה לאחר מכן

**מבנה עסקה**:
- קלט: UTXO מכתובת plot (מוכיח בעלות)
- פלט OP_RETURN: סמן `XCOP` + plot_address (26 בתים)
- פלט עודף: חוזר לארנק

#### מצב 3: בדיקת סטטוס הקצאה

**מטרה**: שאילתת מצב הקצאה נוכחי לכל כתובת plot.

**דרישות**: אין (קריאה בלבד, אין צורך בארנק)

**שלבים**:
1. בחר מצב "בדיקת סטטוס הקצאה"
2. הזן כתובת plot
3. לחץ "בדוק סטטוס"
4. תיבת סטטוס מציגה מצב נוכחי עם פרטים

**מחווני מצב** (מקודדי צבע):

**אפור - UNASSIGNED**
```
UNASSIGNED - אין הקצאה קיימת
```

**כתום - ASSIGNING**
```
ASSIGNING - הקצאה ממתינה להפעלה
כתובת כרייה: pocx1qforger...
נוצר בגובה: 12000
מופעל בגובה: 12030 (5 בלוקים נותרו)
```

**ירוק - ASSIGNED**
```
ASSIGNED - הקצאה פעילה
כתובת כרייה: pocx1qforger...
נוצר בגובה: 12000
הופעל בגובה: 12030
```

**אדום-כתום - REVOKING**
```
REVOKING - ביטול ממתין
כתובת כרייה: pocx1qforger... (עדיין פעיל)
הקצאה נוצרה בגובה: 12000
בוטל בגובה: 12300
ביטול אפקטיבי בגובה: 13020 (50 בלוקים נותרו)
```

**אדום - REVOKED**
```
REVOKED - הקצאה בוטלה
הוקצה קודם לכן ל: pocx1qforger...
הקצאה נוצרה בגובה: 12000
בוטל בגובה: 12300
ביטול אפקטיבי בגובה: 13020
```

---

## היסטוריית עסקאות

### תצוגת עסקת הקצאה

**סוג**: "הקצאה"
**אייקון**: אייקון כרייה (זהה לבלוקים שנכרו)

**עמודת כתובת**: כתובת plot (כתובת שזכויות הכרייה שלה מוקצות)
**עמודת סכום**: עמלת עסקה (שלילי, עסקה יוצאת)
**עמודת סטטוס**: מספר אישורים (0-6+)

**פרטים** (כאשר לוחצים):
- מזהה עסקה
- כתובת plot
- כתובת כרייה (מפורסת מ-OP_RETURN)
- נוצר בגובה
- גובה הפעלה
- עמלת עסקה
- חותמת זמן

### תצוגת עסקת ביטול

**סוג**: "ביטול"
**אייקון**: אייקון כרייה

**עמודת כתובת**: כתובת plot
**עמודת סכום**: עמלת עסקה (שלילי)
**עמודת סטטוס**: מספר אישורים

**פרטים** (כאשר לוחצים):
- מזהה עסקה
- כתובת plot
- בוטל בגובה
- גובה ביטול אפקטיבי
- עמלת עסקה
- חותמת זמן

### סינון עסקאות

**מסננים זמינים**:
- "הכל" (ברירת מחדל, כולל הקצאות/ביטולים)
- טווח תאריכים
- טווח סכומים
- חיפוש לפי כתובת
- חיפוש לפי מזהה עסקה
- חיפוש לפי תווית (אם כתובת מתויגת)

**הערה**: עסקאות הקצאה/ביטול מופיעות כרגע תחת מסנן "הכל". מסנן סוג ייעודי טרם יושם.

### מיון עסקאות

**סדר מיון** (לפי סוג):
- נוצר (סוג 0)
- התקבל (סוג 1-3)
- הקצאה (סוג 4)
- ביטול (סוג 5)
- נשלח (סוג 6+)

---

## דרישות כתובות

### P2WPKH (SegWit v0) בלבד

**פעולות כרייה דורשות**:
- כתובות מקודדות Bech32 (מתחילות ב-"pocx1q" mainnet, "tpocx1q" testnet, "rpocx1q" regtest)
- פורמט P2WPKH (Pay-to-Witness-Public-Key-Hash)
- hash מפתח של 20 בתים

**לא נתמך**:
- P2PKH (legacy, מתחיל ב-"1")
- P2SH (wrapped SegWit, מתחיל ב-"3")
- P2TR (Taproot, מתחיל ב-"bc1p")

**רציונל**: חתימות בלוק PoCX דורשות פורמט witness v0 ספציפי לאימות הוכחה.

### סינון תפריט כתובות

**תפריט כתובת Plot**:
- מאוכלס אוטומטית עם כתובות קבלה של הארנק
- מסנן כתובות שאינן P2WPKH
- מציג פורמט: "תווית (כתובת)" אם מתויג, אחרת רק כתובת
- פריט ראשון: "-- הזן כתובת מותאמת --" להזנה ידנית

**הזנה ידנית**:
- מאמת פורמט כאשר מוזן
- חייב להיות bech32 P2WPKH תקף
- כפתור מושבת אם פורמט לא תקף

### הודעות שגיאת אימות

**שגיאות דיאלוג**:
- "כתובת plot חייבת להיות P2WPKH (bech32)"
- "כתובת כרייה חייבת להיות P2WPKH (bech32)"
- "פורמט כתובת לא תקף"
- "אין מטבעות זמינים בכתובת plot. לא ניתן להוכיח בעלות."
- "לא ניתן ליצור עסקאות עם ארנק watch-only"
- "ארנק לא זמין"
- "ארנק נעול" (מ-RPC)

---

## אינטגרציית כרייה

### דרישות הגדרה

**תצורת צומת**:
```bash
# bitcoin.conf
miningserver=1
server=1
```

**דרישות ארנק**:
- כתובות P2WPKH לבעלות plot
- מפתחות פרטיים לכרייה (או כתובת כרייה אם משתמשים בהקצאות)
- UTXOs מאושרים ליצירת עסקאות

**כלים חיצוניים**:
- `pocx_plotter`: ייצור קובצי plot
- `pocx_miner`: סריקת plots והגשת nonces

### זרימת עבודה

#### כרייה עצמאית

1. **ייצור קובצי Plot**:
   ```bash
   pocx_plotter --account <plot_address_hash160> --seed <32_bytes> --nonces <count>
   ```

2. **הפעל צומת** עם שרת כרייה:
   ```bash
   bitcoin-qt -server -miningserver
   ```

3. **הגדר Miner**:
   - הפנה לנקודת קצה RPC של צומת
   - ציין ספריות קובצי plot
   - הגדר account ID (מכתובת plot)

4. **התחל כרייה**:
   ```bash
   pocx_miner --rpc-url http://localhost:8332 --plots /path/to/plots
   ```

5. **ניטור**:
   - Miner קורא ל-`get_mining_info` כל בלוק
   - סורק plots ל-deadline הטוב ביותר
   - קורא ל-`submit_nonce` כאשר נמצא פתרון
   - צומת מאמת וכורה בלוק אוטומטית

#### כריית בריכה

1. **ייצור קובצי Plot** (זהה לכרייה עצמאית)

2. **יצירת הקצאת כרייה**:
   - פתח דיאלוג הקצאות כרייה
   - בחר כתובת plot
   - הזן כתובת כרייה של בריכה
   - לחץ "שלח הקצאה"
   - המתן לעיכוב הפעלה (30 בלוקים testnet)

3. **הגדר Miner**:
   - הפנה לנקודת קצה **בריכה** (לא צומת מקומי)
   - הבריכה מטפלת ב-`submit_nonce` לשרשרת

4. **פעולת בריכה**:
   - ארנק בריכה מחזיק מפתחות פרטיים של כתובת כרייה
   - בריכה מאמתת הגשות מכורים
   - בריכה קוראת ל-`submit_nonce` ל-blockchain
   - בריכה מפיצה תגמולים לפי מדיניות בריכה

### תגמולי Coinbase

**ללא הקצאה**:
- Coinbase משלם ישירות לכתובת בעל plot
- בדוק יתרה בכתובת plot

**עם הקצאה**:
- Coinbase משלם לכתובת כרייה
- בריכה מקבלת תגמולים
- כורה מקבל חלק מהבריכה

**לוח תגמולים**:
- ראשוני: 10 BTCX לבלוק
- חצייה: כל 1050000 בלוקים (~4 שנים)
- לוח: 10 → 5 → 2.5 → 1.25 → ...

---

## פתרון בעיות

### בעיות נפוצות

#### "לארנק אין מפתח פרטי לכתובת plot"

**סיבה**: הארנק לא מחזיק בכתובת
**פתרון**:
- ייבא מפתח פרטי דרך RPC `importprivkey`
- או השתמש בכתובת plot אחרת בבעלות הארנק

#### "הקצאה כבר קיימת ל-plot זה"

**סיבה**: Plot כבר מוקצה לכתובת אחרת
**פתרון**:
1. בטל הקצאה קיימת
2. המתן לעיכוב ביטול (720 בלוקים testnet)
3. צור הקצאה חדשה

#### "פורמט כתובת לא נתמך"

**סיבה**: כתובת אינה P2WPKH bech32
**פתרון**:
- השתמש בכתובות המתחילות ב-"pocx1q" (mainnet) או "tpocx1q" (testnet)
- צור כתובת חדשה אם נדרש: `getnewaddress "" "bech32"`

#### "עמלת עסקה נמוכה מדי"

**סיבה**: עומס mempool רשת או עמלה נמוכה מדי לשידור
**פתרון**:
- הגדל פרמטר קצב עמלה
- המתן לפינוי mempool

#### "הקצאה עדיין לא פעילה"

**סיבה**: עיכוב הפעלה עדיין לא חלף
**פתרון**:
- בדוק סטטוס: בלוקים נותרים עד הפעלה
- המתן להשלמת תקופת עיכוב

#### "אין מטבעות זמינים בכתובת plot"

**סיבה**: לכתובת plot אין UTXOs מאושרים
**פתרון**:
1. שלח כספים לכתובת plot
2. המתן לאישור אחד
3. נסה שוב יצירת הקצאה

#### "לא ניתן ליצור עסקאות עם ארנק watch-only"

**סיבה**: ארנק ייבא כתובת ללא מפתח פרטי
**פתרון**: ייבא מפתח פרטי מלא, לא רק כתובת

#### "לשונית הקצאות כרייה לא נראית"

**סיבה**: צומת הופעל ללא דגל `-miningserver`
**פתרון**: הפעל מחדש עם `bitcoin-qt -server -miningserver`

### שלבי ניפוי שגיאות

1. **בדוק סטטוס ארנק**:
   ```bash
   bitcoin-cli getwalletinfo
   ```

2. **אמת בעלות כתובת**:
   ```bash
   bitcoin-cli getaddressinfo pocx1qplot...
   # בדוק: "iswatchonly": false, "ismine": true
   ```

3. **בדוק סטטוס הקצאה**:
   ```bash
   bitcoin-cli get_assignment pocx1qplot...
   ```

4. **הצג עסקאות אחרונות**:
   ```bash
   bitcoin-cli listtransactions "*" 10
   ```

5. **בדוק סנכרון צומת**:
   ```bash
   bitcoin-cli getblockchaininfo
   # אמת: blocks == headers (מסונכרן לחלוטין)
   ```

---

## שיטות עבודה מומלצות לאבטחה

### אבטחת כתובת Plot

**ניהול מפתחות**:
- אחסן מפתחות פרטיים של כתובת plot בצורה מאובטחת
- עסקאות הקצאה מוכיחות בעלות דרך חתימה
- רק בעל plot יכול ליצור/לבטל הקצאות

**גיבוי**:
- גבה ארנק באופן קבוע (`dumpwallet` או `backupwallet`)
- אחסן wallet.dat במיקום מאובטח
- רשום ביטויי שחזור אם משתמשים בארנק HD

### האצלת כתובת כרייה

**מודל אבטחה**:
- כתובת כרייה מקבלת תגמולי בלוק
- כתובת כרייה יכולה לחתום על בלוקים (כרייה)
- כתובת כרייה **לא יכולה** לשנות או לבטל הקצאה
- בעל plot שומר על שליטה מלאה

**מקרי שימוש**:
- **האצלת ארנק חם**: מפתח plot באחסון קר, מפתח כרייה בארנק חם לכרייה
- **כריית בריכה**: האצלה לבריכה, שמירה על בעלות plot
- **תשתית משותפת**: כורים מרובים, כתובת כרייה אחת

### סנכרון זמן רשת

**חשיבות**:
- קונצנזוס PoCX דורש זמן מדויק
- סחיפת שעון >10s מפעילה אזהרה
- סחיפת שעון >15s מונעת כרייה

**פתרון**:
- שמרו על שעון מערכת מסונכרן עם NTP
- נטרו: `bitcoin-cli getnetworkinfo` לאזהרות היסט זמן
- השתמשו בשרתי NTP אמינים

### עיכובי הקצאה

**עיכוב הפעלה** (30 בלוקים testnet):
- מונע הקצאה מחדש מהירה במהלך פיצולי שרשרת
- מאפשר לרשת להגיע לקונצנזוס
- לא ניתן לעקוף

**עיכוב ביטול** (720 בלוקים testnet):
- מספק יציבות לבריכות כרייה
- מונע התקפות "griefing" של הקצאות
- כתובת כרייה נשארת פעילה במהלך עיכוב

### הצפנת ארנק

**הפעל הצפנה**:
```bash
bitcoin-cli encryptwallet "your_passphrase"
```

**פתח לעסקאות**:
```bash
bitcoin-cli walletpassphrase "your_passphrase" 300
```

**שיטות עבודה מומלצות**:
- השתמש בסיסמה חזקה (20+ תווים)
- אל תאחסן סיסמה בטקסט פתוח
- נעל ארנק לאחר יצירת הקצאות

---

## הפניות לקוד

**דיאלוג הקצאות כרייה**: `src/qt/forgingassignmentdialog.cpp`, `src/qt/forgingassignmentdialog.h`
**תצוגת עסקאות**: `src/qt/transactionrecord.cpp`, `src/qt/transactiontablemodel.cpp`
**פרסור עסקאות**: `src/qt/transactionrecord.cpp`
**אינטגרציית ארנק**: `src/pocx/assignments/transactions.cpp`
**קריאות RPC הקצאה**: `src/pocx/rpc/assignments_wallet.cpp`
**ראשי ממשק**: `src/qt/bitcoingui.cpp`

---

## הפניות צולבות

פרקים קשורים:
- [פרק 3: קונצנזוס וכרייה](3-consensus-and-mining.md) - תהליך כרייה
- [פרק 4: הקצאות כרייה](4-forging-assignments.md) - ארכיטקטורת הקצאות
- [פרק 6: פרמטרי רשת](6-network-parameters.md) - ערכי עיכוב הקצאה
- [פרק 7: עיון ב-RPC](7-rpc-reference.md) - פרטי פקודות RPC

---

[← הקודם: עיון ב-RPC](7-rpc-reference.md) | [📘 תוכן העניינים](index.md)
