[← הקודם: הקצאות כרייה](4-forging-assignments.md) | [📘 תוכן העניינים](index.md) | [הבא: פרמטרי רשת →](6-network-parameters.md)

---

# פרק 5: סנכרון זמן ואבטחה

## סקירה

קונצנזוס PoCX דורש סנכרון זמן מדויק ברחבי הרשת. פרק זה מתעד מנגנוני אבטחה הקשורים לזמן, סבילות סחיפת שעון, והתנהגות כרייה הגנתית.

**מנגנונים מפתח**:
- סבילות עתיד של 15 שניות לחותמות זמן בלוק
- מערכת אזהרת סחיפת שעון של 10 שניות
- כרייה הגנתית (אנטי-מניפולציית שעון)
- אינטגרציית אלגוריתם עיקום זמן

---

## תוכן העניינים

1. [דרישות סנכרון זמן](#דרישות-סנכרון-זמן)
2. [זיהוי סחיפת שעון ואזהרות](#זיהוי-סחיפת-שעון-ואזהרות)
3. [מנגנון כרייה הגנתית](#מנגנון-כרייה-הגנתית)
4. [ניתוח איומי אבטחה](#ניתוח-איומי-אבטחה)
5. [שיטות עבודה מומלצות למפעילי צמתים](#שיטות-עבודה-מומלצות-למפעילי-צמתים)

---

## דרישות סנכרון זמן

### קבועים ופרמטרים

**תצורת Bitcoin-PoCX:**
```cpp
// src/chain.h:31
static constexpr int64_t MAX_FUTURE_BLOCK_TIME = 15;  // 15 שניות

// src/node/timeoffsets.h:27
static constexpr std::chrono::seconds WARN_THRESHOLD{10};  // 10 שניות
```

### בדיקות אימות

**אימות חותמת זמן בלוק** (`src/validation.cpp:4547-4561`):
```cpp
// 1. בדיקת מונוטוניות: חותמת זמן >= חותמת זמן בלוק קודם
if (block.nTime < pindexPrev->nTime) {
    return state.Invalid("time-too-old");
}

// 2. בדיקת עתיד: חותמת זמן <= עכשיו + 15 שניות
if (block.Time() > NodeClock::now() + std::chrono::seconds{MAX_FUTURE_BLOCK_TIME}) {
    return state.Invalid("time-too-new");
}

// 3. בדיקת deadline: זמן שעבר >= deadline
uint32_t elapsed_time = block.nTime - pindexPrev->nTime;
if (result.deadline > elapsed_time) {
    return state.Invalid("bad-pocx-timing");
}
```

### טבלת השפעת סחיפת שעון

| היסט שעון | יכול לסנכרן? | יכול לכרות? | סטטוס אימות | אפקט תחרותי |
|--------------|-----------|-----------|-------------------|-------------------|
| -30s איטי | ❌ לא - בדיקת עתיד נכשלת | N/A | **צומת מת** | לא יכול להשתתף |
| -14s איטי | ✅ כן | ✅ כן | כרייה מאוחרת, עובר אימות | מפסיד מרוצים |
| 0s מושלם | ✅ כן | ✅ כן | אופטימלי | אופטימלי |
| +14s מהיר | ✅ כן | ✅ כן | כרייה מוקדמת, עובר אימות | מנצח מרוצים ⚠️ |
| +16s מהיר | ✅ כן | ❌ בדיקת עתיד נכשלת | לא יכול להפיץ בלוקים | יכול לסנכרן, לא יכול לכרות |

**תובנה מפתח**: חלון 15 השניות סימטרי להשתתפות (±14.9s), אך שעונים מהירים מספקים יתרון תחרותי לא הוגן בתוך הסבילות.

### אינטגרציית עיקום זמן

אלגוריתם עיקום זמן (מפורט ב[פרק 3](3-consensus-and-mining.md#time-bending-calculation)) מטרנספורם deadlines גולמיים באמצעות שורש שלישי:

```
time_bended_deadline = scale × (deadline_seconds)^(1/3)
```

**אינטראקציה עם סחיפת שעון**:
- פתרונות טובים יותר מתכווצים מוקדם יותר (שורש שלישי מגביר הבדלי איכות)
- סחיפת שעון משפיעה על זמן כרייה יחסית לרשת
- כרייה הגנתית מבטיחה תחרות מבוססת איכות למרות שונות תזמון

---

## זיהוי סחיפת שעון ואזהרות

### מערכת אזהרות

Bitcoin-PoCX מנטר היסט זמן בין צומת מקומי לעמיתי רשת.

**הודעת אזהרה** (כאשר סחיפה עולה על 10 שניות):
> "התאריך והשעה של המחשב שלך נראים מחוץ לסנכרון ביותר מ-10 שניות מהרשת, זה עלול להוביל לכשל קונצנזוס PoCX. נא לבדוק את שעון המערכת שלך."

**יישום**: `src/node/timeoffsets.cpp`

### רציונל עיצוב

**למה 10 שניות?**
- מספק חיץ בטיחות של 5 שניות לפני גבול סבילות 15 השניות
- מחמיר יותר מברירת המחדל של Bitcoin Core (10 דקות)
- מתאים לדרישות תזמון PoC

**גישה מניעתית**:
- אזהרה מוקדמת לפני כשל קריטי
- מאפשר למפעילים לתקן בעיות באופן יזום
- מפחית פיצול רשת מכשלים הקשורים לזמן

---

## מנגנון כרייה הגנתית

### מה זה

כרייה הגנתית היא התנהגות כורה סטנדרטית ב-Bitcoin-PoCX שמבטלת יתרונות מבוססי תזמון בייצור בלוקים. כאשר הכורה שלכם מקבל בלוק מתחרה באותו גובה, הוא בודק אוטומטית אם יש לכם פתרון טוב יותר. אם כן, הוא מיד כורה את הבלוק שלכם, מבטיח תחרות מבוססת איכות במקום תחרות מבוססת מניפולציית שעון.

### הבעיה

קונצנזוס PoCX מאפשר בלוקים עם חותמות זמן עד 15 שניות בעתיד. סבילות זו נחוצה לסנכרון רשת גלובלי. עם זאת, היא יוצרת הזדמנות למניפולציית שעון:

**ללא כרייה הגנתית:**
- כורה א': זמן נכון, איכות 800 (טובה יותר), ממתין ל-deadline נכון
- כורה ב': שעון מהיר (+14s), איכות 1000 (גרועה יותר), כורה 14 שניות מוקדם
- תוצאה: כורה ב' מנצח את המרוץ למרות עבודת proof-of-capacity נחותה

**הבעיה:** מניפולציית שעון מספקת יתרון גם עם איכות גרועה יותר, חותרת תחת עקרון ה-proof-of-capacity.

### הפתרון: הגנה דו-שכבתית

#### שכבה 1: אזהרת סחיפת שעון (מניעתית)

Bitcoin-PoCX מנטר היסט זמן בין הצומת שלכם לעמיתי רשת. אם השעון שלכם סוטה יותר מ-10 שניות מקונצנזוס הרשת, תקבלו אזהרה המתריעה לתקן בעיות שעון לפני שהן גורמות לבעיות.

#### שכבה 2: כרייה הגנתית (ריאקטיבית)

כאשר כורה אחר מפרסם בלוק באותו גובה שאתם כורים:

1. **זיהוי**: הצומת שלכם מזהה תחרות באותו גובה
2. **אימות**: מחלץ ומאמת את איכות הבלוק המתחרה
3. **השוואה**: בודק אם האיכות שלכם טובה יותר
4. **תגובה**: אם טובה יותר, כורה את הבלוק שלכם מיד

**תוצאה:** הרשת מקבלת את שני הבלוקים ובוחרת את זה עם האיכות הטובה יותר דרך פתרון fork סטנדרטי.

### איך זה עובד

#### תרחיש: תחרות באותו גובה

```
זמן 150s: כורה ב' (שעון +10s) כורה עם איכות 1000
           → חותמת זמן בלוק מראה 160s (10s בעתיד)

זמן 150s: הצומת שלכם מקבל את בלוק כורה ב'
           → מזהה: אותו גובה, איכות 1000
           → יש לכם: איכות 800 (טובה יותר!)
           → פעולה: כרה מיד עם חותמת זמן נכונה (150s)

זמן 152s: הרשת מאמתת שני הבלוקים
           → שניהם תקפים (בתוך סבילות 15s)
           → איכות 800 מנצחת (נמוך יותר = טוב יותר)
           → הבלוק שלכם הופך לקצה שרשרת
```

#### תרחיש: Reorg אמיתי

```
גובה כרייה שלכם 100, מתחרה מפרסם בלוק 99
→ לא תחרות באותו גובה
→ כרייה הגנתית לא מופעלת
→ טיפול reorg רגיל ממשיך
```

### יתרונות

**אפס תמריץ למניפולציית שעון**
- שעונים מהירים עוזרים רק אם כבר יש לכם את האיכות הטובה ביותר
- מניפולציית שעון הופכת לחסרת טעם כלכלי

**תחרות מבוססת איכות מאולצת**
- מאלץ כורים להתחרות על עבודת proof-of-capacity בפועל
- שומר על שלמות קונצנזוס PoCX

**אבטחת רשת**
- עמיד לאסטרטגיות משחק מבוססות תזמון
- אין צורך בשינויי קונצנזוס - התנהגות כורה טהורה

**אוטומטי לחלוטין**
- אין צורך בתצורה
- מופעל רק כשנחוץ
- התנהגות סטנדרטית בכל צמתי Bitcoin-PoCX

### פשרות

**עלייה מינימלית בשיעור Orphan**
- מכוונת - בלוקי התקפה נהפכים ל-orphan
- מתרחש רק במהלך ניסיונות מניפולציית שעון בפועל
- תוצאה טבעית של פתרון fork מבוסס איכות

**תחרות רשת קצרה**
- הרשת רואה לזמן קצר שני בלוקים מתחרים
- נפתר בשניות דרך אימות סטנדרטי
- אותה התנהגות כמו כרייה בו-זמנית ב-Bitcoin

### פרטים טכניים

**השפעת ביצועים:** זניחה
- מופעל רק על תחרות באותו גובה
- משתמש בנתונים בזיכרון (ללא I/O דיסק)
- אימות מסתיים באלפיות שנייה

**שימוש במשאבים:** מינימלי
- ~20 שורות לוגיקה מרכזית
- משתמש מחדש בתשתית אימות קיימת
- רכישת נעילה יחידה

**תאימות:** מלאה
- ללא שינויי כללי קונצנזוס
- עובד עם כל תכונות Bitcoin Core
- ניטור אופציונלי דרך לוגי debug

**סטטוס**: פעיל בכל גרסאות Bitcoin-PoCX
**הוצג לראשונה**: 2025-10-10

---

## ניתוח איומי אבטחה

### התקפת שעון מהיר (מופחת על ידי כרייה הגנתית)

**וקטור התקפה**:
כורה עם שעון **+14s קדימה** יכול:
1. לקבל בלוקים כרגיל (נראים ישנים לו)
2. לכרות בלוקים מיד כאשר deadline עובר
3. לשדר בלוקים שנראים 14s "מוקדם" לרשת
4. **בלוקים מתקבלים** (בתוך סבילות 15s)
5. **מנצח מרוצים** נגד כורים ישרים

**השפעה ללא כרייה הגנתית**:
היתרון מוגבל ל-14.9 שניות (לא מספיק לדלג על עבודת PoC משמעותית), אך מספק יתרון עקבי במרוצי בלוקים.

**הפחתה (כרייה הגנתית)**:
- כורים ישרים מזהים תחרות באותו גובה
- משווים ערכי איכות
- כורים מיד אם האיכות טובה יותר
- **תוצאה**: שעון מהיר עוזר רק אם כבר יש לכם את האיכות הטובה ביותר
- **תמריץ**: אפס - מניפולציית שעון הופכת לחסרת טעם כלכלי

### כשל שעון איטי (קריטי)

**מצב כשל**:
צומת **>15s מאחור** הוא קטסטרופלי:
- לא יכול לאמת בלוקים נכנסים (בדיקת עתיד נכשלת)
- נהיה מבודד מהרשת
- לא יכול לכרות או לסנכרן

**הפחתה**:
- אזהרה חזקה ב-10s סחיפה נותנת חיץ של 5 שניות לפני כשל קריטי
- מפעילים יכולים לתקן בעיות שעון באופן יזום
- הודעות שגיאה ברורות מנחות פתרון בעיות

---

## שיטות עבודה מומלצות למפעילי צמתים

### הגדרת סנכרון זמן

**תצורה מומלצת**:
1. **הפעל NTP**: השתמש ב-Network Time Protocol לסנכרון אוטומטי
   ```bash
   # Linux (systemd-timesyncd)
   sudo timedatectl set-ntp true

   # בדוק סטטוס
   timedatectl status
   ```

2. **אמת דיוק שעון**: בדוק באופן קבוע היסט זמן
   ```bash
   # בדוק סטטוס סנכרון NTP
   ntpq -p

   # או עם chrony
   chronyc tracking
   ```

3. **נטר אזהרות**: עקוב אחר אזהרות סחיפת שעון של Bitcoin-PoCX בלוגים

### לכורים

**אין צורך בפעולה**:
- התכונה תמיד פעילה
- פועלת אוטומטית
- רק שמרו על שעון המערכת שלכם מדויק

**שיטות עבודה מומלצות**:
- השתמשו בסנכרון זמן NTP
- נטרו אזהרות סחיפת שעון
- טפלו באזהרות מיד אם הן מופיעות

**התנהגות צפויה**:
- כריית סולו: כרייה הגנתית לעתים נדירות מופעלת (אין תחרות)
- כריית רשת: מגן מפני ניסיונות מניפולציית שעון
- פעולה שקופה: רוב הכורים לעולם לא מבחינים בה

### פתרון בעיות

**אזהרה: "מחוץ לסנכרון ב-10 שניות"**
- פעולה: בדקו ותקנו סנכרון שעון מערכת
- השפעה: חיץ של 5 שניות לפני כשל קריטי
- כלים: NTP, chrony, systemd-timesyncd

**שגיאה: "time-too-new" על בלוקים נכנסים**
- סיבה: השעון שלכם איטי ביותר מ-15 שניות
- השפעה: לא יכול לאמת בלוקים, צומת מבודד
- תיקון: סנכרנו שעון מערכת מיד

**שגיאה: לא יכול להפיץ בלוקים שנכרו**
- סיבה: השעון שלכם מהיר ביותר מ-15 שניות
- השפעה: בלוקים נדחים על ידי הרשת
- תיקון: סנכרנו שעון מערכת מיד

---

## החלטות עיצוב ורציונל

### למה סבילות של 15 שניות?

**רציונל**:
- תזמון deadline משתנה של Bitcoin-PoCX פחות קריטי מבחינת זמן מקונצנזוס תזמון קבוע
- 15s מספק הגנה מספקת תוך מניעת פיצול רשת

**פשרות**:
- סבילות צרה יותר = יותר פיצול רשת מסחיפה קטנה
- סבילות רחבה יותר = יותר הזדמנות להתקפות תזמון
- 15s מאזן בין אבטחה ועמידות

### למה אזהרה של 10 שניות?

**היגיון**:
- מספק חיץ בטיחות של 5 שניות
- מתאים יותר ל-PoC מברירת המחדל של Bitcoin של 10 דקות
- מאפשר תיקונים יזומים לפני כשל קריטי

### למה כרייה הגנתית?

**בעיה שנפתרה**:
- סבילות 15 שניות מאפשרת יתרון שעון מהיר
- קונצנזוס מבוסס איכות יכול להיות חתור על ידי מניפולציית תזמון

**יתרונות הפתרון**:
- הגנה ללא עלות (ללא שינויי קונצנזוס)
- פעולה אוטומטית
- מבטל תמריץ התקפה
- שומר על עקרונות proof-of-capacity

### למה אין סנכרון זמן פנים-רשתי?

**היגיון אבטחתי**:
- Bitcoin Core מודרני הסיר התאמת זמן מבוססת עמיתים
- פגיע להתקפות Sybil על זמן רשת נתפס
- PoCX נמנע במכוון מהסתמכות על מקורות זמן פנים-רשתיים
- שעון מערכת אמין יותר מקונצנזוס עמיתים
- מפעילים צריכים לסנכרן באמצעות NTP או מקור זמן חיצוני מקביל
- צמתים מנטרים סחיפה משלהם ופולטים אזהרות אם שעון מקומי סוטה מחותמות זמן בלוק אחרונות

---

## הפניות ליישום

**קובצי ליבה**:
- אימות זמן: `src/validation.cpp:4547-4561`
- קבוע סבילות עתיד: `src/chain.h:31`
- סף אזהרה: `src/node/timeoffsets.h:27`
- ניטור היסט זמן: `src/node/timeoffsets.cpp`
- כרייה הגנתית: `src/pocx/mining/scheduler.cpp`

**תיעוד קשור**:
- אלגוריתם עיקום זמן: [פרק 3: קונצנזוס וכרייה](3-consensus-and-mining.md#time-bending-calculation)
- אימות בלוק: [פרק 3: אימות בלוק](3-consensus-and-mining.md#block-validation)

---

**נוצר**: 2025-10-10
**סטטוס**: יישום מלא
**כיסוי**: דרישות סנכרון זמן, טיפול בסחיפת שעון, כרייה הגנתית

---

[← הקודם: הקצאות כרייה](4-forging-assignments.md) | [📘 תוכן העניינים](index.md) | [הבא: פרמטרי רשת →](6-network-parameters.md)
