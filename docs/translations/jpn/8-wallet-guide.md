[← 前へ: RPCリファレンス](7-rpc-reference.md) | [目次](index.md)

---

# 第8章: ウォレットとGUIユーザーガイド

Bitcoin-PoCX Qtウォレットとフォージング割り当て管理の完全ガイド。

---

## 目次

1. [概要](#概要)
2. [通貨単位](#通貨単位)
3. [フォージング割り当てダイアログ](#フォージング割り当てダイアログ)
4. [トランザクション履歴](#トランザクション履歴)
5. [アドレス要件](#アドレス要件)
6. [マイニング統合](#マイニング統合)
7. [トラブルシューティング](#トラブルシューティング)
8. [セキュリティベストプラクティス](#セキュリティベストプラクティス)

---

## 概要

### Bitcoin-PoCXウォレット機能

Bitcoin-PoCX Qtウォレット（`bitcoin-qt`）は以下を提供します:
- 標準Bitcoin Coreウォレット機能（送金、受取、トランザクション管理）
- **フォージング割り当てマネージャー**: プロット割り当ての作成/取り消し用GUI
- **マイニングサーバーモード**: `-miningserver`フラグでマイニング関連機能を有効化
- **トランザクション履歴**: 割り当ておよび取り消しトランザクションの表示

### ウォレットの起動

**ノードのみ**（マイニングなし）:
```bash
./build/bin/bitcoin-qt
```

**マイニング付き**（割り当てダイアログを有効化）:
```bash
./build/bin/bitcoin-qt -server -miningserver
```

**コマンドライン代替**:
```bash
./build/bin/bitcoind -miningserver
```

### マイニング要件

**マイニング操作用**:
- `-miningserver`フラグ必須
- P2WPKHアドレスと秘密鍵を持つウォレット
- プロット生成用の外部プロッター（`pocx_plotter`）
- マイニング用の外部マイナー（`pocx_miner`）

**プールマイニング用**:
- プールアドレスへのフォージング割り当てを作成
- プールサーバーにウォレット不要（プールが鍵を管理）

---

## 通貨単位

### 単位表示

Bitcoin-PoCXは**BTCX**通貨単位を使用（BTCではなく）:

| 単位 | サトシ | 表示 |
|------|----------|---------|
| **BTCX** | 100000000 | 1.00000000 BTCX |
| **mBTCX** | 100000 | 1000.00 mBTCX |
| **μBTCX** | 100 | 1000000.00 μBTCX |
| **satoshi** | 1 | 100000000 sat |

**GUI設定**: 設定 → 表示 → 単位

---

## フォージング割り当てダイアログ

### ダイアログへのアクセス

**メニュー**: `ウォレット → フォージング割り当て`
**ツールバー**: マイニングアイコン（`-miningserver`フラグでのみ表示）
**ウィンドウサイズ**: 600×450ピクセル

### ダイアログモード

#### モード1: 割り当ての作成

**目的**: プロット所有権を維持しながらフォージング権限をプールまたは別のアドレスに委譲。

**ユースケース**:
- プールマイニング（プールアドレスに割り当て）
- コールドストレージ（マイニングキーをプロット所有権から分離）
- 共有インフラストラクチャ（ホットウォレットに委譲）

**要件**:
- プロットアドレス（P2WPKH bech32、秘密鍵を所有必須）
- フォージングアドレス（P2WPKH bech32、プロットアドレスと異なる必要）
- ウォレットがアンロック済み（暗号化されている場合）
- プロットアドレスに確認済みUTXOがある

**手順**:
1. 「割り当ての作成」モードを選択
2. ドロップダウンからプロットアドレスを選択するか手動入力
3. フォージングアドレス（プールまたは委譲先）を入力
4. 「割り当て送信」をクリック（入力が有効な場合ボタンが有効）
5. トランザクションは即座にブロードキャスト
6. `nForgingAssignmentDelay`ブロック後に割り当てがアクティブに:
   - メインネット/テストネット: 30ブロック（約1時間）
   - Regtest: 4ブロック（約4秒）

**トランザクション手数料**: デフォルト10× `minRelayFee`（カスタマイズ可能）

**トランザクション構造**:
- 入力: プロットアドレスからのUTXO（所有権を証明）
- OP_RETURN出力: `POCX`マーカー + plot_address + forging_address（46バイト）
- お釣り出力: ウォレットに戻る

#### モード2: 割り当ての取り消し

**目的**: フォージング割り当てをキャンセルし、権限をプロット所有者に戻す。

**要件**:
- プロットアドレス（秘密鍵を所有必須）
- ウォレットがアンロック済み（暗号化されている場合）
- プロットアドレスに確認済みUTXOがある

**手順**:
1. 「割り当ての取り消し」モードを選択
2. プロットアドレスを選択
3. 「取り消し送信」をクリック
4. トランザクションは即座にブロードキャスト
5. `nForgingRevocationDelay`ブロック後に取り消しが有効に:
   - メインネット/テストネット: 720ブロック（約24時間）
   - Regtest: 8ブロック（約8秒）

**効果**:
- フォージングアドレスは遅延期間中もフォージ可能
- プロット所有者は取り消し完了後に権限を回復
- その後新しい割り当てを作成可能

**トランザクション構造**:
- 入力: プロットアドレスからのUTXO（所有権を証明）
- OP_RETURN出力: `XCOP`マーカー + plot_address（26バイト）
- お釣り出力: ウォレットに戻る

#### モード3: 割り当てステータスの確認

**目的**: 任意のプロットアドレスの現在の割り当て状態をクエリ。

**要件**: なし（読み取り専用、ウォレット不要）

**手順**:
1. 「割り当てステータスの確認」モードを選択
2. プロットアドレスを入力
3. 「ステータス確認」をクリック
4. ステータスボックスに詳細付きの現在の状態を表示

**状態インジケーター**（色分け）:

**グレー - UNASSIGNED**
```
UNASSIGNED - 割り当てなし
```

**オレンジ - ASSIGNING**
```
ASSIGNING - 割り当てアクティベーション保留中
フォージングアドレス: pocx1qforger...
作成高さ: 12000
アクティベーション高さ: 12030（残り5ブロック）
```

**グリーン - ASSIGNED**
```
ASSIGNED - アクティブな割り当て
フォージングアドレス: pocx1qforger...
作成高さ: 12000
アクティベーション高さ: 12030
```

**レッドオレンジ - REVOKING**
```
REVOKING - 取り消し保留中
フォージングアドレス: pocx1qforger...（まだアクティブ）
割り当て作成高さ: 12000
取り消し高さ: 12300
取り消し有効高さ: 13020（残り50ブロック）
```

**レッド - REVOKED**
```
REVOKED - 割り当て取り消し済み
以前の割り当て先: pocx1qforger...
割り当て作成高さ: 12000
取り消し高さ: 12300
取り消し有効高さ: 13020
```

---

## トランザクション履歴

### 割り当てトランザクション表示

**タイプ**: "Assignment"
**アイコン**: マイニングアイコン（マイニングブロックと同じ）

**アドレス列**: プロットアドレス（フォージング権限が割り当てられているアドレス）
**金額列**: トランザクション手数料（マイナス、送信トランザクション）
**ステータス列**: 確認数（0-6+）

**詳細**（クリック時）:
- トランザクションID
- プロットアドレス
- フォージングアドレス（OP_RETURNから解析）
- 作成高さ
- アクティベーション高さ
- トランザクション手数料
- タイムスタンプ

### 取り消しトランザクション表示

**タイプ**: "Revocation"
**アイコン**: マイニングアイコン

**アドレス列**: プロットアドレス
**金額列**: トランザクション手数料（マイナス）
**ステータス列**: 確認数

**詳細**（クリック時）:
- トランザクションID
- プロットアドレス
- 取り消し高さ
- 取り消し有効高さ
- トランザクション手数料
- タイムスタンプ

### トランザクションフィルタリング

**利用可能なフィルター**:
- "すべて"（デフォルト、割り当て/取り消しを含む）
- 日付範囲
- 金額範囲
- アドレス検索
- トランザクションID検索
- ラベル検索（アドレスにラベル付けされている場合）

**注意**: 割り当て/取り消しトランザクションは現在「すべて」フィルターに表示されます。専用タイプフィルターは未実装。

### トランザクションソート

**ソート順序**（タイプ別）:
- Generated（タイプ0）
- Received（タイプ1-3）
- Assignment（タイプ4）
- Revocation（タイプ5）
- Sent（タイプ6以上）

---

## アドレス要件

### P2WPKH（SegWit v0）のみ

**フォージング操作に必要**:
- Bech32エンコードアドレス（"pocx1q"メインネット、"tpocx1q"テストネット、"rpocx1q"regtestで開始）
- P2WPKH（Pay-to-Witness-Public-Key-Hash）形式
- 20バイト鍵ハッシュ

**非対応**:
- P2PKH（レガシー、"1"で開始）
- P2SH（ラップドSegWit、"3"で開始）
- P2TR（Taproot、"bc1p"で開始）

**根拠**: PoCXブロック署名は証明検証に特定のwitness v0形式を必要とします。

### アドレスドロップダウンフィルタリング

**プロットアドレスコンボボックス**:
- ウォレットの受取アドレスで自動入力
- 非P2WPKHアドレスをフィルタリング
- 形式表示: ラベル付きは「ラベル（アドレス）」、なければアドレスのみ
- 最初の項目: 「-- カスタムアドレスを入力 --」で手動入力

**手動入力**:
- 入力時にフォーマットを検証
- 有効なbech32 P2WPKH必須
- 無効なフォーマットの場合ボタン無効

### 検証エラーメッセージ

**ダイアログエラー**:
- 「プロットアドレスはP2WPKH（bech32）である必要があります」
- 「フォージングアドレスはP2WPKH（bech32）である必要があります」
- 「無効なアドレス形式」
- 「プロットアドレスに利用可能なコインがありません。所有権を証明できません。」
- 「ウォッチオンリーウォレットではトランザクションを作成できません」
- 「ウォレットが利用できません」
- 「ウォレットがロックされています」（RPCから）

---

## マイニング統合

### セットアップ要件

**ノード設定**:
```bash
# bitcoin.conf
miningserver=1
server=1
```

**ウォレット要件**:
- プロット所有権用のP2WPKHアドレス
- マイニング用の秘密鍵（または割り当て使用時はフォージングアドレス）
- トランザクション作成用の確認済みUTXO

**外部ツール**:
- `pocx_plotter`: プロットファイル生成
- `pocx_miner`: プロットスキャンとノンス送信

### ワークフロー

#### ソロマイニング

1. **プロットファイルの生成**:
   ```bash
   pocx_plotter --account <plot_address_hash160> --seed <32_bytes> --nonces <count>
   ```

2. **マイニングサーバー付きでノードを起動**:
   ```bash
   bitcoin-qt -server -miningserver
   ```

3. **マイナーの設定**:
   - ノードRPCエンドポイントを指定
   - プロットファイルディレクトリを指定
   - アカウントID（プロットアドレスから）を設定

4. **マイニング開始**:
   ```bash
   pocx_miner --rpc-url http://localhost:8332 --plots /path/to/plots
   ```

5. **監視**:
   - マイナーは毎ブロック`get_mining_info`を呼び出す
   - プロットをスキャンして最良のデッドラインを探す
   - 解が見つかったら`submit_nonce`を呼び出す
   - ノードが自動的にブロックを検証してフォージ

#### プールマイニング

1. **プロットファイルの生成**（ソロマイニングと同じ）

2. **フォージング割り当ての作成**:
   - フォージング割り当てダイアログを開く
   - プロットアドレスを選択
   - プールのフォージングアドレスを入力
   - 「割り当て送信」をクリック
   - アクティベーション遅延を待機（テストネット30ブロック）

3. **マイナーの設定**:
   - **プール**エンドポイントを指定（ローカルノードではなく）
   - プールが`submit_nonce`をチェーンに処理

4. **プール操作**:
   - プールウォレットがフォージングアドレスの秘密鍵を持つ
   - プールがマイナーからの送信を検証
   - プールがブロックチェーンに`submit_nonce`を呼び出す
   - プールがポリシーに従って報酬を分配

### Coinbase報酬

**割り当てなし**:
- Coinbaseはプロット所有者アドレスに直接支払い
- プロットアドレスで残高を確認

**割り当てあり**:
- Coinbaseはフォージングアドレスに支払い
- プールが報酬を受け取る
- マイナーはプールからシェアを受け取る

**報酬スケジュール**:
- 初期: ブロックあたり10 BTCX
- 半減: 1050000ブロックごと（約4年）
- スケジュール: 10 → 5 → 2.5 → 1.25 → ...

---

## トラブルシューティング

### よくある問題

#### 「ウォレットにプロットアドレスの秘密鍵がありません」

**原因**: ウォレットがアドレスを所有していない
**解決策**:
- `importprivkey` RPCで秘密鍵をインポート
- またはウォレットが所有する別のプロットアドレスを使用

#### 「このプロットには既に割り当てがあります」

**原因**: プロットは既に別のアドレスに割り当て済み
**解決策**:
1. 既存の割り当てを取り消し
2. 取り消し遅延を待機（テストネット720ブロック）
3. 新しい割り当てを作成

#### 「アドレス形式がサポートされていません」

**原因**: アドレスがP2WPKH bech32でない
**解決策**:
- "pocx1q"（メインネット）または"tpocx1q"（テストネット）で始まるアドレスを使用
- 必要なら新しいアドレスを生成: `getnewaddress "" "bech32"`

#### 「トランザクション手数料が低すぎます」

**原因**: ネットワークmempoolの混雑または手数料がリレーに低すぎる
**解決策**:
- 手数料率パラメータを増加
- mempoolクリアを待機

#### 「割り当てがまだアクティブではありません」

**原因**: アクティベーション遅延がまだ経過していない
**解決策**:
- ステータスを確認: アクティベーションまでの残りブロック数
- 遅延期間の完了を待機

#### 「プロットアドレスに利用可能なコインがありません」

**原因**: プロットアドレスに確認済みUTXOがない
**解決策**:
1. プロットアドレスに資金を送金
2. 1確認を待機
3. 割り当て作成を再試行

#### 「ウォッチオンリーウォレットではトランザクションを作成できません」

**原因**: ウォレットは秘密鍵なしでアドレスをインポート
**解決策**: アドレスだけでなく完全な秘密鍵をインポート

#### 「フォージング割り当てタブが表示されない」

**原因**: ノードが`-miningserver`フラグなしで起動
**解決策**: `bitcoin-qt -server -miningserver`で再起動

### デバッグ手順

1. **ウォレットステータスを確認**:
   ```bash
   bitcoin-cli getwalletinfo
   ```

2. **アドレス所有権を確認**:
   ```bash
   bitcoin-cli getaddressinfo pocx1qplot...
   # 確認: "iswatchonly": false, "ismine": true
   ```

3. **割り当てステータスを確認**:
   ```bash
   bitcoin-cli get_assignment pocx1qplot...
   ```

4. **最近のトランザクションを表示**:
   ```bash
   bitcoin-cli listtransactions "*" 10
   ```

5. **ノード同期を確認**:
   ```bash
   bitcoin-cli getblockchaininfo
   # 確認: blocks == headers（完全同期）
   ```

---

## セキュリティベストプラクティス

### プロットアドレスセキュリティ

**鍵管理**:
- プロットアドレスの秘密鍵を安全に保管
- 割り当てトランザクションは署名で所有権を証明
- プロット所有者のみが割り当ての作成/取り消しが可能

**バックアップ**:
- ウォレットを定期的にバックアップ（`dumpwallet`または`backupwallet`）
- wallet.datを安全な場所に保管
- HDウォレット使用時はリカバリーフレーズを記録

### フォージングアドレス委譲

**セキュリティモデル**:
- フォージングアドレスはブロック報酬を受け取る
- フォージングアドレスはブロックに署名可能（マイニング）
- フォージングアドレスは割り当てを変更または取り消し**不可**
- プロット所有者は完全な制御を維持

**ユースケース**:
- **ホットウォレット委譲**: プロット鍵はコールドストレージ、フォージング鍵はマイニング用ホットウォレット
- **プールマイニング**: プールに委譲、プロット所有権は維持
- **共有インフラストラクチャ**: 複数のマイナー、1つのフォージングアドレス

### ネットワーク時刻同期

**重要性**:
- PoCXコンセンサスは正確な時刻を必要
- クロックドリフト >10秒で警告発生
- クロックドリフト >15秒でマイニング不可

**解決策**:
- システム時刻をNTPで同期維持
- 監視: `bitcoin-cli getnetworkinfo`で時刻オフセット警告を確認
- 信頼性の高いNTPサーバーを使用

### 割り当て遅延

**アクティベーション遅延**（テストネット30ブロック）:
- チェーンフォーク中の急速な再割り当てを防止
- ネットワークがコンセンサスに達することを許可
- バイパス不可

**取り消し遅延**（テストネット720ブロック）:
- マイニングプールに安定性を提供
- 割り当て「グリーフィング」攻撃を防止
- フォージングアドレスは遅延中もアクティブ

### ウォレット暗号化

**暗号化を有効化**:
```bash
bitcoin-cli encryptwallet "your_passphrase"
```

**トランザクション用にアンロック**:
```bash
bitcoin-cli walletpassphrase "your_passphrase" 300
```

**ベストプラクティス**:
- 強力なパスフレーズを使用（20文字以上）
- パスフレーズを平文で保存しない
- 割り当て作成後にウォレットをロック

---

## コード参照

**フォージング割り当てダイアログ**: `src/qt/forgingassignmentdialog.cpp`、`src/qt/forgingassignmentdialog.h`
**トランザクション表示**: `src/qt/transactionrecord.cpp`、`src/qt/transactiontablemodel.cpp`
**トランザクション解析**: `src/qt/transactionrecord.cpp`
**ウォレット統合**: `src/pocx/assignments/transactions.cpp`
**割り当てRPC**: `src/pocx/rpc/assignments_wallet.cpp`
**GUIメイン**: `src/qt/bitcoingui.cpp`

---

## 相互参照

関連章:
- [第3章: コンセンサスとマイニング](3-consensus-and-mining.md) - マイニングプロセス
- [第4章: フォージング割り当て](4-forging-assignments.md) - 割り当てアーキテクチャ
- [第6章: ネットワークパラメータ](6-network-parameters.md) - 割り当て遅延値
- [第7章: RPCリファレンス](7-rpc-reference.md) - RPCコマンド詳細

---

[← 前へ: RPCリファレンス](7-rpc-reference.md) | [目次](index.md)
