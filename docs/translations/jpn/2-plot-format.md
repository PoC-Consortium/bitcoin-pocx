[← 前へ: はじめに](1-introduction.md) | [目次](index.md) | [次へ: コンセンサスとマイニング →](3-consensus-and-mining.md)

---

# 第2章: PoCXプロット形式仕様

本文書は、PoCXプロット形式について説明します。これはPOC2形式の拡張版であり、セキュリティの改善、SIMD最適化、およびスケーラブルなProof-of-Workを備えています。

## 形式概要

PoCXプロットファイルには、効率的なマイニング操作のために編成された事前計算済みのShabal256ハッシュ値が含まれています。POC1以来のPoC伝統に従い、**すべてのメタデータはファイル名に埋め込まれます**—ファイルヘッダーはありません。

### ファイル拡張子
- **標準**: `.pocx`（完成したプロット）
- **作成中**: `.tmp`（プロット中、完成時に`.pocx`にリネーム）

## 歴史的背景と脆弱性の進化

### POC1形式（レガシー）
**2つの主要な脆弱性（時間-メモリトレードオフ）:**

1. **PoW分布の欠陥**
   - スクープ間でのProof-of-Workの非均一分布
   - 低いスクープ番号はオンザフライで計算可能
   - **影響**: 攻撃者のストレージ要件を削減

2. **XOR圧縮攻撃**（50%時間-メモリトレードオフ）
   - 数学的特性を悪用して50%のストレージ削減を達成
   - **影響**: 攻撃者は必要なストレージの半分でマイニング可能

**レイアウト最適化**: HDD効率のための基本的な順次スクープレイアウト

### POC2形式（Burstcoin）
- ✅ **PoW分布の欠陥を修正**
- ❌ **XOR-transpose脆弱性は未パッチのまま**
- **レイアウト**: 順次スクープ最適化を維持

### PoCX形式（現行）
- ✅ **PoW分布を修正**（POC2から継承）
- ✅ **XOR-transpose脆弱性をパッチ**（PoCX独自）
- ✅ **強化されたSIMD/GPUレイアウト**（並列処理とメモリコアレシングに最適化）
- ✅ **スケーラブルなProof-of-Work**（計算能力の成長に伴う時間-メモリトレードオフを防止、PoWはプロットファイル作成またはアップグレード時のみ実行）

## XOR-Transposeエンコーディング

### 問題: 50%時間-メモリトレードオフ

POC1/POC2形式では、攻撃者はスクープ間の数学的関係を悪用して、データの半分のみを保存し、残りをマイニング中にオンザフライで計算できました。この「XOR圧縮攻撃」はストレージ保証を損なっていました。

### 解決策: XOR-Transposeハードニング

PoCXは、ベースワープ（X0）のペアにXOR-transposeエンコーディングを適用することで、マイニング形式（X1）を導出します:

**X1ワープでノンスNのスクープSを構築するには:**
1. 最初のX0ワープからノンスNのスクープSを取得（直接位置）
2. 2番目のX0ワープからノンスSのスクープNを取得（転置位置）
3. 2つの64バイト値をXORしてX1スクープを取得

転置ステップはスクープとノンスのインデックスを交換します。行がスクープ、列がノンスを表す行列として見ると、最初のワープの位置(S, N)の要素と2番目のワープの位置(N, S)の要素を組み合わせます。

### なぜこれが攻撃を排除するのか

XOR-transposeは各スクープを、基礎となるX0データの行全体と列全体に連結させます。単一のX1スクープを復元するには、4096個すべてのスクープインデックスにまたがるデータへのアクセスが必要です。欠落データを計算しようとすると、単一のノンスではなく4096個の完全なノンスを再生成する必要があり、XOR攻撃で悪用された非対称コスト構造が除去されます。

結果として、マイナーにとって完全なX1ワープを保存することが唯一の計算上実行可能な戦略となります。

## ファイル名メタデータ構造

すべてのプロットメタデータは、以下の正確な形式でファイル名にエンコードされます:

```
{ACCOUNT_PAYLOAD}_{SEED}_{WARPS}_{SCALING}.pocx
```

### ファイル名コンポーネント

1. **ACCOUNT_PAYLOAD**（40進文字）
   - 大文字16進数としての生の20バイトアカウントペイロード
   - ネットワーク非依存（ネットワークIDやチェックサムなし）
   - 例: `DEADBEEFCAFEBABE1337C0DEBADC0FFEE15DEAD`

2. **SEED**（64進文字）
   - 小文字16進数としての32バイトシード値
   - **PoCXの新機能**: ファイル名内のランダムな32バイトシードが連続ノンス番号付けを置換—プロットの重複を防止
   - 例: `c0ffeebeefcafebabedeadbeef1337c0de42424242feedfacecafed00dabad1dea`

3. **WARPS**（10進数）
   - **PoCXの新しいサイズ単位**: POC1/POC2のノンスベースのサイジングを置換
   - **XOR-transpose耐性設計**: 各ワープ = 正確に4096ノンス（XOR-transpose耐性変換に必要なパーティションサイズ）
   - **サイズ**: 1ワープ = 1073741824バイト = 1 GiB（便利な単位）
   - 例: `1024`（1 TiBプロット = 1024ワープ）

4. **SCALING**（X接頭辞付き10進数）
   - `X{レベル}`としてのスケーリングレベル
   - 高い値 = より多くのProof-of-Workが必要
   - 例: `X4`（2^4 = 16× POC2難易度）

### ファイル名の例
```
DEADBEEFCAFEBABE1337C0DEBADC0FFEE15DEAD_c0ffeebeefcafebabedeadbeef1337c0de42424242feedfacecafed00dabad1dea_1024_X4.pocx
FEEDFACEDEADC0DE123456789ABCDEF012345678_b00b1e5feedc0debabeface5dea1deadc0de1337c0ffeebabeface5bad1dea5_2048_X1.pocx
```


## ファイルレイアウトとデータ構造

### 階層的構成
```
プロットファイル（ヘッダーなし）
├── スクープ 0
│   ├── ワープ 0（このスクープ/ワープのすべてのノンス）
│   ├── ワープ 1
│   └── ...
├── スクープ 1
│   ├── ワープ 0
│   ├── ワープ 1
│   └── ...
└── スクープ 4095
    ├── ワープ 0
    └── ...
```

### 定数とサイズ

| 定数 | サイズ | 説明 |
| --------------- | ----------------------- | ----------------------------------------------- |
| **HASH\_SIZE** | 32 B | 単一のShabal256ハッシュ出力 |
| **SCOOP\_SIZE** | 64 B（2 × HASH\_SIZE） | マイニングラウンドで読み取られるハッシュペア |
| **NUM\_SCOOPS** | 4096（2¹²） | ノンスあたりのスクープ数; ラウンドごとに1つ選択 |
| **NONCE\_SIZE** | 262144 B（256 KiB） | ノンスのすべてのスクープ（PoC1/PoC2の最小単位） |
| **WARP\_SIZE** | 1073741824 B（1 GiB） | PoCXの最小単位 |

### SIMD最適化プロットファイルレイアウト

PoCXは、複数のノンスの同時ベクトル化処理を可能にするSIMD対応のノンスアクセスパターンを実装しています。メモリスループットとSIMD効率を最大化するために、[POC2×16最適化研究](https://www.reddit.com/r/burstcoin/comments/a1qyoq/cip_announcement_poc2x16_a_new_optimized_plot/)のコンセプトに基づいて構築されています。

---

#### 従来の順次レイアウト

ノンスの順次格納:

```
[ノンス 0: スクープデータ] [ノンス 1: スクープデータ] [ノンス 2: スクープデータ] ...
```

SIMD非効率: 各SIMDレーンはノンス間で同じワードを必要とします:

```
ノンス 0 のワード 0 -> オフセット 0
ノンス 1 のワード 0 -> オフセット 512
ノンス 2 のワード 0 -> オフセット 1024
...
```

スキャッター・ギャザーアクセスがスループットを低下させます。

---

#### PoCX SIMD最適化レイアウト

PoCXは**16ノンスにわたるワード位置**を連続して格納します:

```
キャッシュライン（64バイト）:

Word0_N0 Word0_N1 Word0_N2 ... Word0_N15
Word1_N0 Word1_N1 Word1_N2 ... Word1_N15
...
```

**ASCII図**

```
従来のレイアウト:

Nonce0: [W0][W1][W2][W3]...
Nonce1: [W0][W1][W2][W3]...
Nonce2: [W0][W1][W2][W3]...

PoCXレイアウト:

Word0: [N0][N1][N2][N3]...[N15]
Word1: [N0][N1][N2][N3]...[N15]
Word2: [N0][N1][N2][N3]...[N15]
```

---

#### メモリアクセスの利点

- 1つのキャッシュラインがすべてのSIMDレーンに供給。
- スキャッター・ギャザー操作を排除。
- キャッシュミスを削減。
- ベクトル化計算のための完全に順次なメモリアクセス。
- GPUも16ノンス整列の恩恵を受け、キャッシュ効率を最大化。

---

#### SIMDスケーリング

| SIMD | ベクトル幅* | ノンス | キャッシュラインあたりの処理サイクル |
|------------|---------------|--------|---------------------------------|
| SSE2/AVX | 128ビット | 4 | 4サイクル |
| AVX2 | 256ビット | 8 | 2サイクル |
| AVX512 | 512ビット | 16 | 1サイクル |

\* 整数演算用



## Proof-of-Workスケーリング

### スケーリングレベル
- **X0**: XOR-transposeエンコーディングなしのベースノンス（理論的、マイニングには使用されない）
- **X1**: XOR-transposeベースライン—最初のハードニング形式（1×ワーク）
- **X2**: 2× X1ワーク（2ワープにわたるXOR）
- **X3**: 4× X1ワーク（4ワープにわたるXOR）
- **…**
- **Xn**: 2^(n-1) × X1ワークが埋め込み

### 利点
- **調整可能なPoW難易度**: 高速化するハードウェアに対応するための計算要件を増加
- **形式の長寿命化**: 時間の経過とともにマイニング難易度の柔軟なスケーリングを可能に

### プロットのアップグレード / 後方互換性

ネットワークがPoW（Proof of Work）スケールを1増加させると、既存のプロットは同じ有効プロットサイズを維持するためにアップグレードが必要です。基本的に、アカウントへの同じ貢献を達成するために、プロットファイルに2倍のPoWが必要になります。

良いニュースは、プロットファイル作成時にすでに完了したPoWは失われないことです—既存のファイルに追加のPoWを追加するだけです。再プロットは不要です。

あるいは、アップグレードなしで現在のプロットを使い続けることもできますが、アカウントへの有効サイズ貢献は以前の50%になることに注意してください。マイニングソフトウェアはプロットファイルをオンザフライでスケールできます。

## レガシー形式との比較

| 機能 | POC1 | POC2 | PoCX |
|---------|------|------|------|
| PoW分布 | ❌ 欠陥あり | ✅ 修正済み | ✅ 修正済み |
| XOR-Transpose耐性 | ❌ 脆弱 | ❌ 脆弱 | ✅ 修正済み |
| SIMD最適化 | ❌ なし | ❌ なし | ✅ 高度 |
| GPU最適化 | ❌ なし | ❌ なし | ✅ 最適化済み |
| スケーラブルなPoW | ❌ なし | ❌ なし | ✅ あり |
| シードサポート | ❌ なし | ❌ なし | ✅ あり |

PoCX形式は、容量証明プロット形式の最先端を代表し、すべての既知の脆弱性に対処しながら、最新ハードウェアに対する大幅なパフォーマンス改善を提供します。

## 参考文献とさらなる読み物

- **POC1/POC2の背景**: [Burstcoinマイニング概要](https://www.burstcoin.community/burstcoin-mining/) - 従来の容量証明マイニング形式の包括的ガイド
- **POC2×16研究**: [CIP発表: POC2×16 - 新しい最適化プロット形式](https://www.reddit.com/r/burstcoin/comments/a1qyoq/cip_announcement_poc2x16_a_new_optimized_plot/) - PoCXに着想を与えたオリジナルのSIMD最適化研究
- **Shabalハッシュアルゴリズム**: [The Saphir Project: Shabal, NISTの暗号ハッシュアルゴリズムコンペティションへの提出](https://www.cs.rit.edu/~ark/20090927/Round2Candidates/Shabal.pdf) - PoCマイニングで使用されるShabal256アルゴリズムの技術仕様

---

[← 前へ: はじめに](1-introduction.md) | [目次](index.md) | [次へ: コンセンサスとマイニング →](3-consensus-and-mining.md)
