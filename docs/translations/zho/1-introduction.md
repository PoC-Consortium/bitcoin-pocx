[📘 目录](index.md) | [下一章：绘图格式 →](2-plot-format.md)

---

# 第1章：简介与概述

## 什么是 Bitcoin-PoCX？

Bitcoin-PoCX 是一个 Bitcoin Core 集成项目，添加了**新一代容量证明（PoCX）**共识支持。它保留了 Bitcoin Core 的现有架构，同时引入了一种节能的容量证明挖矿替代方案，完全取代工作量证明。

**核心区别**：这是一条**全新的区块链**，与 Bitcoin 工作量证明不兼容。PoCX 区块在设计上与 PoW 节点不兼容。

---

## 项目身份

- **组织**：容量证明联盟（Proof of Capacity Consortium）
- **项目名称**：Bitcoin-PoCX
- **全称**：集成 PoCX 的 Bitcoin Core
- **状态**：测试网阶段

---

## 什么是容量证明？

容量证明（PoC）是一种共识机制，其中挖矿能力与**磁盘空间**而非算力成正比。矿工预先生成包含加密哈希的大型绘图文件，然后使用这些绘图文件来寻找有效的区块解决方案。

**能源效率**：绘图文件只需生成一次，可无限期重复使用。挖矿消耗的 CPU 资源极少——主要是磁盘 I/O。

**PoCX 增强功能**：
- 修复了 XOR 转置压缩攻击（POC2 中 50% 的时间-内存权衡漏洞）
- 16 nonce 对齐布局，适配现代硬件
- 绘图生成中的可扩展工作量证明（Xn 扩展级别）
- 原生 C++ 实现，直接集成到 Bitcoin Core
- 时间弯曲算法，改善区块时间分布

---

## 架构概述

### 仓库结构

```
bitcoin-pocx/
├── bitcoin/             # Bitcoin Core v30.0 + PoCX 集成
│   └── src/pocx/        # PoCX 实现
├── pocx/                # PoCX 核心框架（子模块，只读）
└── docs/                # 本文档
```

### 集成理念

**最小集成面**：修改集中在 `/src/pocx/` 目录，与 Bitcoin Core 的验证、挖矿和 RPC 层有清晰的接口。

**特性标记**：所有修改均在 `#ifdef ENABLE_POCX` 预处理器保护下。禁用时，Bitcoin Core 正常构建。

**上游兼容性**：通过隔离的集成点保持与 Bitcoin Core 更新的定期同步。

**原生 C++ 实现**：标量加密算法（Shabal256、scoop 计算、压缩）直接集成到 Bitcoin Core 中用于共识验证。

---

## 核心特性

### 1. 完整的共识替换

- **区块结构**：PoCX 特定字段替换 PoW 的 nonce 和难度位
  - 生成签名（确定性挖矿熵）
  - 基础目标值（难度的倒数）
  - PoCX 证明（账户 ID、种子、nonce）
  - 区块签名（证明绘图所有权）

- **验证**：从头部检查到区块连接的 5 阶段验证管道

- **难度调整**：使用最近基础目标值的移动平均进行逐块调整

### 2. 时间弯曲算法

**问题**：传统 PoC 区块时间遵循指数分布，当没有矿工找到好的解决方案时会导致长区块。

**解决方案**：使用立方根将分布从指数分布转换为卡方分布：`Y = scale × (X^(1/3))`。

**效果**：非常好的解决方案会延迟锻造（网络有时间扫描所有磁盘，减少快速区块），较差的解决方案得到改善。平均区块时间保持在 120 秒，长区块减少。

**详情**：[第3章：共识与挖矿](3-consensus-and-mining.md)

### 3. 锻造权委派系统

**功能**：绘图所有者可以将锻造权委派给其他地址，同时保留绘图所有权。

**用例**：
- 矿池挖矿（将绘图分配给矿池地址）
- 冷存储（挖矿密钥与绘图所有权分离）
- 多方挖矿（共享基础设施）

**架构**：仅使用 OP_RETURN 设计——没有特殊的 UTXO，委派关系在链状态数据库中单独跟踪。

**详情**：[第4章：锻造权委派](4-forging-assignments.md)

### 4. 防御性锻造

**问题**：快速时钟可能在 15 秒的未来容差范围内提供时间优势。

**解决方案**：当收到同一高度的竞争区块时，自动检查本地质量。如果更好，立即锻造。

**效果**：消除时钟操纵的激励——快速时钟只有在你已经拥有最佳解决方案时才有帮助。

**详情**：[第5章：时间安全](5-timing-security.md)

### 5. 动态压缩扩展

**经济对齐**：扩展级别要求按指数计划增加（第 4、12、28、60、124 年 = 第 1、3、7、15、31 次减半）。

**效果**：随着区块奖励减少，绘图生成难度增加。保持绘图创建和查找成本之间的安全边际。

**防止**：随着时间推移，更快的硬件造成的容量膨胀。

**详情**：[第6章：网络参数](6-network-parameters.md)

---

## 设计理念

### 代码安全

- 全程采用防御性编程实践
- 验证路径中的全面错误处理
- 无嵌套锁（防止死锁）
- 原子数据库操作（UTXO + 委派一起处理）

### 模块化架构

- Bitcoin Core 基础设施与 PoCX 共识之间的清晰分离
- PoCX 核心框架提供加密原语
- Bitcoin Core 提供验证框架、数据库、网络

### 性能优化

- 快速失败验证排序（廉价检查优先）
- 每次提交单次上下文获取（避免重复获取 cs_main）
- 原子数据库操作保证一致性

### 重组安全

- 委派状态变更的完整撤销数据
- 链顶端变更时重置锻造状态
- 所有验证点的过期检测

---

## PoCX 与工作量证明的区别

| 方面 | Bitcoin (PoW) | Bitcoin-PoCX |
|--------|---------------|--------------|
| **挖矿资源** | 算力（哈希率） | 磁盘空间（容量） |
| **能源消耗** | 高（持续哈希） | 低（仅磁盘 I/O） |
| **挖矿过程** | 找到 hash < target 的 nonce | 找到 deadline < 经过时间的 nonce |
| **难度** | `bits` 字段，每 2016 个区块调整 | `base_target` 字段，每个区块调整 |
| **区块时间** | 约10分钟（指数分布） | 120 秒（时间弯曲，方差减少） |
| **区块奖励** | 50 BTC → 25 → 12.5 → ... | 10 BTC → 5 → 2.5 → ... |
| **硬件** | ASIC（专用设备） | HDD（通用硬件） |
| **挖矿身份** | 匿名 | 绘图所有者或委派者 |

---

## 系统要求

### 节点运行

**与 Bitcoin Core 相同**：
- **CPU**：现代 x86_64 处理器
- **内存**：4-8 GB RAM
- **存储**：新链，目前为空（由于 2 分钟区块和委派数据库，增长速度可能比 Bitcoin 快约 4 倍）
- **网络**：稳定的互联网连接
- **时钟**：建议使用 NTP 同步以获得最佳运行效果

**注意**：节点运行不需要绘图文件。

### 挖矿要求

**挖矿的额外要求**：
- **绘图文件**：使用 `pocx_plotter`（参考实现）预先生成
- **矿工软件**：`pocx_miner`（参考实现）通过 RPC 连接
- **钱包**：带有挖矿地址私钥的 `bitcoind` 或 `bitcoin-qt`。矿池挖矿不需要本地钱包。

---

## 入门指南

### 1. 构建 Bitcoin-PoCX

```bash
# 克隆仓库（包含子模块）
git clone --recursive https://github.com/PoC-Consortium/bitcoin-pocx.git
cd bitcoin-pocx/bitcoin

# 启用 PoCX 构建
cmake -B build -DENABLE_POCX=ON
cmake --build build
```

**详情**：参见仓库根目录的 `CLAUDE.md`

### 2. 运行节点

**仅节点**：
```bash
./build/bin/bitcoind
# 或
./build/bin/bitcoin-qt
```

**用于挖矿**（为外部矿工启用 RPC 访问）：
```bash
./build/bin/bitcoind -miningserver
# 或
./build/bin/bitcoin-qt -server -miningserver
```

**详情**：[第6章：网络参数](6-network-parameters.md)

### 3. 生成绘图文件

使用 `pocx_plotter`（参考实现）生成 PoCX 格式的绘图文件。

**详情**：[第2章：绘图格式](2-plot-format.md)

### 4. 设置挖矿

使用 `pocx_miner`（参考实现）连接到节点的 RPC 接口。

**详情**：[第7章：RPC 参考](7-rpc-reference.md) 和 [第8章：钱包指南](8-wallet-guide.md)

---

## 归属信息

### 绘图格式

基于 POC2 格式（Burstcoin）并进行了增强：
- 修复了安全漏洞（XOR 转置压缩攻击）
- 可扩展的工作量证明
- SIMD 优化布局
- 种子功能

### 源项目

- **pocx_miner**：参考实现，基于 [scavenger](https://github.com/PoC-Consortium/scavenger)
- **pocx_plotter**：参考实现，基于 [engraver](https://github.com/PoC-Consortium/engraver)

**完整归属信息**：[第2章：绘图格式](2-plot-format.md)

---

## 技术规格摘要

- **区块时间**：120 秒（主网），1 秒（regtest）
- **区块奖励**：初始 10 BTC，每 1050000 个区块减半（约 4 年）
- **总供应量**：约 2100 万 BTC（与 Bitcoin 相同）
- **未来容差**：15 秒（接受最多提前 15 秒的区块）
- **时钟警告**：10 秒（警告运营者时间漂移）
- **委派延迟**：30 个区块（约 1 小时）
- **撤销延迟**：720 个区块（约 24 小时）
- **地址格式**：仅 P2WPKH（bech32，pocx1q...）用于 PoCX 挖矿操作和锻造权委派

---

## 代码组织

**Bitcoin Core 修改**：对核心文件的最小修改，使用 `#ifdef ENABLE_POCX` 进行特性标记

**新增 PoCX 实现**：隔离在 `src/pocx/` 目录

---

## 安全考量

### 时间安全

- 15 秒的未来容差防止网络分裂
- 10 秒的警告阈值提醒运营者时钟漂移
- 防御性锻造消除时钟操纵的激励
- 时间弯曲减少时间方差的影响

**详情**：[第5章：时间安全](5-timing-security.md)

### 委派安全

- 仅使用 OP_RETURN 设计（无 UTXO 操纵）
- 交易签名证明绘图所有权
- 激活延迟防止快速状态操纵
- 所有状态变更的重组安全撤销数据

**详情**：[第4章：锻造权委派](4-forging-assignments.md)

### 共识安全

- 签名不包含在区块哈希中（防止可延展性）
- 有界签名大小（防止 DoS）
- 压缩边界验证（防止弱证明）
- 逐块难度调整（响应容量变化）

**详情**：[第3章：共识与挖矿](3-consensus-and-mining.md)

---

## 网络状态

**主网**：尚未启动
**测试网**：可用于测试
**Regtest**：开发功能完整

**创世区块参数**：[第6章：网络参数](6-network-parameters.md)

---

## 下一步

**了解 PoCX**：继续阅读[第2章：绘图格式](2-plot-format.md)，了解绘图文件结构和格式演进。

**挖矿设置**：跳转到[第7章：RPC 参考](7-rpc-reference.md)了解集成详情。

**运行节点**：阅读[第6章：网络参数](6-network-parameters.md)了解配置选项。

---

[📘 目录](index.md) | [下一章：绘图格式 →](2-plot-format.md)
