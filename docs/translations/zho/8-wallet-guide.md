[← 上一章：RPC 参考](7-rpc-reference.md) | [📘 目录](index.md)

---

# 第8章：钱包与图形界面用户指南

Bitcoin-PoCX Qt 钱包和锻造委派管理的完整指南。

---

## 目录

1. [概述](#概述)
2. [货币单位](#货币单位)
3. [锻造委派对话框](#锻造委派对话框)
4. [交易历史](#交易历史)
5. [地址要求](#地址要求)
6. [挖矿集成](#挖矿集成)
7. [故障排除](#故障排除)
8. [安全最佳实践](#安全最佳实践)

---

## 概述

### Bitcoin-PoCX 钱包功能

Bitcoin-PoCX Qt 钱包（`bitcoin-qt`）提供：
- 标准 Bitcoin Core 钱包功能（发送、接收、交易管理）
- **锻造委派管理器**：用于创建/撤销绘图委派的图形界面
- **挖矿服务器模式**：`-miningserver` 标志启用挖矿相关功能
- **交易历史**：委派和撤销交易显示

### 启动钱包

**仅节点**（无挖矿）：
```bash
./build/bin/bitcoin-qt
```

**启用挖矿**（启用委派对话框）：
```bash
./build/bin/bitcoin-qt -server -miningserver
```

**命令行替代方案**：
```bash
./build/bin/bitcoind -miningserver
```

### 挖矿要求

**挖矿操作需要**：
- `-miningserver` 标志
- 带 P2WPKH 地址和私钥的钱包
- 外部绘图工具（`pocx_plotter`）用于绘图生成
- 外部矿工（`pocx_miner`）用于挖矿

**矿池挖矿需要**：
- 创建到矿池地址的锻造委派
- 矿池服务器上不需要钱包（矿池管理密钥）

---

## 货币单位

### 单位显示

Bitcoin-PoCX 使用 **BTCX** 货币单位（不是 BTC）：

| 单位 | 聪 | 显示 |
|------|----------|---------|
| **BTCX** | 100000000 | 1.00000000 BTCX |
| **mBTCX** | 100000 | 1000.00 mBTCX |
| **µBTCX** | 100 | 1000000.00 µBTCX |
| **satoshi** | 1 | 100000000 sat |

**图形界面设置**：首选项 → 显示 → 单位

---

## 锻造委派对话框

### 访问对话框

**菜单**：`钱包 → 锻造委派`
**工具栏**：挖矿图标（仅在使用 `-miningserver` 标志时可见）
**窗口大小**：600×450 像素

### 对话框模式

#### 模式 1：创建委派

**目的**：将锻造权委派给矿池或另一个地址，同时保留绘图所有权。

**用例**：
- 矿池挖矿（委派给矿池地址）
- 冷存储（挖矿密钥与绘图所有权分离）
- 共享基础设施（委派给热钱包）

**要求**：
- 绘图地址（P2WPKH bech32，必须拥有私钥）
- 锻造地址（P2WPKH bech32，与绘图地址不同）
- 钱包已解锁（如果加密）
- 绘图地址有已确认的 UTXO

**步骤**：
1. 选择"创建委派"模式
2. 从下拉框选择绘图地址或手动输入
3. 输入锻造地址（矿池或委派对象）
4. 点击"发送委派"（输入有效时按钮启用）
5. 交易立即广播
6. 委派在 `nForgingAssignmentDelay` 个区块后激活：
   - 主网/测试网：30 个区块（约 1 小时）
   - Regtest：4 个区块（约 4 秒）

**交易费用**：默认 10 倍 `minRelayFee`（可自定义）

**交易结构**：
- 输入：来自绘图地址的 UTXO（证明所有权）
- OP_RETURN 输出：`POCX` 标记 + plot_address + forging_address（46 字节）
- 找零输出：返回钱包

#### 模式 2：撤销委派

**目的**：取消锻造委派，将权利返回给绘图所有者。

**要求**：
- 绘图地址（必须拥有私钥）
- 钱包已解锁（如果加密）
- 绘图地址有已确认的 UTXO

**步骤**：
1. 选择"撤销委派"模式
2. 选择绘图地址
3. 点击"发送撤销"
4. 交易立即广播
5. 撤销在 `nForgingRevocationDelay` 个区块后生效：
   - 主网/测试网：720 个区块（约 24 小时）
   - Regtest：8 个区块（约 8 秒）

**效果**：
- 锻造地址在延迟期内仍可锻造
- 撤销完成后绘图所有者恢复权利
- 之后可以创建新委派

**交易结构**：
- 输入：来自绘图地址的 UTXO（证明所有权）
- OP_RETURN 输出：`XCOP` 标记 + plot_address（26 字节）
- 找零输出：返回钱包

#### 模式 3：检查委派状态

**目的**：查询任何绘图地址的当前委派状态。

**要求**：无（只读，无需钱包）

**步骤**：
1. 选择"检查委派状态"模式
2. 输入绘图地址
3. 点击"检查状态"
4. 状态框显示当前状态和详情

**状态指示器**（颜色编码）：

**灰色 - UNASSIGNED（未委派）**
```
UNASSIGNED - 不存在委派
```

**橙色 - ASSIGNING（委派中）**
```
ASSIGNING - 委派等待激活
锻造地址：pocx1qforger...
创建高度：12000
激活高度：12030（剩余 5 个区块）
```

**绿色 - ASSIGNED（已委派）**
```
ASSIGNED - 活跃委派
锻造地址：pocx1qforger...
创建高度：12000
激活高度：12030
```

**红橙色 - REVOKING（撤销中）**
```
REVOKING - 撤销待处理
锻造地址：pocx1qforger...（仍然激活）
委派创建高度：12000
撤销高度：12300
撤销生效高度：13020（剩余 50 个区块）
```

**红色 - REVOKED（已撤销）**
```
REVOKED - 委派已撤销
之前委派给：pocx1qforger...
委派创建高度：12000
撤销高度：12300
撤销生效高度：13020
```

---

## 交易历史

### 委派交易显示

**类型**："委派"
**图标**：挖矿图标（与挖出的区块相同）

**地址列**：绘图地址（正在委派锻造权的地址）
**金额列**：交易费用（负数，支出交易）
**状态列**：确认数（0-6+）

**详情**（点击时）：
- 交易 ID
- 绘图地址
- 锻造地址（从 OP_RETURN 解析）
- 创建高度
- 激活高度
- 交易费用
- 时间戳

### 撤销交易显示

**类型**："撤销"
**图标**：挖矿图标

**地址列**：绘图地址
**金额列**：交易费用（负数）
**状态列**：确认数

**详情**（点击时）：
- 交易 ID
- 绘图地址
- 撤销高度
- 撤销生效高度
- 交易费用
- 时间戳

### 交易筛选

**可用筛选器**：
- "全部"（默认，包括委派/撤销）
- 日期范围
- 金额范围
- 按地址搜索
- 按交易 ID 搜索
- 按标签搜索（如果地址已标记）

**注意**：委派/撤销交易目前显示在"全部"筛选器下。专用类型筛选器尚未实现。

### 交易排序

**排序顺序**（按类型）：
- 生成（类型 0）
- 接收（类型 1-3）
- 委派（类型 4）
- 撤销（类型 5）
- 发送（类型 6+）

---

## 地址要求

### 仅 P2WPKH（SegWit v0）

**锻造操作需要**：
- Bech32 编码地址（主网以 "pocx1q" 开头，测试网 "tpocx1q"，regtest "rpocx1q"）
- P2WPKH（Pay-to-Witness-Public-Key-Hash）格式
- 20 字节密钥哈希

**不支持**：
- P2PKH（传统，以 "1" 开头）
- P2SH（包装 SegWit，以 "3" 开头）
- P2TR（Taproot，以 "bc1p" 开头）

**原理**：PoCX 区块签名需要特定的 witness v0 格式用于证明验证。

### 地址下拉框筛选

**绘图地址组合框**：
- 自动填充钱包的接收地址
- 筛选掉非 P2WPKH 地址
- 显示格式："标签 (地址)"（如果有标签），否则只显示地址
- 第一项："-- 输入自定义地址 --" 用于手动输入

**手动输入**：
- 输入时验证格式
- 必须是有效的 bech32 P2WPKH
- 如果格式无效则禁用按钮

### 验证错误消息

**对话框错误**：
- "绘图地址必须是 P2WPKH（bech32）"
- "锻造地址必须是 P2WPKH（bech32）"
- "地址格式无效"
- "绘图地址没有可用的币。无法证明所有权。"
- "无法使用仅观察钱包创建交易"
- "钱包不可用"
- "钱包已锁定"（来自 RPC）

---

## 挖矿集成

### 设置要求

**节点配置**：
```bash
# bitcoin.conf
miningserver=1
server=1
```

**钱包要求**：
- 用于绘图所有权的 P2WPKH 地址
- 用于挖矿的私钥（或使用委派时的锻造地址）
- 用于创建交易的已确认 UTXO

**外部工具**：
- `pocx_plotter`：生成绘图文件
- `pocx_miner`：扫描绘图并提交 nonce

### 工作流程

#### 单独挖矿

1. **生成绘图文件**：
   ```bash
   pocx_plotter --account <plot_address_hash160> --seed <32_bytes> --nonces <count>
   ```

2. **启动节点**（带挖矿服务器）：
   ```bash
   bitcoin-qt -server -miningserver
   ```

3. **配置矿工**：
   - 指向节点 RPC 端点
   - 指定绘图文件目录
   - 配置账户 ID（来自绘图地址）

4. **开始挖矿**：
   ```bash
   pocx_miner --rpc-url http://localhost:8332 --plots /path/to/plots
   ```

5. **监控**：
   - 矿工每个区块调用 `get_mining_info`
   - 扫描绘图寻找最佳截止时间
   - 找到解决方案时调用 `submit_nonce`
   - 节点验证并自动锻造区块

#### 矿池挖矿

1. **生成绘图文件**（与单独挖矿相同）

2. **创建锻造委派**：
   - 打开锻造委派对话框
   - 选择绘图地址
   - 输入矿池的锻造地址
   - 点击"发送委派"
   - 等待激活延迟（测试网 30 个区块）

3. **配置矿工**：
   - 指向**矿池**端点（不是本地节点）
   - 矿池处理到链的 `submit_nonce`

4. **矿池操作**：
   - 矿池钱包有锻造地址私钥
   - 矿池验证矿工的提交
   - 矿池调用 `submit_nonce` 到区块链
   - 矿池根据矿池策略分配奖励

### Coinbase 奖励

**无委派**：
- Coinbase 直接支付给绘图所有者地址
- 在绘图地址查看余额

**有委派**：
- Coinbase 支付给锻造地址
- 矿池收到奖励
- 矿工从矿池获得份额

**奖励计划**：
- 初始：每区块 10 BTCX
- 减半：每 1050000 个区块（约 4 年）
- 计划：10 → 5 → 2.5 → 1.25 → ...

---

## 故障排除

### 常见问题

#### "钱包没有绘图地址的私钥"

**原因**：钱包不拥有该地址
**解决方案**：
- 通过 `importprivkey` RPC 导入私钥
- 或使用钱包拥有的其他绘图地址

#### "此绘图已存在委派"

**原因**：绘图已委派给另一个地址
**解决方案**：
1. 撤销现有委派
2. 等待撤销延迟（测试网 720 个区块）
3. 创建新委派

#### "地址格式不支持"

**原因**：地址不是 P2WPKH bech32
**解决方案**：
- 使用以 "pocx1q"（主网）或 "tpocx1q"（测试网）开头的地址
- 如需要生成新地址：`getnewaddress "" "bech32"`

#### "交易费用太低"

**原因**：网络内存池拥堵或费用太低无法中继
**解决方案**：
- 增加费率参数
- 等待内存池清空

#### "委派尚未激活"

**原因**：激活延迟尚未结束
**解决方案**：
- 检查状态：距离激活还剩多少区块
- 等待延迟期完成

#### "绘图地址没有可用的币"

**原因**：绘图地址没有已确认的 UTXO
**解决方案**：
1. 向绘图地址发送资金
2. 等待 1 个确认
3. 重试创建委派

#### "无法使用仅观察钱包创建交易"

**原因**：钱包导入了地址但没有私钥
**解决方案**：导入完整私钥，而不只是地址

#### "锻造委派标签不可见"

**原因**：节点启动时没有 `-miningserver` 标志
**解决方案**：使用 `bitcoin-qt -server -miningserver` 重启

### 调试步骤

1. **检查钱包状态**：
   ```bash
   bitcoin-cli getwalletinfo
   ```

2. **验证地址所有权**：
   ```bash
   bitcoin-cli getaddressinfo pocx1qplot...
   # 检查："iswatchonly": false, "ismine": true
   ```

3. **检查委派状态**：
   ```bash
   bitcoin-cli get_assignment pocx1qplot...
   ```

4. **查看最近交易**：
   ```bash
   bitcoin-cli listtransactions "*" 10
   ```

5. **检查节点同步**：
   ```bash
   bitcoin-cli getblockchaininfo
   # 验证：blocks == headers（完全同步）
   ```

---

## 安全最佳实践

### 绘图地址安全

**密钥管理**：
- 安全存储绘图地址私钥
- 委派交易通过签名证明所有权
- 只有绘图所有者可以创建/撤销委派

**备份**：
- 定期备份钱包（`dumpwallet` 或 `backupwallet`）
- 将 wallet.dat 存储在安全位置
- 如果使用 HD 钱包，记录恢复短语

### 锻造地址委派

**安全模型**：
- 锻造地址接收区块奖励
- 锻造地址可以签名区块（挖矿）
- 锻造地址**不能**修改或撤销委派
- 绘图所有者保留完全控制权

**用例**：
- **热钱包委派**：绘图密钥在冷存储，锻造密钥在热钱包用于挖矿
- **矿池挖矿**：委派给矿池，保留绘图所有权
- **共享基础设施**：多个矿工，一个锻造地址

### 网络时间同步

**重要性**：
- PoCX 共识需要准确的时间
- 时钟漂移 >10 秒触发警告
- 时钟漂移 >15 秒阻止挖矿

**解决方案**：
- 保持系统时钟与 NTP 同步
- 监控：`bitcoin-cli getnetworkinfo` 查看时间偏移警告
- 使用可靠的 NTP 服务器

### 委派延迟

**激活延迟**（测试网 30 个区块）：
- 防止链分叉期间的快速重新分配
- 允许网络达成共识
- 无法绕过

**撤销延迟**（测试网 720 个区块）：
- 为矿池提供稳定性
- 防止委派"恶意"攻击
- 锻造地址在延迟期内保持激活

### 钱包加密

**启用加密**：
```bash
bitcoin-cli encryptwallet "your_passphrase"
```

**解锁用于交易**：
```bash
bitcoin-cli walletpassphrase "your_passphrase" 300
```

**最佳实践**：
- 使用强密码短语（20+ 字符）
- 不要以明文存储密码短语
- 创建委派后锁定钱包

---

## 代码参考

**锻造委派对话框**：`src/qt/forgingassignmentdialog.cpp`、`src/qt/forgingassignmentdialog.h`
**交易显示**：`src/qt/transactionrecord.cpp`、`src/qt/transactiontablemodel.cpp`
**交易解析**：`src/qt/transactionrecord.cpp`
**钱包集成**：`src/pocx/assignments/transactions.cpp`
**委派 RPC**：`src/pocx/rpc/assignments_wallet.cpp`
**图形界面主程序**：`src/qt/bitcoingui.cpp`

---

## 交叉参考

相关章节：
- [第3章：共识与挖矿](3-consensus-and-mining.md) - 挖矿流程
- [第4章：锻造权委派](4-forging-assignments.md) - 委派架构
- [第6章：网络参数](6-network-parameters.md) - 委派延迟值
- [第7章：RPC 参考](7-rpc-reference.md) - RPC 命令详情

---

[← 上一章：RPC 参考](7-rpc-reference.md) | [📘 目录](index.md)
