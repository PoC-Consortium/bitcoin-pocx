[โ ุงูุณุงุจู: ุงูุฅุฌูุงุน ูุงูุชุนุฏูู](3-consensus-and-mining.md) | [๐ ุฌุฏูู ุงููุญุชููุงุช](index.md) | [ุงูุชุงูู: ูุฒุงููุฉ ุงูููุช โ](5-timing-security.md)

---

# ุงููุตู ุงูุฑุงุจุน: ูุธุงู ุชุนููู ุตูุงุบุฉ PoCX

## ุงูููุฎุต ุงูุชูููุฐู

ูุตู ูุฐุง ุงููุณุชูุฏ ูุธุงู ุชุนููู ุตูุงุบุฉ PoCX **ุงููููููุฐ** ุจุงุณุชุฎุฏุงู ุจููุฉ OP_RETURN ููุท. ูููููู ุงููุธุงู ูุงููู ุงูุฑุณู ูู ุชูููุถ ุญููู ุงูุตูุงุบุฉ ูุนูุงููู ูููุตูุฉ ูู ุฎูุงู ูุนุงููุงุช ุนูู ุงูุณูุณูุฉุ ูุน ุณูุงูุฉ ูุงููุฉ ูู ุฅุนุงุฏุฉ ุงูุชูุธูู ูุนูููุงุช ูุงุนุฏุฉ ุจูุงูุงุช ุฐุฑูุฉ.

**ุงูุญุงูุฉ:** โ ููููุฐ ุจุงููุงูู ูุนุงูู

## ููุณูุฉ ุงูุชุตููู ุงูุฃุณุงุณูุฉ

**ุงููุจุฏุฃ ุงูุฑุฆูุณู:** ุงูุชุนูููุงุช ูู ุฃุฐููุงุชุ ูููุณุช ุฃุตููุงู

- ูุง UTXOs ุฎุงุตุฉ ููุชุชุจุน ุฃู ุงูุฅููุงู
- ุญุงูุฉ ุงูุชุนููู ููุฎุฒููุฉ ุจุดูู ูููุตู ุนู ูุฌููุนุฉ UTXO
- ุงูููููุฉ ุชูุซุจุช ุจุชูููุน ุงููุนุงููุฉุ ูููุณ ุฅููุงู UTXO
- ุชุชุจุน ุงูุณุฌู ุงููุงูู ููุณุงุฑ ุชุฏููู ูุงูู
- ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุจูุงูุงุช ุฐุฑูุฉ ูู ุฎูุงู ูุชุงุจุงุช ุฏูุนูุฉ LevelDB

## ูููู ุงููุนุงููุฉ

### ุตูุบุฉ ูุนุงููุฉ ุงูุชุนููู

```
ุงููุฏุฎูุงุช:
  [0]: ุฃู UTXO ูุชุญูู ููู ูุงูู ุงูุฑุณู (ูุซุจุช ุงูููููุฉ + ูุฏูุน ุงูุฑุณูู)
       ูุฌุจ ุฃู ูููู ููููุนุงู ุจุงูููุชุงุญ ุงูุฎุงุต ููุงูู ุงูุฑุณู
  [1+]: ูุฏุฎูุงุช ุฅุถุงููุฉ ุงุฎุชูุงุฑูุฉ ูุชุบุทูุฉ ุงูุฑุณูู

ุงููุฎุฑุฌุงุช:
  [0]: OP_RETURN (ุนูุงูุฉ POCX + ุนููุงู ุงูุฑุณู + ุนููุงู ุงูุตูุงุบุฉ)
       ุงูุตูุบุฉ: OP_RETURN <0x2c> "POCX" <plot_addr_20> <forge_addr_20>
       ุงูุญุฌู: 46 ุจุงูุช ุฅุฌูุงูู (1 ุจุงูุช OP_RETURN + 1 ุจุงูุช ุงูุทูู + 44 ุจุงูุช ุจูุงูุงุช)
       ุงููููุฉ: 0 BTC (ุบูุฑ ูุงุจู ููุฅููุงูุ ูุง ููุถุงู ููุฌููุนุฉ UTXO)

  [1]: ุงูุชุบููุฑ ูููุณุชุฎุฏู (ุงุฎุชูุงุฑูุ P2WPKH ููุงุณู)
```

**ุงูุชูููุฐ:** `src/pocx/assignments/opcodes.cpp:25-52`

### ุตูุบุฉ ูุนุงููุฉ ุงูุฅูุบุงุก

```
ุงููุฏุฎูุงุช:
  [0]: ุฃู UTXO ูุชุญูู ููู ูุงูู ุงูุฑุณู (ูุซุจุช ุงูููููุฉ + ูุฏูุน ุงูุฑุณูู)
       ูุฌุจ ุฃู ูููู ููููุนุงู ุจุงูููุชุงุญ ุงูุฎุงุต ููุงูู ุงูุฑุณู
  [1+]: ูุฏุฎูุงุช ุฅุถุงููุฉ ุงุฎุชูุงุฑูุฉ ูุชุบุทูุฉ ุงูุฑุณูู

ุงููุฎุฑุฌุงุช:
  [0]: OP_RETURN (ุนูุงูุฉ XCOP + ุนููุงู ุงูุฑุณู)
       ุงูุตูุบุฉ: OP_RETURN <0x18> "XCOP" <plot_addr_20>
       ุงูุญุฌู: 26 ุจุงูุช ุฅุฌูุงูู (1 ุจุงูุช OP_RETURN + 1 ุจุงูุช ุงูุทูู + 24 ุจุงูุช ุจูุงูุงุช)
       ุงููููุฉ: 0 BTC (ุบูุฑ ูุงุจู ููุฅููุงูุ ูุง ููุถุงู ููุฌููุนุฉ UTXO)

  [1]: ุงูุชุบููุฑ ูููุณุชุฎุฏู (ุงุฎุชูุงุฑูุ P2WPKH ููุงุณู)
```

**ุงูุชูููุฐ:** `src/pocx/assignments/opcodes.cpp:54-77`

### ุงูุนูุงูุงุช

- **ุนูุงูุฉ ุงูุชุนููู:** `POCX` (0x50, 0x4F, 0x43, 0x58) = "Proof of Capacity neXt"
- **ุนูุงูุฉ ุงูุฅูุบุงุก:** `XCOP` (0x58, 0x43, 0x4F, 0x50) = "eXit Capacity OPeration"

**ุงูุชูููุฐ:** `src/pocx/assignments/opcodes.cpp:15-19`

### ุฎุตุงุฆุต ุงููุนุงููุฉ ุงูุฑุฆูุณูุฉ

- ูุนุงููุงุช Bitcoin ููุงุณูุฉ (ูุง ุชุบููุฑุงุช ูู ุงูุจุฑูุชูููู)
- ูุฎุฑุฌุงุช OP_RETURN ุบูุฑ ูุงุจูุฉ ููุฅููุงู ุจุดูู ููุซุจุช (ูุง ุชูุถุงู ููุฌููุนุฉ UTXO ุฃุจุฏุงู)
- ููููุฉ ุงูุฑุณู ุชูุซุจุช ุจุงูุชูููุน ุนูู input[0] ูู ุนููุงู ุงูุฑุณู
- ุชูููุฉ ููุฎูุถุฉ (~200 ุจุงูุชุ ุนุงุฏุฉ <0.0001 BTC ุฑุณูู)
- ุงููุญูุธุฉ ุชุฎุชุงุฑ ุชููุงุฆูุงู ุฃูุจุฑ UTXO ูู ุนููุงู ุงูุฑุณู ูุฅุซุจุงุช ุงูููููุฉ

## ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ูููู ุงูุชุฎุฒูู

ุฌููุน ุจูุงูุงุช ุงูุชุนููู ููุฎุฒููุฉ ูู ููุณ ูุงุนุฏุฉ ุจูุงูุงุช LevelDB ูุซู ูุฌููุนุฉ UTXO (`chainstate/`)ุ ููู ุจุจุงุฏุฆุงุช ููุงุชูุญ ูููุตูุฉ:

```
chainstate/ LevelDB:
โโ ูุฌููุนุฉ UTXO (ููุงุณู Bitcoin Core)
โ  โโ ุจุงุฏุฆุฉ 'C': COutPoint โ Coin
โ
โโ ุญุงูุฉ ุงูุชุนููู (ุฅุถุงูุงุช PoCX)
   โโ ุจุงุฏุฆุฉ 'A': (plot_address, assignment_txid) โ ForgingAssignment
       โโ ุงูุณุฌู ุงููุงูู: ุฌููุน ุงูุชุนูููุงุช ููู ุฑุณู ุนุจุฑ ุงูููุช
```

**ุงูุชูููุฐ:** `src/txdb.cpp:237-348`

### ูููู ForgingAssignment

```cpp
struct ForgingAssignment {
    // ุงููููุฉ
    std::array<uint8_t, 20> plotAddress;      // ูุงูู ุงูุฑุณู (ุชุฌุฒุฆุฉ P2WPKH 20 ุจุงูุช)
    std::array<uint8_t, 20> forgingAddress;   // ุญุงูู ุญููู ุงูุตูุงุบุฉ (ุชุฌุฒุฆุฉ P2WPKH 20 ุจุงูุช)

    // ุฏูุฑุฉ ุญูุงุฉ ุงูุชุนููู
    uint256 assignment_txid;                   // ุงููุนุงููุฉ ุงูุชู ุฃูุดุฃุช ุงูุชุนููู
    int assignment_height;                     // ุงุฑุชูุงุน ุงููุชูุฉ ุนูุฏ ุงูุฅูุดุงุก
    int assignment_effective_height;           // ุนูุฏูุง ูุตุจุญ ูุดุทุงู (ุงูุงุฑุชูุงุน + ุงูุชุฃุฎูุฑ)

    // ุฏูุฑุฉ ุญูุงุฉ ุงูุฅูุบุงุก
    bool revoked;                              // ูู ุชู ุฅูุบุงุก ูุฐุงุ
    uint256 revocation_txid;                   // ุงููุนุงููุฉ ุงูุชู ุฃูุบุชู
    int revocation_height;                     // ุงุฑุชูุงุน ุงููุชูุฉ ุนูุฏ ุงูุฅูุบุงุก
    int revocation_effective_height;           // ุนูุฏูุง ูุตุจุญ ุงูุฅูุบุงุก ูุนุงูุงู (ุงูุงุฑุชูุงุน + ุงูุชุฃุฎูุฑ)

    // ุทุฑู ุงุณุชุนูุงู ุงูุญุงูุฉ
    ForgingState GetStateAtHeight(int height) const;
    bool IsActiveAtHeight(int height) const;
};
```

**ุงูุชูููุฐ:** `src/coins.h:111-178`

### ุญุงูุงุช ุงูุชุนููู

```cpp
enum class ForgingState : uint8_t {
    UNASSIGNED = 0,  // ูุง ุชุนููู ููุฌูุฏ
    ASSIGNING = 1,   // ุงูุชุนููู ุฃููุดุฆุ ูู ุงูุชุธุงุฑ ุชุฃุฎูุฑ ุงูุชูุนูู
    ASSIGNED = 2,    // ุงูุชุนููู ูุดุทุ ุงูุตูุงุบุฉ ูุณููุญุฉ
    REVOKING = 3,    // ูููุบูุ ููู ูุง ูุฒุงู ูุดุทุงู ุฎูุงู ูุชุฑุฉ ุงูุชุฃุฎูุฑ
    REVOKED = 4      // ูููุบู ุจุงููุงููุ ูู ูุนุฏ ูุดุทุงู
};
```

**ุงูุชูููุฐ:** `src/coins.h:98-104`

### ููุงุชูุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช

```cpp
// ููุชุงุญ ุงูุณุฌู: ูุฎุฒู ุณุฌู ุงูุชุนููู ุงููุงูู
// ุตูุบุฉ ุงูููุชุงุญ: (prefix, plotAddress, assignment_height, assignment_txid)
struct AssignmentHistoryKey {
    uint8_t prefix;                       // DB_ASSIGNMENT_HISTORY = 'A'
    std::array<uint8_t, 20> plotAddress;  // ุนููุงู ุงูุฑุณู (20 ุจุงูุช)
    int assignment_height;                // ุงูุงุฑุชูุงุน ูุชุญุณูู ุงููุฑุฒ
    uint256 assignment_txid;              // ูุนุฑู ุงููุนุงููุฉ
};
```

**ุงูุชูููุฐ:** `src/txdb.cpp:245-262`

### ุชุชุจุน ุงูุณุฌู

- ูู ุชุนููู ููุฎุฒูู ุจุดูู ุฏุงุฆู (ูุง ููุญุฐู ุฅูุง ูู ุฅุนุงุฏุฉ ุงูุชูุธูู)
- ุชูุชุชุจูุน ุชุนูููุงุช ูุชุนุฏุฏุฉ ููู ุฑุณู ุนุจุฑ ุงูููุช
- ูููููู ูุณุงุฑ ุงูุชุฏููู ุงููุงูู ูุงุณุชุนูุงูุงุช ุงูุญุงูุฉ ุงูุชุงุฑูุฎูุฉ
- ุงูุชุนูููุงุช ุงููููุบุงุฉ ุชุจูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน `revoked=true`

## ูุนุงูุฌุฉ ุงููุชูุฉ

### ุชูุงูู ConnectBlock

ุชูุนุงูุฌ OP_RETURNs ููุชุนููู ูุงูุฅูุบุงุก ุฃุซูุงุก ุงุชุตุงู ุงููุชูุฉ ูู `validation.cpp`:

```cpp
// ุงููููุน: ุจุนุฏ ุงูุชุญูู ูู ุงูุณูุฑูุจุชุ ูุจู UpdateCoins
#ifdef ENABLE_POCX
for (const auto& tx : block.vtx) {
    for (const CTxOut& output : tx.vout) {
        if (IsAssignmentOpReturn(output)) {
            // ุชุญููู ุจูุงูุงุช OP_RETURN
            auto [plot_addr, forge_addr] = ParseAssignmentOpReturn(output);

            // ุงูุชุญูู ูู ุงูููููุฉ (ูุฌุจ ุฃู ุชููู ุงููุนุงููุฉ ููููุนุฉ ูู ูุงูู ุงูุฑุณู)
            if (!VerifyPlotOwnership(tx, plot_addr, view))
                return state.Invalid("bad-assignment-ownership");

            // ูุญุต ุญุงูุฉ ุงูุฑุณู (ูุฌุจ ุฃู ูููู UNASSIGNED ุฃู REVOKED)
            ForgingState state = GetPlotForgingState(plot_addr, height, view);
            if (state != UNASSIGNED && state != REVOKED)
                return state.Invalid("plot-not-available-for-assignment");

            // ุฅูุดุงุก ุชุนููู ุฌุฏูุฏ
            int activation_height = height + consensus.nForgingAssignmentDelay;
            ForgingAssignment assignment(plot_addr, forge_addr, tx.GetHash(),
                                       height, activation_height);

            view.AddForgingAssignment(assignment);

            // ุชุฎุฒูู ุจูุงูุงุช ุงูุชุฑุงุฌุน
            blockundo.vforgingundo.emplace_back(UndoType::ADDED, assignment);
        }
        else if (IsRevocationOpReturn(output)) {
            // ุชุญููู ุจูุงูุงุช OP_RETURN
            auto plot_addr = ParseRevocationOpReturn(output);

            // ุงูุชุญูู ูู ุงูููููุฉ
            if (!VerifyPlotOwnership(tx, plot_addr, view))
                return state.Invalid("bad-revocation-ownership");

            // ุงูุญุตูู ุนูู ุงูุชุนููู ุงูุญุงูู
            auto existing = view.GetForgingAssignment(plot_addr, height);
            if (!existing || existing->revoked)
                return state.Invalid("no-assignment-to-revoke");

            // ุชุฎุฒูู ุงูุญุงูุฉ ุงููุฏููุฉ ููุชุฑุงุฌุน
            blockundo.vforgingundo.emplace_back(UndoType::REVOKED, *existing);

            // ูุถุน ุนูุงูุฉ ููููุบู
            ForgingAssignment revoked = *existing;
            revoked.revoked = true;
            revoked.revocation_txid = tx.GetHash();
            revoked.revocation_height = height;
            revoked.revocation_effective_height = height + consensus.nForgingRevocationDelay;

            view.UpdateForgingAssignment(revoked);
        }
    }
}
#endif

// UpdateCoins ูุณุชูุฑ ุจุดูู ุทุจูุนู (ูุชุฎุทู ูุฎุฑุฌุงุช OP_RETURN ุชููุงุฆูุงู)
```

**ุงูุชูููุฐ:** `src/validation.cpp:2775-2878`

### ุงูุชุญูู ูู ุงูููููุฉ

```cpp
bool VerifyPlotOwnership(const CTransaction& tx,
                        const std::array<uint8_t, 20>& plotAddress,
                        const CCoinsViewCache& view)
{
    // ุงูุชุญูู ูู ุฃู ูุฏุฎู ูุงุญุฏ ุนูู ุงูุฃูู ููููุน ูู ูุงูู ุงูุฑุณู
    for (const auto& input : tx.vin) {
        Coin coin = view.GetCoin(input.prevout);
        if (!coin) continue;

        // ุงุณุชุฎุฑุงุฌ ุงููุฌูุฉ
        CTxDestination dest;
        if (!ExtractDestination(coin.out.scriptPubKey, dest)) continue;

        // ุงูุชุญูู ุฅุฐุง ูุงู P2WPKH ูุนููุงู ุงูุฑุณู
        if (auto* witness_addr = std::get_if<WitnessV0KeyHash>(&dest)) {
            if (std::equal(witness_addr->begin(), witness_addr->end(),
                          plotAddress.begin())) {
                // Bitcoin Core ุชุญูู ุจุงููุนู ูู ุงูุชูููุน
                return true;
            }
        }
    }
    return false;
}
```

**ุงูุชูููุฐ:** `src/pocx/assignments/opcodes.cpp:217-256`

### ุชุฃุฎูุฑุงุช ุงูุชูุนูู

ุงูุชุนูููุงุช ูุงูุฅูุบุงุกุงุช ููุง ุชุฃุฎูุฑุงุช ุชูุนูู ูุงุจูุฉ ููุชูููู ูููุน ูุฌูุงุช ุฅุนุงุฏุฉ ุงูุชูุธูู:

```cpp
// ูุนููุงุช ุงูุฅุฌูุงุน (ูุงุจูุฉ ููุชูููู ููู ุดุจูุฉ)
// ูุซุงู: 30 ูุชูุฉ = ~1 ุณุงุนุฉ ูุน ููุช ูุชูุฉ 2 ุฏูููุฉ
consensus.nForgingAssignmentDelay;   // ุชุฃุฎูุฑ ุชูุนูู ุงูุชุนููู
consensus.nForgingRevocationDelay;   // ุชุฃุฎูุฑ ุชูุนูู ุงูุฅูุบุงุก
```

**ุงูุชูุงูุงุช ุงูุญุงูุฉ:**
- ุงูุชุนููู: `UNASSIGNED โ ASSIGNING (ุชุฃุฎูุฑ) โ ASSIGNED`
- ุงูุฅูุบุงุก: `ASSIGNED โ REVOKING (ุชุฃุฎูุฑ) โ REVOKED`

**ุงูุชูููุฐ:** `src/consensus/params.h`ุ `src/kernel/chainparams.cpp`

## ุงูุชุญูู ูู Mempool

ุชูุญูู ูุนุงููุงุช ุงูุชุนููู ูุงูุฅูุบุงุก ุนูุฏ ูุจูู mempool ูุฑูุถ ุงููุนุงููุงุช ุบูุฑ ุงูุตุงูุญุฉ ูุจู ูุดุฑ ุงูุดุจูุฉ.

### ูุญูุตุงุช ูุณุชูู ุงููุนุงููุฉ (CheckTransaction)

ุชููููุฐ ูู `src/consensus/tx_check.cpp` ุจุฏูู ูุตูู ูุญุงูุฉ ุงูุณูุณูุฉ:

1. **ุญุฏ ุฃูุตู OP_RETURN POCX ูุงุญุฏ:** ุงููุนุงููุฉ ูุง ูููู ุฃู ุชุญุชูู ุนูุงูุงุช POCX/XCOP ูุชุนุฏุฏุฉ

**ุงูุชูููุฐ:** `src/consensus/tx_check.cpp:63-77`

### ูุญูุตุงุช ูุจูู Mempool (PreChecks)

ุชููููุฐ ูู `src/validation.cpp` ูุน ูุตูู ูุงูู ูุญุงูุฉ ุงูุณูุณูุฉ ู mempool:

#### ุงูุชุญูู ูู ุงูุชุนููู

1. **ููููุฉ ุงูุฑุณู:** ูุฌุจ ุฃู ุชููู ุงููุนุงููุฉ ููููุนุฉ ูู ูุงูู ุงูุฑุณู
2. **ุญุงูุฉ ุงูุฑุณู:** ูุฌุจ ุฃู ูููู ุงูุฑุณู ูู ุญุงูุฉ UNASSIGNED (0) ุฃู REVOKED (4)
3. **ุชุนุงุฑุถุงุช Mempool:** ูุง ุชุนููู ุขุฎุฑ ููุฐุง ุงูุฑุณู ูู mempool (ุฃูู ูุดุงูุฏุฉ ูููุฒ)

#### ุงูุชุญูู ูู ุงูุฅูุบุงุก

1. **ููููุฉ ุงูุฑุณู:** ูุฌุจ ุฃู ุชููู ุงููุนุงููุฉ ููููุนุฉ ูู ูุงูู ุงูุฑุณู
2. **ุชุนููู ูุดุท:** ูุฌุจ ุฃู ูููู ุงูุฑุณู ูู ุญุงูุฉ ASSIGNED (2) ููุท
3. **ุชุนุงุฑุถุงุช Mempool:** ูุง ุฅูุบุงุก ุขุฎุฑ ููุฐุง ุงูุฑุณู ูู mempool

**ุงูุชูููุฐ:** `src/validation.cpp:898-993`

### ุชุฏูู ุงูุชุญูู

```
ุจุซ ุงููุนุงููุฉ
       โ
CheckTransaction() [tx_check.cpp]
  โ ุญุฏ ุฃูุตู OP_RETURN POCX ูุงุญุฏ
       โ
MemPoolAccept::PreChecks() [validation.cpp]
  โ ุงูุชุญูู ูู ููููุฉ ุงูุฑุณู
  โ ูุญุต ุญุงูุฉ ุงูุชุนููู
  โ ูุญุต ุชุนุงุฑุถุงุช mempool
       โ
   ุตุงูุญ โ ูุจูู ูู Mempool
   ุบูุฑ ุตุงูุญ โ ุฑูุถ (ูุง ูุดุฑ)
       โ
ุชุนุฏูู ุงููุชูุฉ
       โ
ConnectBlock() [validation.cpp]
  โ ุฅุนุงุฏุฉ ุงูุชุญูู ูู ุฌููุน ุงููุญูุตุงุช (ุฏูุงุน ูุชุนูู)
  โ ุชุทุจูู ุชุบููุฑุงุช ุงูุญุงูุฉ
  โ ุชุณุฌูู ูุนูููุงุช ุงูุชุฑุงุฌุน
```

### ุงูุฏูุงุน ุงููุชุนูู

ุฌููุน ูุญูุตุงุช ุงูุชุญูู ูู mempool ุชูุนุงุฏ ุชูููุฐูุง ุฃุซูุงุก `ConnectBlock()` ููุญูุงูุฉ ูู:
- ูุฌูุงุช ุชุฌุงูุฒ mempool
- ูุชู ุบูุฑ ุตุงูุญุฉ ูู ููุนุฏูููู ุฎุจูุซูู
- ุงูุญุงูุงุช ุงูุญุงูุฉ ุฃุซูุงุก ุณููุงุฑูููุงุช ุฅุนุงุฏุฉ ุงูุชูุธูู

ุงูุชุญูู ูู ุงููุชูุฉ ูุจูู ููุซููุงู ููุฅุฌูุงุน.

## ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฐุฑูุฉ

### ุจููุฉ ุซูุงุซูุฉ ุงูุทุจูุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   CCoinsViewCache (ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช)        โ  โ ุชุบููุฑุงุช ุงูุชุนููู ุชูุชุชุจูุน ูู ุงูุฐุงูุฑุฉ
โ   - Coins: cacheCoins                   โ
โ   - Assignments: pendingAssignments     โ
โ   - ุชุชุจุน ุงูุชุบููุฑุงุช: dirtyPlots          โ
โ   - ุงูุญุฐู: deletedAssignments       โ
โ   - ุชุชุจุน ุงูุฐุงูุฑุฉ: cachedAssignmentsUsage โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ Flush()
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   CCoinsViewDB (ุทุจูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช)         โ  โ ูุชุงุจุฉ ุฐุฑูุฉ ูุงุญุฏุฉ
โ   - BatchWrite(): UTXOs + Assignments   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ WriteBatch()
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   LevelDB (ุชุฎุฒูู ุงููุฑุต)                โ  โ ุถูุงูุงุช ACID
โ   - ูุนุงููุฉ ุฐุฑูุฉ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุนูููุฉ Flush

ุนูุฏูุง ููุณุชุฏุนู `view.Flush()` ุฃุซูุงุก ุงุชุตุงู ุงููุชูุฉ:

```cpp
bool CCoinsViewCache::Flush() {
    // 1. ูุชุงุจุฉ ุชุบููุฑุงุช ุงูุนููุฉ ูููุงุนุฏุฉ
    auto cursor = CoinsViewCacheCursor(/*...*/, /*will_erase=*/true);
    bool fOk = base->BatchWrite(cursor, hashBlock);

    // 2. ูุชุงุจุฉ ุชุบููุฑุงุช ุงูุชุนููู ุจุดูู ุฐุฑู
    if (fOk && !dirtyPlots.empty()) {
        // ุฌูุน ุงูุชุนูููุงุช ุงูููุชุบููุฑุฉ
        ForgingAssignmentsMap assignmentsToWrite;
        PlotAddressAssignmentMap currentToWrite;  // ูุงุฑุบ - ุบูุฑ ูุณุชุฎุฏู

        for (const auto& plotAddr : dirtyPlots) {
            auto it = pendingAssignments.find(plotAddr);
            if (it != pendingAssignments.end()) {
                for (const auto& assignment : it->second) {
                    assignmentsToWrite[{plotAddr, assignment}] = assignment;
                }
            }
        }

        // ุงููุชุงุจุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช
        fOk = base->BatchWriteAssignments(assignmentsToWrite, currentToWrite,
                                         deletedAssignments);

        if (fOk) {
            // ูุณุญ ุงูุชุชุจุน
            dirtyPlots.clear();
            deletedAssignments.clear();
        }
    }

    if (fOk) {
        cacheCoins.clear();  // ุชุญุฑูุฑ ุงูุฐุงูุฑุฉ
        pendingAssignments.clear();
        cachedAssignmentsUsage = 0;
    }

    return fOk;
}
```

**ุงูุชูููุฐ:** `src/coins.cpp:278-315`

### ูุชุงุจุฉ ุฏูุนุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช

```cpp
bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256& hashBlock) {
    CDBBatch batch(*m_db);  // ุฏูุนุฉ LevelDB ูุงุญุฏุฉ

    // 1. ูุถุน ุนูุงูุฉ ุญุงูุฉ ุงูุงูุชูุงู
    batch.Write(DB_HEAD_BLOCKS, Vector(hashBlock, old_tip));

    // 2. ูุชุงุจุฉ ุฌููุน ุชุบููุฑุงุช ุงูุนููุฉ
    for (auto it = cursor.Begin(); it != cursor.End(); it = cursor.NextAndMaybeErase(*it)) {
        if (it->second.coin.IsSpent())
            batch.Erase(CoinKey(it->first));
        else
            batch.Write(CoinKey(it->first), it->second.coin);
    }

    // 3. ูุถุน ุนูุงูุฉ ุญุงูุฉ ูุชุณูุฉ
    batch.Write(DB_BEST_BLOCK, hashBlock);

    // 4. ุฅูุชุฒุงู ุฐุฑู
    bool ret = m_db->WriteBatch(batch);

    return ret;
}

// ุงูุชุนูููุงุช ุชููุชุจ ุจุดูู ูููุตู ููู ูู ููุณ ุณูุงู ูุนุงููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
bool CCoinsViewDB::BatchWriteAssignments(
    const ForgingAssignmentsMap& assignments,
    const PlotAddressAssignmentMap& currentAssignments,  // ูุนููุฉ ุบูุฑ ูุณุชุฎุฏูุฉ (ูุญููุธุฉ ููุชูุงูู API)
    const DeletedAssignmentsSet& deletedAssignments)
{
    CDBBatch batch(*m_db);  // ุฏูุนุฉ ุฌุฏูุฏุฉุ ููู ููุณ ูุงุนุฏุฉ ุงูุจูุงูุงุช

    // ูุชุงุจุฉ ุณุฌู ุงูุชุนููู
    for (const auto& [key, assignment] : assignments) {
        const auto& [plot_addr, txid] = key;
        batch.Write(AssignmentHistoryKey(plot_addr, txid), assignment);
    }

    // ูุณุญ ุงูุชุนูููุงุช ุงููุญุฐููุฉ ูู ุงูุณุฌู
    for (const auto& [plot_addr, txid] : deletedAssignments) {
        batch.Erase(AssignmentHistoryKey(plot_addr, txid));
    }

    // ุฅูุชุฒุงู ุฐุฑู
    return m_db->WriteBatch(batch);
}
```

**ุงูุชูููุฐ:** `src/txdb.cpp:332-348`

### ุถูุงูุงุช ุงูุฐุฑูุฉ

โ **ูุง ูู ุฐุฑู:**
- ุฌููุน ุชุบููุฑุงุช ุงูุนููุฉ ุถูู ูุชูุฉ ุชููุชุจ ุจุดูู ุฐุฑู
- ุฌููุน ุชุบููุฑุงุช ุงูุชุนููู ุถูู ูุชูุฉ ุชููุชุจ ุจุดูู ุฐุฑู
- ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุจูู ูุชุณูุฉ ุนุจุฑ ุงูุฃุนุทุงู

โ๏ธ **ุงูููุฏ ุงูุญุงูู:**
- ุงูุนููุงุช ูุงูุชุนูููุงุช ุชููุชุจ ูู ุนูููุงุช ุฏูุนุฉ LevelDB **ูููุตูุฉ**
- ููุง ุงูุนูููุชูู ุชุญุฏุซุงู ุฃุซูุงุก `view.Flush()`ุ ููู ููุณ ูู ูุชุงุจุฉ ุฐุฑูุฉ ูุงุญุฏุฉ
- ุนูููุงู: ููุชุง ุงูุฏูุนุชูู ุชูุชููุงู ุจุณุฑุนุฉ ูุจู fsync ุงููุฑุต
- ุงููุฎุงุทุฑุฉ ุถุฆููุฉ: ููุงููุง ุณูุญุชุงุฌ ุฅุนุงุฏุฉ ุชุดุบูู ูู ููุณ ุงููุชูุฉ ุฃุซูุงุก ุงุณุชุฑุฏุงุฏ ุงูุนุทู

**ููุงุญุธุฉ:** ูุฐุง ูุฎุชูู ุนู ุฎุทุฉ ุงูุจููุฉ ุงูุฃุตููุฉ ุงูุชู ุฏุนุช ูุฏูุนุฉ ููุญุฏุฉ ูุงุญุฏุฉ. ุงูุชูููุฐ ุงูุญุงูู ูุณุชุฎุฏู ุฏูุนุชูู ููู ูุญุงูุธ ุนูู ุงูุงุชุณุงู ูู ุฎูุงู ุขููุงุช ุงุณุชุฑุฏุงุฏ ุงูุนุทู ุงูููุฌูุฏุฉ ูู Bitcoin Core (ุนูุงูุฉ DB_HEAD_BLOCKS).

## ูุนุงูุฌุฉ ุฅุนุงุฏุฉ ุงูุชูุธูู

### ูููู ุจูุงูุงุช ุงูุชุฑุงุฌุน

```cpp
struct ForgingUndo {
    enum class UndoType : uint8_t {
        ADDED = 0,      // ุงูุชุนููู ุฃูุถูู (ุญุฐู ุนูุฏ ุงูุชุฑุงุฌุน)
        MODIFIED = 1,   // ุงูุชุนููู ุนูุฏูู (ุงุณุชุนุงุฏุฉ ุนูุฏ ุงูุชุฑุงุฌุน)
        REVOKED = 2     // ุงูุชุนููู ุฃููุบู (ุฅูุบุงุก ุงูุฅูุบุงุก ุนูุฏ ุงูุชุฑุงุฌุน)
    };

    UndoType type;
    ForgingAssignment assignment;  // ุงูุญุงูุฉ ุงููุงููุฉ ูุจู ุงูุชุบููุฑ
};

struct CBlockUndo {
    std::vector<CTxUndo> vtxundo;           // ุจูุงูุงุช ุชุฑุงุฌุน UTXO
    std::vector<ForgingUndo> vforgingundo;  // ุจูุงูุงุช ุชุฑุงุฌุน ุงูุชุนููู
};
```

**ุงูุชูููุฐ:** `src/undo.h:63-105`

### ุนูููุฉ DisconnectBlock

ุนูุฏูุง ูููุตู ูุชูุฉ ุฃุซูุงุก ุฅุนุงุฏุฉ ุงูุชูุธูู:

```cpp
DisconnectResult Chainstate::DisconnectBlock(const CBlock& block,
                                              const CBlockIndex* pindex,
                                              CCoinsViewCache& view)
{
    // ... ูุตู UTXO ุงูููุงุณู ...

    // ูุฑุงุกุฉ ุจูุงูุงุช ุงูุชุฑุงุฌุน ูู ุงููุฑุต
    CBlockUndo blockUndo;
    if (!ReadBlockUndo(blockUndo, *pindex))
        return DISCONNECT_FAILED;

    #ifdef ENABLE_POCX
    // ุชุฑุงุฌุน ุชุบููุฑุงุช ุงูุชุนููู (ุงููุนุงูุฌุฉ ุจุชุฑุชูุจ ุนูุณู)
    for (auto it = blockUndo.vforgingundo.rbegin();
         it != blockUndo.vforgingundo.rend(); ++it) {

        switch (it->type) {
            case UndoType::ADDED:
                // ุงูุชุนููู ุฃูุถูู - ุฅุฒุงูุชู
                view.RemoveForgingAssignment(
                    it->assignment.plotAddress,
                    it->assignment.assignment_txid
                );
                break;

            case UndoType::REVOKED:
                // ุงูุชุนููู ุฃููุบู - ุงุณุชุนุงุฏุฉ ุงูุญุงูุฉ ุบูุฑ ุงููููุบุงุฉ
                view.RestoreForgingAssignment(it->assignment);
                break;

            case UndoType::MODIFIED:
                // ุงูุชุนููู ุนูุฏูู - ุงุณุชุนุงุฏุฉ ุงูุญุงูุฉ ุงูุณุงุจูุฉ
                view.UpdateForgingAssignment(it->assignment);
                break;
        }
    }
    #endif

    return DISCONNECT_OK;
}
```

**ุงูุชูููุฐ:** `src/validation.cpp:2381-2415`

### ุฅุฏุงุฑุฉ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุฃุซูุงุก ุฅุนุงุฏุฉ ุงูุชูุธูู

```cpp
class CCoinsViewCache {
private:
    // ุฐุงูุฑุฉ ุชุฎุฒูู ุงูุชุนููู ุงููุคูุชุฉ
    mutable std::map<std::array<uint8_t, 20>, std::vector<ForgingAssignment>> pendingAssignments;
    mutable std::set<std::array<uint8_t, 20>> dirtyPlots;  // ุชุชุจุน ุงูุฑุณููุงุช ุงูููุนุฏููุฉ
    mutable std::set<std::pair<std::array<uint8_t, 20>, uint256>> deletedAssignments;  // ุชุชุจุน ุงูุญุฐู
    mutable size_t cachedAssignmentsUsage{0};  // ุชุชุจุน ุงูุฐุงูุฑุฉ

public:
    void AddForgingAssignment(const ForgingAssignment& assignment) {
        pendingAssignments[assignment.plotAddress].push_back(assignment);
        dirtyPlots.insert(assignment.plotAddress);
        cachedAssignmentsUsage += sizeof(ForgingAssignment);
    }

    void RemoveForgingAssignment(const std::array<uint8_t, 20>& plotAddress,
                                 const uint256& assignment_txid) {
        auto key = std::make_pair(plotAddress, assignment_txid);
        deletedAssignments.insert(key);
        dirtyPlots.insert(plotAddress);
        if (cachedAssignmentsUsage >= sizeof(ForgingAssignment)) {
            cachedAssignmentsUsage -= sizeof(ForgingAssignment);
        }
    }

    void RestoreForgingAssignment(const ForgingAssignment& assignment) {
        pendingAssignments[assignment.plotAddress].push_back(assignment);
        dirtyPlots.insert(assignment.plotAddress);
        auto key = std::make_pair(assignment.plotAddress, assignment.assignment_txid);
        deletedAssignments.erase(key);
        if (true) {
            cachedAssignmentsUsage += sizeof(ForgingAssignment);
        }
    }
};
```

**ุงูุชูููุฐ:** `src/coins.cpp:494-565`

## ูุงุฌูุฉ RPC

### ุฃูุงูุฑ ุงูุนูุฏุฉ (ูุง ุชุชุทูุจ ูุญูุธุฉ)

#### get_assignment
```bash
bitcoin-cli get_assignment "pocx1qplot..."
```

ุชูุฑุฌุน ุญุงูุฉ ุงูุชุนููู ุงูุญุงููุฉ ูุนููุงู ุงูุฑุณู:
```json
{
  "plot_address": "pocx1qplot...",
  "has_assignment": true,
  "state": "ASSIGNED",
  "forging_address": "pocx1qforger...",
  "assignment_txid": "abc123...",
  "assignment_height": 100,
  "activation_height": 244,
  "revoked": false
}
```

**ุงูุชูููุฐ:** `src/pocx/rpc/assignments.cpp:31-126`

### ุฃูุงูุฑ ุงููุญูุธุฉ (ุชุชุทูุจ ูุญูุธุฉ)

#### create_assignment
```bash
bitcoin-cli create_assignment "pocx1qplot..." "pocx1qforger..."
```

ุชููุดุฆ ูุนุงููุฉ ุชุนููู:
- ุชุฎุชุงุฑ ุชููุงุฆูุงู ุฃูุจุฑ UTXO ูู ุนููุงู ุงูุฑุณู ูุฅุซุจุงุช ุงูููููุฉ
- ุชุจูู ุงููุนุงููุฉ ูุน ูุฎุฑุฌ OP_RETURN + ุงูุชุบููุฑ
- ุชููููุน ุจููุชุงุญ ูุงูู ุงูุฑุณู
- ุชุจุซ ููุดุจูุฉ

**ุงูุชูููุฐ:** `src/pocx/rpc/assignments_wallet.cpp:29-93`

#### revoke_assignment
```bash
bitcoin-cli revoke_assignment "pocx1qplot..."
```

ุชููุดุฆ ูุนุงููุฉ ุฅูุบุงุก:
- ุชุฎุชุงุฑ ุชููุงุฆูุงู ุฃูุจุฑ UTXO ูู ุนููุงู ุงูุฑุณู ูุฅุซุจุงุช ุงูููููุฉ
- ุชุจูู ุงููุนุงููุฉ ูุน ูุฎุฑุฌ OP_RETURN + ุงูุชุบููุฑ
- ุชููููุน ุจููุชุงุญ ูุงูู ุงูุฑุณู
- ุชุจุซ ููุดุจูุฉ

**ุงูุชูููุฐ:** `src/pocx/rpc/assignments_wallet.cpp:95-154`

### ุฅูุดุงุก ูุนุงููุฉ ุงููุญูุธุฉ

ุนูููุฉ ุฅูุดุงุก ูุนุงููุฉ ุงููุญูุธุฉ:

```cpp
1. ุชุญููู ูุงูุชุญูู ูู ุงูุนูุงููู (ูุฌุจ ุฃู ุชููู P2WPKH bech32)
2. ุฅูุฌุงุฏ ุฃูุจุฑ UTXO ูู ุนููุงู ุงูุฑุณู (ูุซุจุช ุงูููููุฉ)
3. ุฅูุดุงุก ูุนุงููุฉ ูุคูุชุฉ ูุน ูุฎุฑุฌ ูููู
4. ุชูููุน ุงููุนุงููุฉ (ุงูุญุตูู ุนูู ุญุฌู ุฏููู ูุน ุจูุงูุงุช ุงูุดูุงุฏุฉ)
5. ุงุณุชุจุฏุงู ุงููุฎุฑุฌ ุงููููู ุจู OP_RETURN
6. ุชุนุฏูู ุงูุฑุณูู ุจุงูุชูุงุณุจ ุจูุงุกู ุนูู ุชุบููุฑ ุงูุญุฌู
7. ุฅุนุงุฏุฉ ุชูููุน ุงููุนุงููุฉ ุงูููุงุฆูุฉ
8. ุงูุจุซ ููุดุจูุฉ
```

**ูุธุฑุฉ ูููุฉ:** ูุฌุจ ุนูู ุงููุญูุธุฉ ุงูุฅููุงู ูู ุนููุงู ุงูุฑุณู ูุฅุซุจุงุช ุงูููููุฉุ ูุฐุง ุชูุฑุถ ุชููุงุฆูุงู ุงุฎุชูุงุฑ ุงูุนููุฉ ูู ุฐูู ุงูุนููุงู.

**ุงูุชูููุฐ:** `src/pocx/assignments/transactions.cpp:38-263`

## ูููู ุงููููุงุช

### ูููุงุช ุงูุชูููุฐ ุงูุฃุณุงุณูุฉ

```
src/
โโโ coins.h                        # ูููู ForgingAssignmentุ ุทุฑู CCoinsViewCache [710 ุณุทุฑ]
โโโ coins.cpp                      # ุฅุฏุงุฑุฉ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุชุ ุงููุชุงุจุงุช ุงูุฏูุนูุฉ [603 ุณุทุฑ]
โ
โโโ txdb.h                         # ุทุฑู ุชุนููู CCoinsViewDB [90 ุณุทุฑ]
โโโ txdb.cpp                       # ูุฑุงุกุฉ/ูุชุงุจุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช [349 ุณุทุฑ]
โ
โโโ undo.h                         # ูููู ForgingUndo ูุฅุนุงุฏุฉ ุงูุชูุธูู
โ
โโโ validation.cpp                 # ุชูุงูู ConnectBlock/DisconnectBlock
โ
โโโ pocx/
    โโโ assignments/
    โ   โโโ opcodes.h              # ุตูุบุฉ OP_RETURNุ ุงูุชุญูููุ ุงูุชุญูู
    โ   โโโ opcodes.cpp            # [259 ุณุทุฑ] ุชุนุฑููุงุช ุงูุนูุงูุงุชุ ุนูููุงุช OP_RETURNุ ูุญุต ุงูููููุฉ
    โ   โโโ assignment_state.h     # ูุณุงุนุฏุงุช GetEffectiveSignerุ GetAssignmentState
    โ   โโโ assignment_state.cpp   # ุฏูุงู ุงุณุชุนูุงู ุญุงูุฉ ุงูุชุนููู
    โ   โโโ transactions.h         # ูุงุฌูุฉ ุจุฑูุฌุฉ ุฅูุดุงุก ูุนุงููุฉ ุงููุญูุธุฉ
    โ   โโโ transactions.cpp       # ุฏูุงู ูุญูุธุฉ create_assignmentุ revoke_assignment
    โ
    โโโ rpc/
    โ   โโโ assignments.h          # ุฃูุงูุฑ RPC ููุนูุฏุฉ (ุจุฏูู ูุญูุธุฉ)
    โ   โโโ assignments.cpp        # RPCs get_assignmentุ list_assignments
    โ   โโโ assignments_wallet.h   # ุฃูุงูุฑ RPC ูููุญูุธุฉ
    โ   โโโ assignments_wallet.cpp # RPCs create_assignmentุ revoke_assignment
    โ
    โโโ consensus/
        โโโ params.h               # nForgingAssignmentDelayุ nForgingRevocationDelay
```

## ุฎุตุงุฆุต ุงูุฃุฏุงุก

### ุนูููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

- **ุงูุญุตูู ุนูู ุงูุชุนููู ุงูุญุงูู:** O(n) - ูุณุญ ุฌููุน ุงูุชุนูููุงุช ูุนููุงู ุงูุฑุณู ูุฅูุฌุงุฏ ุงูุฃุญุฏุซ
- **ุงูุญุตูู ุนูู ุณุฌู ุงูุชุนููู:** O(n) - ุชูุฑุงุฑ ุฌููุน ุงูุชุนูููุงุช ููุฑุณู
- **ุฅูุดุงุก ุชุนููู:** O(1) - ุฅุฏุฑุงุฌ ูุงุญุฏ
- **ุฅูุบุงุก ุชุนููู:** O(1) - ุชุญุฏูุซ ูุงุญุฏ
- **ุฅุนุงุฏุฉ ุงูุชูุธูู (ููู ุชุนููู):** O(1) - ุชุทุจูู ูุจุงุดุฑ ูุจูุงูุงุช ุงูุชุฑุงุฌุน

ุญูุซ n = ุนุฏุฏ ุงูุชุนูููุงุช ููุฑุณู (ุนุงุฏุฉ ุตุบูุฑุ < 10)

### ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ

- **ููู ุชุนููู:** ~160 ุจุงูุช (ูููู ForgingAssignment)
- **ุญูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช:** ุญูู ุฎุฑูุทุฉ ุงูุชุฌุฒุฆุฉ ูุชุชุจุน ุงูุชุบููุฑุงุช
- **ุงููุชูุฉ ุงููููุฐุฌูุฉ:** <10 ุชุนูููุงุช = <2 KB ุฐุงูุฑุฉ

### ุงุณุชุฎุฏุงู ุงููุฑุต

- **ููู ุชุนููู:** ~200 ุจุงูุช ุนูู ุงููุฑุต (ูุน ุญูู LevelDB)
- **10000 ุชุนููู:** ~2 MB ูุณุงุญุฉ ูุฑุต
- **ูููู ููุงุฑูุฉ ุจูุฌููุนุฉ UTXO:** <0.001% ูู chainstate ุงููููุฐุฌู

## ุงููููุฏ ุงูุญุงููุฉ ูุงูุนูู ุงููุณุชูุจูู

### ููุฏ ุงูุฐุฑูุฉ

**ุงูุญุงูู:** ุงูุนููุงุช ูุงูุชุนูููุงุช ุชููุชุจ ูู ุฏูุนุงุช LevelDB ูููุตูุฉ ุฃุซูุงุก `view.Flush()`

**ุงูุชุฃุซูุฑ:** ุฎุทุฑ ูุธุฑู ูู ุนุฏู ุงูุงุชุณุงู ุฅุฐุง ุญุฏุซ ุนุทู ุจูู ุงูุฏูุนุงุช

**ุงูุชุฎููู:**
- ููุชุง ุงูุฏูุนุชูู ุชูุชููุงู ุจุณุฑุนุฉ ูุจู fsync
- ุงุณุชุฑุฏุงุฏ ุนุทู Bitcoin Core ูุณุชุฎุฏู ุนูุงูุฉ DB_HEAD_BLOCKS
- ุนูููุงู: ูู ูููุงุญุธ ุฃุจุฏุงู ูู ุงูุงุฎุชุจุงุฑ

**ุชุญุณูู ูุณุชูุจูู:** ุชูุญูุฏ ูู ุนูููุฉ ุฏูุนุฉ LevelDB ูุงุญุฏุฉ

### ุชูููู ุณุฌู ุงูุชุนููู

**ุงูุญุงูู:** ุฌููุน ุงูุชุนูููุงุช ุชูุฎุฒูู ุฅูู ุฃุฌู ุบูุฑ ูุณูู

**ุงูุชุฃุซูุฑ:** ~200 ุจุงูุช ููู ุชุนููู ููุฃุจุฏ

**ุงููุณุชูุจู:** ุชูููู ุงุฎุชูุงุฑู ููุชุนูููุงุช ุงููููุบุงุฉ ุจุงููุงูู ุงูุฃูุฏู ูู N ูุชูุฉ

**ููุงุญุธุฉ:** ูู ุบูุฑ ุงููุญุชูู ุฃู ุชููู ููุงู ุญุงุฌุฉ - ุญุชู ููููู ุชุนููู = 200 MB

## ุญุงูุฉ ุงูุงุฎุชุจุงุฑ

### ุงูุงุฎุชุจุงุฑุงุช ุงููููููุฐุฉ

โ ุชุญููู ูุงูุชุญูู ูู OP_RETURN
โ ุงูุชุญูู ูู ุงูููููุฉ
โ ุฅูุดุงุก ุชุนููู ConnectBlock
โ ุฅูุบุงุก ConnectBlock
โ ูุนุงูุฌุฉ ุฅุนุงุฏุฉ ุชูุธูู DisconnectBlock
โ ุนูููุงุช ูุฑุงุกุฉ/ูุชุงุจุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ุงูุชูุงูุงุช ุงูุญุงูุฉ (UNASSIGNED โ ASSIGNING โ ASSIGNED โ REVOKING โ REVOKED)
โ ุฃูุงูุฑ RPC (get_assignmentุ create_assignmentุ revoke_assignment)
โ ุฅูุดุงุก ูุนุงููุฉ ุงููุญูุธุฉ

### ูุฌุงูุงุช ุชุบุทูุฉ ุงูุงุฎุชุจุงุฑ

- ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ: `src/test/pocx_*_tests.cpp`
- ุงูุงุฎุชุจุงุฑุงุช ุงููุธูููุฉ: `test/functional/feature_pocx_*.py`
- ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู: ุงุฎุชุจุงุฑ ูุฏูู ูุน regtest

## ููุงุนุฏ ุงูุฅุฌูุงุน

### ููุงุนุฏ ุฅูุดุงุก ุงูุชุนููู

1. **ุงูููููุฉ:** ูุฌุจ ุฃู ุชููู ุงููุนุงููุฉ ููููุนุฉ ูู ูุงูู ุงูุฑุณู
2. **ุงูุญุงูุฉ:** ูุฌุจ ุฃู ูููู ุงูุฑุณู ูู ุญุงูุฉ UNASSIGNED ุฃู REVOKED
3. **ุงูุตูุบุฉ:** OP_RETURN ุตุงูุญ ูุน ุนูุงูุฉ POCX + ุนููุงููู 20 ุจุงูุช
4. **ุงูุชูุฑุฏ:** ุชุนููู ูุดุท ูุงุญุฏ ููู ุฑุณู ูู ููุช ูุงุญุฏ

### ููุงุนุฏ ุงูุฅูุบุงุก

1. **ุงูููููุฉ:** ูุฌุจ ุฃู ุชููู ุงููุนุงููุฉ ููููุนุฉ ูู ูุงูู ุงูุฑุณู
2. **ุงููุฌูุฏ:** ูุฌุจ ุฃู ููุฌุฏ ุงูุชุนููู ููู ูููุบ ุจุงููุนู
3. **ุงูุตูุบุฉ:** OP_RETURN ุตุงูุญ ูุน ุนูุงูุฉ XCOP + ุนููุงู 20 ุจุงูุช

### ููุงุนุฏ ุงูุชูุนูู

- **ุชูุนูู ุงูุชุนููู:** `assignment_height + nForgingAssignmentDelay`
- **ุชูุนูู ุงูุฅูุบุงุก:** `revocation_height + nForgingRevocationDelay`
- **ุงูุชุฃุฎูุฑุงุช:** ูุงุจูุฉ ููุชูููู ููู ุดุจูุฉ (ูุซูุงูุ 30 ูุชูุฉ = ~1 ุณุงุนุฉ ูุน ููุช ูุชูุฉ 2 ุฏูููุฉ)

### ุงูุชุญูู ูู ุงููุชูุฉ

- ุชุนููู/ุฅูุบุงุก ุบูุฑ ุตุงูุญ โ ุงููุชูุฉ ูุฑููุถุฉ (ูุดู ุงูุฅุฌูุงุน)
- ูุฎุฑุฌุงุช OP_RETURN ุชูุณุชุจุนุฏ ุชููุงุฆูุงู ูู ูุฌููุนุฉ UTXO (ุณููู Bitcoin ุงูููุงุณู)
- ูุนุงูุฌุฉ ุงูุชุนููู ุชุญุฏุซ ูุจู ุชุญุฏูุซุงุช UTXO ูู ConnectBlock

## ุงูุฎูุงุตุฉ

ูุธุงู ุชุนููู ุตูุงุบุฉ PoCX ููุง ูู ูููููุฐ ูููุฑ:

โ **ุงูุจุณุงุทุฉ:** ูุนุงููุงุช Bitcoin ููุงุณูุฉุ ูุง UTXOs ุฎุงุตุฉ
โ **ูุนุงููุฉ ุงูุชูููุฉ:** ูุง ูุชุทูุจ ุบุจุงุฑุ ุฑุณูู ุงููุนุงููุงุช ููุท
โ **ุณูุงูุฉ ุฅุนุงุฏุฉ ุงูุชูุธูู:** ุจูุงูุงุช ุชุฑุงุฌุน ุดุงููุฉ ุชุณุชุนูุฏ ุงูุญุงูุฉ ุงูุตุญูุญุฉ
โ **ุชุญุฏูุซุงุช ุฐุฑูุฉ:** ุงุชุณุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุฎูุงู ุฏูุนุงุช LevelDB
โ **ุงูุณุฌู ุงููุงูู:** ูุณุงุฑ ุชุฏููู ูุงูู ูุฌููุน ุงูุชุนูููุงุช ุนุจุฑ ุงูููุช
โ **ุจููุฉ ูุธููุฉ:** ุชุนุฏููุงุช ุทูููุฉ ุนูู Bitcoin Coreุ ููุฏ PoCX ูุนุฒูู
โ **ุฌุงูุฒ ููุฅูุชุงุฌ:** ููููุฐ ุจุงููุงููุ ููุฎุชุจุฑุ ูุนุงูู

### ุฌูุฏุฉ ุงูุชูููุฐ

- **ุชูุธูู ุงูููุฏ:** ููุชุงุฒ - ูุตู ูุงุถุญ ุจูู Bitcoin Core ู PoCX
- **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:** ุงูุชุญูู ุงูุดุงูู ูู ุงูุฅุฌูุงุน
- **ุงูุชูุซูู:** ุชุนูููุงุช ุงูููุฏ ูุงููููู ููุซูุฉ ุฌูุฏุงู
- **ุงูุงุฎุชุจุงุฑ:** ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ ููุฎุชุจุฑุฉุ ุงูุชูุงูู ููุชุญูู ููู

### ูุฑุงุฑุงุช ุงูุชุตููู ุงูุฑุฆูุณูุฉ ุงูููุซุจุชุฉ

1. โ ููุฌ OP_RETURN ููุท (ููุงุจู ุงููุงุฆู ุนูู UTXO)
2. โ ุชุฎุฒูู ูุงุนุฏุฉ ุจูุงูุงุช ูููุตู (ููุงุจู Coin extraData)
3. โ ุชุชุจุน ุงูุณุฌู ุงููุงูู (ููุงุจู ุงูุญุงูู ููุท)
4. โ ุงูููููุฉ ุจุงูุชูููุน (ููุงุจู ุฅููุงู UTXO)
5. โ ุชุฃุฎูุฑุงุช ุงูุชูุนูู (ุชููุน ูุฌูุงุช ุฅุนุงุฏุฉ ุงูุชูุธูู)

ูุญูู ุงููุธุงู ุจูุฌุงุญ ุฌููุน ุงูุฃูุฏุงู ุงูุจููููุฉ ูุน ุชูููุฐ ูุธูู ููุงุจู ููุตูุงูุฉ.

---

[โ ุงูุณุงุจู: ุงูุฅุฌูุงุน ูุงูุชุนุฏูู](3-consensus-and-mining.md) | [๐ ุฌุฏูู ุงููุญุชููุงุช](index.md) | [ุงูุชุงูู: ูุฒุงููุฉ ุงูููุช โ](5-timing-security.md)
