[тЖР рдкрд┐рдЫрд▓рд╛: Plot рдкреНрд░рд╛рд░реВрдк](2-plot-format.md) | [ЁЯУШ рд╡рд┐рд╖рдп-рд╕реВрдЪреА](index.md) | [рдЕрдЧрд▓рд╛: рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ тЖТ](4-forging-assignments.md)

---

# рдЕрдзреНрдпрд╛рдп 3: Bitcoin-PoCX рд╕рд╣рдорддрд┐ рдФрд░ рдорд╛рдЗрдирд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛

Bitcoin Core рдореЗрдВ рдПрдХреАрдХреГрдд PoCX (Proof of Capacity neXt generation) рд╕рд╣рдорддрд┐ рддрдВрддреНрд░ рдФрд░ рдорд╛рдЗрдирд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╕рдВрдкреВрд░реНрдг рддрдХрдиреАрдХреА рд╡рд┐рдирд┐рд░реНрджреЗрд╢ред

---

## рд╡рд┐рд╖рдп-рд╕реВрдЪреА

1. [рдЕрд╡рд▓реЛрдХрди](#рдЕрд╡рд▓реЛрдХрди)
2. [рд╕рд╣рдорддрд┐ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░](#рд╕рд╣рдорддрд┐-рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░)
3. [рдорд╛рдЗрдирд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛](#рдорд╛рдЗрдирд┐рдВрдЧ-рдкреНрд░рдХреНрд░рд┐рдпрд╛)
4. [рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди](#рдмреНрд▓реЙрдХ-рд╕рддреНрдпрд╛рдкрди)
5. [рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо](#рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ-рд╕рд┐рд╕реНрдЯрдо)
6. [рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░рд╕рд╛рд░](#рдиреЗрдЯрд╡рд░реНрдХ-рдкреНрд░рд╕рд╛рд░)
7. [рддрдХрдиреАрдХреА рд╡рд┐рд╡рд░рдг](#рддрдХрдиреАрдХреА-рд╡рд┐рд╡рд░рдг)

---

## рдЕрд╡рд▓реЛрдХрди

Bitcoin-PoCX Bitcoin рдХреЗ Proof of Work рдХреЗ рдкреВрд░реНрдг рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рд╢реБрджреНрдз Proof of Capacity рд╕рд╣рдорддрд┐ рддрдВрддреНрд░ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдкрд╢реНрдЪрдЧрд╛рдореА рд╕рдВрдЧрддрддрд╛ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рдмрд┐рдирд╛ рдПрдХ рдирдИ рдЪреЗрди рд╣реИред

**рдореБрдЦреНрдп рдЧреБрдг:**
- **рдКрд░реНрдЬрд╛ рдХреБрд╢рд▓:** рдорд╛рдЗрдирд┐рдВрдЧ рдХрдореНрдкреНрдпреВрдЯреЗрд╢рдирд▓ рд╣реИрд╢рд┐рдВрдЧ рдХреЗ рдмрдЬрд╛рдп рдкреВрд░реНрд╡-рдЙрддреНрдкрдиреНрди plot рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ
- **Time Bended Deadlines:** рд╡рд┐рддрд░рдг рдкрд░рд┐рд╡рд░реНрддрди (рдШрд╛рддрд╛рдВрдХреАрдптЖТрдЪреА-рд╡рд░реНрдЧ) рд▓рдВрдмреЗ рдмреНрд▓реЙрдХ рдХрдо рдХрд░рддрд╛ рд╣реИ, рдФрд╕рдд рдмреНрд▓реЙрдХ рд╕рдордп рдореЗрдВ рд╕реБрдзрд╛рд░
- **рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдорд░реНрдерди:** Plot рдорд╛рд▓рд┐рдХ рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрдзрд┐рдХрд╛рд░ рдЕрдиреНрдп рдкрддреЛрдВ рдХреЛ рдкреНрд░рддреНрдпрд╛рдпреЛрдЬрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
- **рдиреЗрдЯрд┐рд╡ C++ рдПрдХреАрдХрд░рдг:** рд╕рд╣рдорддрд┐ рд╕рддреНрдпрд╛рдкрди рдХреЗ рд▓рд┐рдП C++ рдореЗрдВ рд▓рд╛рдЧреВ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рдПрд▓реНрдЧреЛрд░рд┐рдердо

**рдорд╛рдЗрдирд┐рдВрдЧ рдкреНрд░рд╡рд╛рд╣:**
```
рдмрд╛рд╣рд░реА рдорд╛рдЗрдирд░ тЖТ get_mining_info тЖТ Nonce рдЧрдгрдирд╛ тЖТ submit_nonce тЖТ
Forger рдХрддрд╛рд░ тЖТ Deadline рдкреНрд░рддреАрдХреНрд╖рд╛ тЖТ рдмреНрд▓реЙрдХ рдлреЛрд░реНрдЬрд┐рдВрдЧ тЖТ рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░рд╕рд╛рд░ тЖТ
рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди тЖТ рдЪреЗрди рд╡рд┐рд╕реНрддрд╛рд░
```

---

## рд╕рд╣рдорддрд┐ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░

### рдмреНрд▓реЙрдХ рд╕рдВрд░рдЪрдирд╛

PoCX рдмреНрд▓реЙрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рд╣рдорддрд┐ рдлрд╝реАрд▓реНрдб рдХреЗ рд╕рд╛рде Bitcoin рдХреА рдмреНрд▓реЙрдХ рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░рддреЗ рд╣реИрдВ:

```cpp
struct PoCXProof {
    std::array<uint8_t, 32> seed;             // Plot seed (32 рдмрд╛рдЗрдЯреНрд╕)
    std::array<uint8_t, 20> account_id;       // Plot рдкрддрд╛ (20-рдмрд╛рдЗрдЯ hash160)
    uint32_t compression;                     // рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░ (1-255)
    uint64_t nonce;                           // рдорд╛рдЗрдирд┐рдВрдЧ nonce (64-bit)
    uint64_t quality;                         // рджрд╛рд╡рд╛ рдХреА рдЧрдИ рдЧреБрдгрд╡рддреНрддрд╛ (PoC рд╣реИрд╢ рдЖрдЙрдЯрдкреБрдЯ)
};

class CBlockHeader {
    // рдорд╛рдирдХ Bitcoin рдлрд╝реАрд▓реНрдб
    int32_t nVersion;
    uint256 hashPrevBlock;
    uint256 hashMerkleRoot;
    uint32_t nTime;

    // PoCX рд╕рд╣рдорддрд┐ рдлрд╝реАрд▓реНрдб (nBits рдФрд░ nNonce рдХреЛ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ)
    int nHeight;                              // рдмреНрд▓реЙрдХ рдКрдВрдЪрд╛рдИ (рд╕рдВрджрд░реНрдн-рдореБрдХреНрдд рд╕рддреНрдпрд╛рдкрди)
    uint256 generationSignature;              // Generation signature (рдорд╛рдЗрдирд┐рдВрдЧ рдПрдиреНрдЯреНрд░реЙрдкреА)
    uint64_t nBaseTarget;                     // рдХрдард┐рдирд╛рдИ рдкреИрд░рд╛рдореАрдЯрд░ (рд╡рд┐рд▓реЛрдо рдХрдард┐рдирд╛рдИ)
    PoCXProof pocxProof;                      // рдорд╛рдЗрдирд┐рдВрдЧ рдкреНрд░рдорд╛рдг

    // рдмреНрд▓реЙрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдлрд╝реАрд▓реНрдб
    std::array<uint8_t, 33> vchPubKey;        // рд╕рдВрдкреАрдбрд╝рд┐рдд рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА (33 рдмрд╛рдЗрдЯреНрд╕)
    std::array<uint8_t, 65> vchSignature;     // рдХреЙрдореНрдкреИрдХреНрдЯ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ (65 рдмрд╛рдЗрдЯреНрд╕)
};

class CBlock : public CBlockHeader {
    std::vector<CTransactionRef> vtx;         // рд▓реЗрдирджреЗрди
};
```

**рдиреЛрдЯ:** malleability рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░ (`vchSignature`) рдмреНрд▓реЙрдХ рд╣реИрд╢ рдЧрдгрдирд╛ рд╕реЗ рдмрд╛рд╣рд░ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реИред

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/primitives/block.h`

### Generation Signature

Generation signature рдорд╛рдЗрдирд┐рдВрдЧ рдПрдиреНрдЯреНрд░реЙрдкреА рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ precomputation рд╣рдорд▓реЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИред

**рдЧрдгрдирд╛:**
```
generationSignature = SHA256(prev_generationSignature || prev_miner_pubkey)
```

**Genesis рдмреНрд▓реЙрдХ:** рд╣рд╛рд░реНрдбрдХреЛрдбреЗрдб рдкреНрд░рд╛рд░рдВрднрд┐рдХ generation signature рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/node/node.cpp:GetNewBlockContext()`

### Base Target (рдХрдард┐рдирд╛рдИ)

Base target рдХрдард┐рдирд╛рдИ рдХрд╛ рд╡рд┐рд▓реЛрдо рд╣реИ - рдЙрдЪреНрдЪ рдорд╛рди рдХрд╛ рдЕрд░реНрде рдЖрд╕рд╛рди рдорд╛рдЗрдирд┐рдВрдЧред

**рд╕рдорд╛рдпреЛрдЬрди рдПрд▓реНрдЧреЛрд░рд┐рдердо:**
- рд▓рдХреНрд╖реНрдп рдмреНрд▓реЙрдХ рд╕рдордп: 120 рд╕реЗрдХрдВрдб (mainnet), 1 рд╕реЗрдХрдВрдб (regtest)
- рд╕рдорд╛рдпреЛрдЬрди рдЕрдВрддрд░рд╛рд▓: рдкреНрд░рддреНрдпреЗрдХ рдмреНрд▓реЙрдХ
- рд╣рд╛рд▓ рдХреЗ base targets рдХреЗ рдореВрд╡рд┐рдВрдЧ рдПрд╡рд░реЗрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ
- рдЕрддреНрдпрдзрд┐рдХ рдХрдард┐рдирд╛рдИ рд╕реНрд╡рд┐рдВрдЧ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓реИрдВрдк

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/consensus/params.h`, рдмреНрд▓реЙрдХ рдирд┐рд░реНрдорд╛рдг рдореЗрдВ рдХрдард┐рдирд╛рдИ рд╕рдорд╛рдпреЛрдЬрди

### рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░

PoCX рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░реЛрдВ (Xn) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ plot рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рд╕реНрдХреЗрд▓реЗрдмрд▓ proof-of-work рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред

**рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕реАрдорд╛рдПрдВ:**
```cpp
struct CompressionBounds {
    uint8_t nPoCXMinCompression;     // рдиреНрдпреВрдирддрдо рд╕реНрд╡реАрдХреГрдд рд╕реНрддрд░
    uint8_t nPoCXTargetCompression;  // рдЕрдиреБрд╢рдВрд╕рд┐рдд рд╕реНрддрд░
};
```

**рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╡реГрджреНрдзрд┐ рдЕрдиреБрд╕реВрдЪреА:**
- рдШрд╛рддрд╛рдВрдХреАрдп рдЕрдВрддрд░рд╛рд▓: рд╡рд░реНрд╖ 4, 12, 28, 60, 124 (halvings 1, 3, 7, 15, 31)
- рдиреНрдпреВрдирддрдо рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░ 1 рд╕реЗ рдмрдврд╝рддрд╛ рд╣реИ
- рд▓рдХреНрд╖реНрдп рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░ 1 рд╕реЗ рдмрдврд╝рддрд╛ рд╣реИ
- Plot рдирд┐рд░реНрдорд╛рдг рдФрд░ рд▓реБрдХрдЕрдк рд▓рд╛рдЧрдд рдХреЗ рдмреАрдЪ рд╕реБрд░рдХреНрд╖рд╛ рдорд╛рд░реНрдЬрд┐рди рдмрдирд╛рдП рд░рдЦрддрд╛ рд╣реИ
- рдЕрдзрд┐рдХрддрдо рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░: 255

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/algorithms/algorithms.h:GetPoCXCompressionBounds()`

---

## рдорд╛рдЗрдирд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛

### 1. рдорд╛рдЗрдирд┐рдВрдЧ рдЬрд╛рдирдХрд╛рд░реА рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐

**RPC рдХрдорд╛рдВрдб:** `get_mining_info`

**рдкреНрд░рдХреНрд░рд┐рдпрд╛:**
1. рд╡рд░реНрддрдорд╛рди рдмреНрд▓реЙрдХрдЪреЗрди рд╕реНрдерд┐рддрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `GetNewBlockContext(chainman)` рдХреЙрд▓ рдХрд░реЗрдВ
2. рд╡рд░реНрддрдорд╛рди рдКрдВрдЪрд╛рдИ рдХреЗ рд▓рд┐рдП рдбрд╛рдпрдирд╛рдорд┐рдХ compression рд╕реАрдорд╛рдУрдВ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ
3. рдорд╛рдЗрдирд┐рдВрдЧ рдкреИрд░рд╛рдореАрдЯрд░ рд▓реМрдЯрд╛рдПрдВ

**рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛:**
```json
{
  "generation_signature": "abc123...",
  "base_target": 18325193796,
  "height": 12345,
  "block_hash": "def456...",
  "target_quality": 18446744073709551615,
  "minimum_compression_level": 0,
  "target_compression_level": 0
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/rpc/mining.cpp:get_mining_info()`

**рдиреЛрдЯреНрд╕:**
- рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдЬрдирд░реЗрд╢рди рдХреЗ рджреМрд░рд╛рди рдХреЛрдИ рд▓реЙрдХ рдирд╣реАрдВ рд░рдЦреЗ рдЬрд╛рддреЗ
- рд╕рдВрджрд░реНрдн рдЕрдзрд┐рдЧреНрд░рд╣рдг рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ `cs_main` рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ
- `block_hash` рд╕рдВрджрд░реНрдн рдХреЗ рд▓рд┐рдП рд╢рд╛рдорд┐рд▓ рд▓реЗрдХрд┐рди рд╕рддреНрдпрд╛рдкрди рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ

### 2. рдмрд╛рд╣рд░реА рдорд╛рдЗрдирд┐рдВрдЧ

**рдмрд╛рд╣рд░реА рдорд╛рдЗрдирд░ рдЬрд┐рдореНрдореЗрджрд╛рд░рд┐рдпрд╛рдВ:**
1. рдбрд┐рд╕реНрдХ рд╕реЗ plot рдлрд╝рд╛рдЗрд▓реЗрдВ рдкрдврд╝реЗрдВ
2. Generation signature рдФрд░ рдКрдВрдЪрд╛рдИ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ scoop рдЧрдгрдирд╛ рдХрд░реЗрдВ
3. рд╕рд░реНрд╡реЛрддреНрддрдо deadline рд╡рд╛рд▓рд╛ nonce рдЦреЛрдЬреЗрдВ
4. `submit_nonce` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдиреЛрдб рдХреЛ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ

**Plot рдлрд╝рд╛рдЗрд▓ рдкреНрд░рд╛рд░реВрдк:**
- POC2 рдкреНрд░рд╛рд░реВрдк (Burstcoin) рдкрд░ рдЖрдзрд╛рд░рд┐рдд
- рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрдзрд╛рд░ рдФрд░ рд╕реНрдХреЗрд▓реЗрдмрд┐рд▓рд┐рдЯреА рд╕рдВрд╡рд░реНрджреНрдзрди рдХреЗ рд╕рд╛рде
- `CLAUDE.md` рдореЗрдВ рдПрдЯреНрд░рд┐рдмреНрдпреВрд╢рди рджреЗрдЦреЗрдВ

**рдорд╛рдЗрдирд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** рдмрд╛рд╣рд░реА (рдЬреИрд╕реЗ, Scavenger рдкрд░ рдЖрдзрд╛рд░рд┐рдд)

### 3. Nonce рд╕рдмрдорд┐рд╢рди рдФрд░ рд╕рддреНрдпрд╛рдкрди

**RPC рдХрдорд╛рдВрдб:** `submit_nonce`

**рдкреИрд░рд╛рдореАрдЯрд░:**
```
height, generation_signature, account_id, seed, nonce, quality (рд╡реИрдХрд▓реНрдкрд┐рдХ)
```

**рд╕рддреНрдпрд╛рдкрди рдкреНрд░рд╡рд╛рд╣ (рдЕрдиреБрдХреВрд▓рд┐рдд рдХреНрд░рдо):**

#### рдЪрд░рдг 1: рддреЗрдЬрд╝ рдкреНрд░рд╛рд░реВрдк рд╕рддреНрдпрд╛рдкрди
```cpp
// Account ID: 40 рд╣реЗрдХреНрд╕ рдЕрдХреНрд╖рд░ = 20 рдмрд╛рдЗрдЯреНрд╕
if (account_id.length() != 40 || !IsHex(account_id)) reject;

// Seed: 64 рд╣реЗрдХреНрд╕ рдЕрдХреНрд╖рд░ = 32 рдмрд╛рдЗрдЯреНрд╕
if (seed.length() != 64 || !IsHex(seed)) reject;
```

#### рдЪрд░рдг 2: рд╕рдВрджрд░реНрдн рдЕрдзрд┐рдЧреНрд░рд╣рдг
```cpp
auto context = pocx::consensus::GetNewBlockContext(chainman);
// рд▓реМрдЯрд╛рддрд╛ рд╣реИ: height, generation_signature, base_target, block_hash
```

**рд▓реЙрдХрд┐рдВрдЧ:** `cs_main` рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рд╕рдВрднрд╛рд▓рд╛, RPC рдереНрд░реЗрдб рдореЗрдВ рдХреЛрдИ рд▓реЙрдХ рдирд╣реАрдВ

#### рдЪрд░рдг 3: рд╕рдВрджрд░реНрдн рд╕рддреНрдпрд╛рдкрди
```cpp
// рдКрдВрдЪрд╛рдИ рдЬрд╛рдВрдЪ
if (height != context.height) reject;

// Generation signature рдЬрд╛рдВрдЪ
if (submitted_gen_sig != context.generation_signature) reject;
```

#### рдЪрд░рдг 4: рд╡реЙрд▓реЗрдЯ рд╕рддреНрдпрд╛рдкрди
```cpp
// рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдВ (рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рддреЗ рд╣реБрдП)
effective_signer = GetEffectiveSigner(plot_address, height, view);

// рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдиреЛрдб рдХреЗ рдкрд╛рд╕ рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдирд┐рдЬреА рдХреБрдВрдЬреА рд╣реИ
if (!HaveAccountKey(effective_signer, wallet)) reject;
```

**рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдорд░реНрдерди:** Plot рдорд╛рд▓рд┐рдХ рджреВрд╕рд░реЗ рдкрддреЗ рдХреЛ рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрдзрд┐рдХрд╛рд░ рдЕрд╕рд╛рдЗрди рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╡реЙрд▓реЗрдЯ рдХреЗ рдкрд╛рд╕ рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдХреБрдВрдЬреА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдЬрд░реВрд░реА рдирд╣реАрдВ рдХрд┐ plot рдорд╛рд▓рд┐рдХ рдХреЗ рд▓рд┐рдПред

#### рдЪрд░рдг 5: рдкреНрд░рдорд╛рдг рд╕рддреНрдпрд╛рдкрди
```cpp
bool success = pocx_validate_block(
    generation_signature_hex,
    base_target,
    account_payload,     // 20 рдмрд╛рдЗрдЯреНрд╕
    block_height,
    nonce,
    seed,                // 32 рдмрд╛рдЗрдЯреНрд╕
    min_compression,
    max_compression,
    &result             // рдЖрдЙрдЯрдкреБрдЯ: quality, deadline
);
```

**рдПрд▓реНрдЧреЛрд░рд┐рдердо:**
1. рд╣реЗрдХреНрд╕ рд╕реЗ generation signature рдбрд┐рдХреЛрдб рдХрд░реЗрдВ
2. SIMD-рдЕрдиреБрдХреВрд▓рд┐рдд рдПрд▓реНрдЧреЛрд░рд┐рдердо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ compression рд░реЗрдВрдЬ рдореЗрдВ рд╕рд░реНрд╡реЛрддреНрддрдо рдЧреБрдгрд╡рддреНрддрд╛ рдЧрдгрдирд╛ рдХрд░реЗрдВ
3. рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЧреБрдгрд╡рддреНрддрд╛ рдХрдард┐рдирд╛рдИ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░рддреА рд╣реИ
4. рд░реЙ рдЧреБрдгрд╡рддреНрддрд╛ рдорд╛рди рд▓реМрдЯрд╛рдПрдВ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/consensus/validation.cpp:pocx_validate_block()`

#### рдЪрд░рдг 6: Time Bending рдЧрдгрдирд╛
```cpp
// рд░реЙ рдХрдард┐рдирд╛рдИ-рд╕рдорд╛рдпреЛрдЬрд┐рдд deadline (рд╕реЗрдХрдВрдб)
uint64_t deadline_seconds = quality / base_target;

// Time Bended рдлреЛрд░реНрдЬ рд╕рдордп (рд╕реЗрдХрдВрдб)
uint64_t forge_time = CalculateTimeBendedDeadline(
    quality, base_target, block_time
);
```

**Time Bending рд╕реВрддреНрд░:**
```
Y = scale * (X^(1/3))
рдЬрд╣рд╛рдВ:
  X = quality / base_target
  scale = block_time / (cbrt(block_time) * Gamma(4/3))
  Gamma(4/3) тЙИ 0.892979511
```

**рдЙрджреНрджреЗрд╢реНрдп:** рдШрд╛рддрд╛рдВрдХреАрдп рдХреЛ рдЪреА-рд╡рд░реНрдЧ рд╡рд┐рддрд░рдг рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реИред рдмрд╣реБрдд рдЕрдЪреНрдЫреЗ рд╕рдорд╛рдзрд╛рди рдмрд╛рдж рдореЗрдВ рдлреЛрд░реНрдЬ рд╣реЛрддреЗ рд╣реИрдВ (рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдкрд╛рд╕ рдбрд┐рд╕реНрдХ рд╕реНрдХреИрди рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реЛрддрд╛ рд╣реИ), рдЦрд░рд╛рдм рд╕рдорд╛рдзрд╛рди рдореЗрдВ рд╕реБрдзрд╛рд░ред рд▓рдВрдмреЗ рдмреНрд▓реЙрдХ рдХрдо, 120s рдФрд╕рдд рдмрдирд╛рдП рд░рдЦрд╛ред

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/algorithms/time_bending.cpp:CalculateTimeBendedDeadline()`

#### рдЪрд░рдг 7: Forger рд╕рдмрдорд┐рд╢рди
```cpp
g_pocx_scheduler->SubmitNonce(
    account_id,
    seed,
    nonce,
    raw_quality,      // deadline рдирд╣реАрдВ - forger рдореЗрдВ рдкреБрдирд░реНрдЧрдгрдирд╛
    height,
    generation_signature
);
```

**рдХрддрд╛рд░-рдЖрдзрд╛рд░рд┐рдд рдбрд┐рдЬрд╝рд╛рдЗрди:**
- рд╕рдмрдорд┐рд╢рди рд╣рдореЗрд╢рд╛ рд╕рдлрд▓ (рдХрддрд╛рд░ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛)
- RPC рддреБрд░рдВрдд рд▓реМрдЯрддрд╛ рд╣реИ
- рд╡рд░реНрдХрд░ рдереНрд░реЗрдб рдЕрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рд░реВрдк рд╕реЗ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рддрд╛ рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/rpc/mining.cpp:submit_nonce()`

### 4. Forger рдХрддрд╛рд░ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ

**рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░:**
- рдПрдХрд▓ рд╕реНрдерд╛рдпреА рд╡рд░реНрдХрд░ рдереНрд░реЗрдб
- FIFO рд╕рдмрдорд┐рд╢рди рдХрддрд╛рд░
- рд▓реЙрдХ-рдлреНрд░реА рдлреЛрд░реНрдЬрд┐рдВрдЧ рд╕реНрдерд┐рддрд┐ (рдХреЗрд╡рд▓ рд╡рд░реНрдХрд░ рдереНрд░реЗрдб)
- рдХреЛрдИ рдиреЗрд╕реНрдЯреЗрдб рд▓реЙрдХ рдирд╣реАрдВ (рдбреЗрдбрд▓реЙрдХ рд░реЛрдХрдерд╛рдо)

**рд╡рд░реНрдХрд░ рдереНрд░реЗрдб рдореБрдЦреНрдп рд▓реВрдк:**
```cpp
while (!shutdown) {
    // 1. рдХрддрд╛рд░рдмрджреНрдз рд╕рдмрдорд┐рд╢рди рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
    if (has_submission) {
        ProcessSubmission(submission);
        continue;
    }

    // 2. Deadline рдпрд╛ рдирдП рд╕рдмрдорд┐рд╢рди рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ
    if (has_forging_state) {
        WaitForDeadlineOrNewSubmission();
    } else {
        WaitForNewSubmission();
    }
}
```

**ProcessSubmission рд▓реЙрдЬрд┐рдХ:**
```cpp
1. рддрд╛рдЬрд╝рд╛ рд╕рдВрджрд░реНрдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ: GetNewBlockContext(*chainman)

2. Staleness рдЬрд╛рдВрдЪ (рдореМрди рддреНрдпрд╛рдЧ):
   - рдКрдВрдЪрд╛рдИ рдмреЗрдореЗрд▓ тЖТ рддреНрдпрд╛рдЧ
   - Generation signature рдмреЗрдореЗрд▓ тЖТ рддреНрдпрд╛рдЧ
   - рдЯрд┐рдк рдмреНрд▓реЙрдХ рд╣реИрд╢ рдмрджрд▓рд╛ (reorg) тЖТ рдлреЛрд░реНрдЬрд┐рдВрдЧ рд╕реНрдерд┐рддрд┐ рд░реАрд╕реЗрдЯ

3. рдЧреБрдгрд╡рддреНрддрд╛ рддреБрд▓рдирд╛:
   - рдпрджрд┐ quality >= current_best тЖТ рддреНрдпрд╛рдЧ

4. Time Bended deadline рдЧрдгрдирд╛ рдХрд░реЗрдВ:
   deadline = CalculateTimeBendedDeadline(quality, base_target, block_time)

5. рдлреЛрд░реНрдЬрд┐рдВрдЧ рд╕реНрдерд┐рддрд┐ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ:
   - рдореМрдЬреВрджрд╛ рдлреЛрд░реНрдЬрд┐рдВрдЧ рд░рджреНрдж рдХрд░реЗрдВ (рдпрджрд┐ рдмреЗрд╣рддрд░ рдорд┐рд▓рд╛)
   - рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВ: account_id, seed, nonce, quality, deadline
   - рдЧрдгрдирд╛ рдХрд░реЗрдВ: forge_time = block_time + deadline_seconds
   - Reorg рдкрд╣рдЪрд╛рди рдХреЗ рд▓рд┐рдП рдЯрд┐рдк рд╣реИрд╢ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВ
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/mining/scheduler.cpp:ProcessSubmission()`

### 5. Deadline рдкреНрд░рддреАрдХреНрд╖рд╛ рдФрд░ рдмреНрд▓реЙрдХ рдлреЛрд░реНрдЬрд┐рдВрдЧ

**WaitForDeadlineOrNewSubmission:**

**рдкреНрд░рддреАрдХреНрд╖рд╛ рд╢рд░реНрддреЗрдВ:**
```cpp
condition_variable.wait_until(forge_time, [&] {
    return shutdown ||
           !submission_queue.empty() ||
           forging_cancelled;
});
```

**рдЬрдм Deadline рдкрд╣реБрдВрдЪрд╛ - рддрд╛рдЬрд╝рд╛ рд╕рдВрджрд░реНрдн рд╕рддреНрдпрд╛рдкрди:**
```cpp
1. рд╡рд░реНрддрдорд╛рди рд╕рдВрджрд░реНрдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ: GetNewBlockContext(*chainman)

2. рдКрдВрдЪрд╛рдИ рд╕рддреНрдпрд╛рдкрди:
   if (forging_height != current_height) {
       reset_forging_state();
       return;
   }

3. Generation signature рд╕рддреНрдпрд╛рдкрди:
   if (forging_gen_sig != current_gen_sig) {
       reset_forging_state();
       return;
   }

4. Base target рдПрдЬ рдХреЗрд╕:
   if (forging_base_target != current_base_target) {
       // рдирдП base target рдХреЗ рд╕рд╛рде deadline рдкреБрдирд░реНрдЧрдгрдирд╛ рдХрд░реЗрдВ
       new_deadline = CalculateTimeBendedDeadline(quality, new_base_target, block_time);
       update_forge_time(new_deadline);
       return; // рдлрд┐рд░ рд╕реЗ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ
   }

5. рд╕рднреА рд╡реИрдз тЖТ ForgeBlock()
```

**ForgeBlock рдкреНрд░рдХреНрд░рд┐рдпрд╛:**

```cpp
1. рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдВ (рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдорд░реНрдерди):
   effective_signer = GetEffectiveSigner(plot_address, height, view);

2. Coinbase рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрдирд╛рдПрдВ:
   coinbase_script = P2WPKH(effective_signer);  // рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреЛ рднреБрдЧрддрд╛рди

3. рдмреНрд▓реЙрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рдмрдирд╛рдПрдВ:
   options.coinbase_output_script = coinbase_script;
   options.use_mempool = true;
   template = mining->createNewBlock(options);

4. PoCX рдкреНрд░рдорд╛рдг рдЬреЛрдбрд╝реЗрдВ:
   block.pocxProof.account_id = plot_address;    // рдореВрд▓ plot рдкрддрд╛
   block.pocxProof.seed = seed;
   block.pocxProof.nonce = nonce;

5. Merkle root рдкреБрдирд░реНрдЧрдгрдирд╛ рдХрд░реЗрдВ:
   block.hashMerkleRoot = BlockMerkleRoot(block);

6. рдмреНрд▓реЙрдХ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░реЗрдВ:
   // рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ (plot рдорд╛рд▓рд┐рдХ рд╕реЗ рднрд┐рдиреНрди рд╣реЛ рд╕рдХрддреА рд╣реИ)
   hash = PoCXBlockSignatureHash(block.GetHash());
   key.SignCompact(hash, signature);
   block.vchSignature = signature;
   block.vchPubKey = effective_signer_pubkey;

7. рдЪреЗрди рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ:
   chainman->ProcessNewBlock(block, force=true, min_pow_checked=true);

8. рдкрд░рд┐рдгрд╛рдо рд╣реИрдВрдбрд▓рд┐рдВрдЧ:
   if (accepted) {
       log_success();
       reset_forging_state();  // рдЕрдЧрд▓реЗ рдмреНрд▓реЙрдХ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░
   } else {
       log_failure();
       reset_forging_state();
   }
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/mining/scheduler.cpp:ForgeBlock()`

**рдореБрдЦреНрдп рдбрд┐рдЬрд╝рд╛рдЗрди рдирд┐рд░реНрдгрдп:**
- Coinbase рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреЛ рднреБрдЧрддрд╛рди рдХрд░рддрд╛ рд╣реИ (рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдХрд╛ рд╕рдореНрдорд╛рди)
- рдкреНрд░рдорд╛рдг рдореЗрдВ рдореВрд▓ plot рдкрддрд╛ рд╣реЛрддрд╛ рд╣реИ (рд╕рддреНрдпрд╛рдкрди рдХреЗ рд▓рд┐рдП)
- рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреА рдХреБрдВрдЬреА рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ (рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдкреНрд░рдорд╛рдг)
- рдЯреЗрдореНрдкрд▓реЗрдЯ рдирд┐рд░реНрдорд╛рдг рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ mempool рд▓реЗрдирджреЗрди рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ

---

## рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди

### рдЖрдиреЗ рд╡рд╛рд▓реЗ рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди рдкреНрд░рд╡рд╛рд╣

рдЬрдм рдХреЛрдИ рдмреНрд▓реЙрдХ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ рдпрд╛ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд╕рдмрдорд┐рдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдХрдИ рдЪрд░рдгреЛрдВ рдореЗрдВ рд╕рддреНрдпрд╛рдкрди рд╕реЗ рдЧреБрдЬрд░рддрд╛ рд╣реИ:

### рдЪрд░рдг 1: рд╣реЗрдбрд░ рд╕рддреНрдпрд╛рдкрди (CheckBlockHeader)

**рд╕рдВрджрд░реНрдн-рдореБрдХреНрдд рд╕рддреНрдпрд╛рдкрди:**

```cpp
static bool CheckBlockHeader(
    const CBlockHeader& block,
    BlockValidationState& state,
    const Consensus::Params& consensusParams,
    bool fCheckPOW = true
)
```

**PoCX рд╕рддреНрдпрд╛рдкрди (рдЬрдм ENABLE_POCX рдкрд░рд┐рднрд╛рд╖рд┐рдд):**
```cpp
if (block.nHeight > 0 && fCheckPOW) {
    // рдмреБрдирд┐рдпрд╛рджреА рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди (рдЕрднреА рддрдХ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдорд░реНрдерди рдирд╣реАрдВ)
    if (!VerifyPoCXBlockCompactSignature(block)) {
        return state.Invalid(BLOCK_INVALID_HEADER, "bad-pocx-sig");
    }
}
```

**рдмреБрдирд┐рдпрд╛рджреА рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди:**
1. Pubkey рдФрд░ signature рдлрд╝реАрд▓реНрдб рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдЬрд╛рдВрдЪреЗрдВ
2. Pubkey рдЖрдХрд╛рд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ (33 рдмрд╛рдЗрдЯреНрд╕ рд╕рдВрдкреАрдбрд╝рд┐рдд)
3. Signature рдЖрдХрд╛рд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ (65 рдмрд╛рдЗрдЯреНрд╕ рдХреЙрдореНрдкреИрдХреНрдЯ)
4. Signature рд╕реЗ pubkey рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ: `pubkey.RecoverCompact(hash, signature)`
5. рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд pubkey рд╕рдВрдЧреНрд░рд╣реАрдд pubkey рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/validation.cpp:CheckBlockHeader()`
**рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд▓реЙрдЬрд┐рдХ:** `src/pocx/consensus/pocx.cpp:VerifyPoCXBlockCompactSignature()`

### рдЪрд░рдг 2: рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди (CheckBlock)

**рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ:**
- Merkle root рд╢реБрджреНрдзрддрд╛
- рд▓реЗрдирджреЗрди рд╡реИрдзрддрд╛
- Coinbase рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ
- рдмреНрд▓реЙрдХ рдЖрдХрд╛рд░ рд╕реАрдорд╛рдПрдВ
- рдорд╛рдирдХ Bitcoin рд╕рд╣рдорддрд┐ рдирд┐рдпрдо

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/consensus/validation.cpp:CheckBlock()`

### рдЪрд░рдг 3: рд╕рдВрджрд░реНрднрд╛рддреНрдордХ рд╣реЗрдбрд░ рд╕рддреНрдпрд╛рдкрди (ContextualCheckBlockHeader)

**PoCX-рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рддреНрдпрд╛рдкрди:**

```cpp
#ifdef ENABLE_POCX
    // рдЪрд░рдг 1: Generation signature рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
    uint256 expected_gen_sig = CalculateGenerationSignature(pindexPrev);
    if (block.generationSignature != expected_gen_sig) {
        return state.Invalid(BLOCK_INVALID_HEADER, "bad-gen-sig");
    }

    // рдЪрд░рдг 2: Base target рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
    uint64_t expected_base_target = CalculateNextBaseTarget(pindexPrev, block.nTime);
    if (block.nBaseTarget != expected_base_target) {
        return state.Invalid(BLOCK_INVALID_HEADER, "bad-diff");
    }

    // рдЪрд░рдг 3: Proof of capacity рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
    auto compression_bounds = GetPoCXCompressionBounds(block.nHeight, halving_interval);
    auto result = ValidateProofOfCapacity(
        block.generationSignature,
        block.pocxProof,
        block.nBaseTarget,
        block.nHeight,
        compression_bounds.nPoCXMinCompression,
        compression_bounds.nPoCXTargetCompression,
        block_time
    );

    if (!result.is_valid) {
        return state.Invalid(BLOCK_INVALID_HEADER, "bad-pocx-proof");
    }

    // рдЪрд░рдг 4: Deadline рд╕рдордп рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
    uint32_t elapsed_time = block.nTime - pindexPrev->nTime;
    if (result.deadline > elapsed_time) {
        return state.Invalid(BLOCK_INVALID_HEADER, "pocx-deadline-not-met");
    }
#endif
```

**рд╕рддреНрдпрд╛рдкрди рдЪрд░рдг:**
1. **Generation Signature:** рдкрд┐рдЫрд▓реЗ рдмреНрд▓реЙрдХ рд╕реЗ рдЧрдгрдирд╛ рдХрд┐рдП рдЧрдП рдорд╛рди рд╕реЗ рдореЗрд▓ рдЦрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
2. **Base Target:** рдХрдард┐рдирд╛рдИ рд╕рдорд╛рдпреЛрдЬрди рдЧрдгрдирд╛ рд╕реЗ рдореЗрд▓ рдЦрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
3. **рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░:** рдиреЗрдЯрд╡рд░реНрдХ рдиреНрдпреВрдирддрдо рдХреЛ рдкреВрд░рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП (`compression >= min_compression`)
4. **рдЧреБрдгрд╡рддреНрддрд╛ рджрд╛рд╡рд╛:** рд╕рдмрдорд┐рдЯ рдХреА рдЧрдИ рдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░рдорд╛рдг рд╕реЗ рдЧрдгрдирд╛ рдХреА рдЧрдИ рдЧреБрдгрд╡рддреНрддрд╛ рд╕реЗ рдореЗрд▓ рдЦрд╛рдиреА рдЪрд╛рд╣рд┐рдП
5. **Proof of Capacity:** рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рдкреНрд░рдорд╛рдг рд╕рддреНрдпрд╛рдкрди (SIMD-рдЕрдиреБрдХреВрд▓рд┐рдд)
6. **Deadline рд╕рдордп:** Time-bended deadline (`poc_time`) тЙд рдмреАрддрд╛ рд╣реБрдЖ рд╕рдордп рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/validation.cpp:ContextualCheckBlockHeader()`

### рдЪрд░рдг 4: рдмреНрд▓реЙрдХ рдХрдиреЗрдХреНрд╢рди (ConnectBlock)

**рдкреВрд░реНрдг рд╕рдВрджрд░реНрднрд╛рддреНрдордХ рд╕рддреНрдпрд╛рдкрди:**

```cpp
#ifdef ENABLE_POCX
    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдорд░реНрдерди рдХреЗ рд╕рд╛рде рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди
    if (pindex->nHeight > 0 && !fJustCheck) {
        if (!VerifyPoCXBlockCompactSignature(block, view, pindex->nHeight)) {
            return state.Invalid(BLOCK_CONSENSUS, "bad-pocx-assignment-sig");
        }
    }
#endif
```

**рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди:**
1. рдмреБрдирд┐рдпрд╛рджреА рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди рдХрд░реЗрдВ
2. рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд pubkey рд╕реЗ account ID рдирд┐рдХрд╛рд▓реЗрдВ
3. Plot рдкрддреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ: `GetEffectiveSigner(plot_address, height, view)`
4. рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ рдХрд┐ pubkey account рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ

**рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд▓реЙрдЬрд┐рдХ:**
```cpp
std::array<uint8_t, 20> GetEffectiveSigner(
    const std::array<uint8_t, 20>& plotAddress,
    int nHeight,
    const CCoinsViewCache& view
) {
    auto assignment = view.GetForgingAssignment(plotAddress, nHeight);

    if (assignment.has_value() && assignment->IsActiveAtHeight(nHeight)) {
        return assignment->forgingAddress;  // рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рд▓реМрдЯрд╛рдПрдВ
    }

    return plotAddress;  // рдХреЛрдИ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд╣реАрдВ - plot рдорд╛рд▓рд┐рдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рддрд╛ рд╣реИ
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:**
- рдХрдиреЗрдХреНрд╢рди: `src/validation.cpp:ConnectBlock()`
- рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╕рддреНрдпрд╛рдкрди: `src/pocx/consensus/pocx.cpp:VerifyPoCXBlockCompactSignature()`
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд▓реЙрдЬрд┐рдХ: `src/pocx/consensus/validation.cpp:GetEffectiveSigner()`

### рдЪрд░рдг 5: рдЪреЗрди рд╕рдХреНрд░рд┐рдпрдг

**ProcessNewBlock рдкреНрд░рд╡рд╛рд╣:**
```cpp
bool ProcessNewBlock(const std::shared_ptr<const CBlock>& block,
                    bool force_processing,
                    bool min_pow_checked,
                    bool* new_block)
{
    1. AcceptBlock тЖТ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ рдФрд░ рдбрд┐рд╕реНрдХ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВ
    2. ActivateBestChain тЖТ рдпрджрд┐ рдпрд╣ рд╕рд░реНрд╡реЛрддреНрддрдо рдЪреЗрди рд╣реИ рддреЛ рдЪреЗрди рдЯрд┐рдк рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ
    3. рдирдП рдмреНрд▓реЙрдХ рдХреА рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рд╕реВрдЪрдирд╛ рджреЗрдВ
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/validation.cpp:ProcessNewBlock()`

### рд╕рддреНрдпрд╛рдкрди рд╕рд╛рд░рд╛рдВрд╢

**рдкреВрд░реНрдг рд╕рддреНрдпрд╛рдкрди рдкрде:**
```
рдмреНрд▓реЙрдХ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
    тЖУ
CheckBlockHeader (рдмреБрдирд┐рдпрд╛рджреА рд╣рд╕реНрддрд╛рдХреНрд╖рд░)
    тЖУ
CheckBlock (рд▓реЗрдирджреЗрди, merkle)
    тЖУ
ContextualCheckBlockHeader (gen sig, base target, PoC proof, deadline)
    тЖУ
ConnectBlock (рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдХреЗ рд╕рд╛рде рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░, рд╕реНрдерд┐рддрд┐ рд╕рдВрдХреНрд░рдордг)
    тЖУ
ActivateBestChain (reorg рд╣реИрдВрдбрд▓рд┐рдВрдЧ, рдЪреЗрди рд╡рд┐рд╕реНрддрд╛рд░)
    тЖУ
рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░рд╕рд╛рд░
```

---

## рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо

### рдЕрд╡рд▓реЛрдХрди

рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ plot рдорд╛рд▓рд┐рдХреЛрдВ рдХреЛ plot рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдмрдирд╛рдП рд░рдЦрддреЗ рд╣реБрдП рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрдзрд┐рдХрд╛рд░ рдЕрдиреНрдп рдкрддреЛрдВ рдХреЛ рдкреНрд░рддреНрдпрд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред

**рдЙрдкрдпреЛрдЧ рдХреЗ рдорд╛рдорд▓реЗ:**
- рдкреВрд▓ рдорд╛рдЗрдирд┐рдВрдЧ (plots рдкреВрд▓ рдкрддреЗ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░рддреЗ рд╣реИрдВ)
- рдХреЛрд▓реНрдб рд╕реНрдЯреЛрд░реЗрдЬ (рдорд╛рдЗрдирд┐рдВрдЧ рдХреБрдВрдЬреА plot рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕реЗ рдЕрд▓рдЧ)
- рдмрд╣реБ-рдкрдХреНрд╖реАрдп рдорд╛рдЗрдирд┐рдВрдЧ (рд╕рд╛рдЭрд╛ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪрд╛)

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░

**OP_RETURN-рдХреЗрд╡рд▓ рдбрд┐рдЬрд╝рд╛рдЗрди:**
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ OP_RETURN рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд (рдХреЛрдИ UTXO рдирд╣реАрдВ)
- рдХреЛрдИ рдЦрд░реНрдЪ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рдирд╣реАрдВ (рдХреЛрдИ dust рдирд╣реАрдВ, рд╣реЛрд▓реНрдбрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╢реБрд▓реНрдХ рдирд╣реАрдВ)
- CCoinsViewCache рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЯреНрд░реИрдХ
- рд╡рд┐рд▓рдВрдм рдЕрд╡рдзрд┐ рдХреЗ рдмрд╛рдж рд╕рдХреНрд░рд┐рдп (рдбрд┐рдлрд╝реЙрд▓реНрдЯ: 4 рдмреНрд▓реЙрдХ)

**рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐рдпрд╛рдВ:**
```cpp
enum class ForgingState : uint8_t {
    UNASSIGNED = 0,  // рдХреЛрдИ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдореМрдЬреВрдж рдирд╣реАрдВ
    ASSIGNING = 1,   // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдХреНрд░рд┐рдпрдг рд▓рдВрдмрд┐рдд (рд╡рд┐рд▓рдВрдм рдЕрд╡рдзрд┐)
    ASSIGNED = 2,    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдХреНрд░рд┐рдп, рдлреЛрд░реНрдЬрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐
    REVOKING = 3,    // рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд▓рдВрдмрд┐рдд (рд╡рд┐рд▓рдВрдм рдЕрд╡рдзрд┐, рдЕрднреА рднреА рд╕рдХреНрд░рд┐рдп)
    REVOKED = 4      // рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдкреВрд░реНрдг, рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЕрдм рд╕рдХреНрд░рд┐рдп рдирд╣реАрдВ
};
```

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдмрдирд╛рдирд╛

**рд▓реЗрдирджреЗрди рдкреНрд░рд╛рд░реВрдк:**
```cpp
Transaction {
    inputs: [any]  // Plot рдкрддреЗ рдХрд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рддрд╛ рд╣реИ
    outputs: [
        OP_RETURN <ASSIGN_MAGIC> <plot_address> <forging_address>
    ]
}
```

**рд╕рддреНрдпрд╛рдкрди рдирд┐рдпрдо:**
1. рдЗрдирдкреБрдЯ plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рддрд╛ рд╣реИ)
2. OP_RETURN рдореЗрдВ рд╡реИрдз рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдбреЗрдЯрд╛ рд╣реЛрддрд╛ рд╣реИ
3. Plot UNASSIGNED рдпрд╛ REVOKED рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
4. Mempool рдореЗрдВ рдХреЛрдИ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рд▓рдВрдмрд┐рдд рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд╣реАрдВ
5. рдиреНрдпреВрдирддрдо рд▓реЗрдирджреЗрди рд╢реБрд▓реНрдХ рднреБрдЧрддрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛

**рд╕рдХреНрд░рд┐рдпрдг:**
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкреБрд╖реНрдЯрд┐ рдКрдВрдЪрд╛рдИ рдкрд░ ASSIGNING рдмрди рдЬрд╛рддрд╛ рд╣реИ
- рд╡рд┐рд▓рдВрдм рдЕрд╡рдзрд┐ рдХреЗ рдмрд╛рдж ASSIGNED рдмрди рдЬрд╛рддрд╛ рд╣реИ (4 рдмреНрд▓реЙрдХ regtest, 30 рдмреНрд▓реЙрдХ mainnet)
- рд╡рд┐рд▓рдВрдм рдмреНрд▓реЙрдХ рджреМрдбрд╝ рдХреЗ рджреМрд░рд╛рди рддреНрд╡рд░рд┐рдд рдкреБрдирд░реНрдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд░реЛрдХрддрд╛ рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/script/forging_assignment.h`, ConnectBlock рдореЗрдВ рд╕рддреНрдпрд╛рдкрди

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд┐рд░рд╕реНрдд рдХрд░рдирд╛

**рд▓реЗрдирджреЗрди рдкреНрд░рд╛рд░реВрдк:**
```cpp
Transaction {
    inputs: [any]  // Plot рдкрддреЗ рдХрд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рддрд╛ рд╣реИ
    outputs: [
        OP_RETURN <REVOKE_MAGIC> <plot_address>
    ]
}
```

**рдкреНрд░рднрд╛рд╡:**
- REVOKED рдореЗрдВ рддрддреНрдХрд╛рд▓ рд╕реНрдерд┐рддрд┐ рд╕рдВрдХреНрд░рдордг
- Plot рдорд╛рд▓рд┐рдХ рддреБрд░рдВрдд рдлреЛрд░реНрдЬ рдХрд░ рд╕рдХрддрд╛ рд╣реИ
- рдмрд╛рдж рдореЗрдВ рдирдпрд╛ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ

### рдорд╛рдЗрдирд┐рдВрдЧ рдХреЗ рджреМрд░рд╛рди рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рддреНрдпрд╛рдкрди

**рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдирд┐рд░реНрдзрд╛рд░рдг:**
```cpp
// submit_nonce рд╕рддреНрдпрд╛рдкрди рдореЗрдВ
effective_signer = GetEffectiveSigner(plot_address, height, view);
if (!HaveAccountKey(effective_signer, wallet)) reject;

// рдмреНрд▓реЙрдХ рдлреЛрд░реНрдЬрд┐рдВрдЧ рдореЗрдВ
coinbase_script = P2WPKH(effective_signer);  // рдкреБрд░рд╕реНрдХрд╛рд░ рдпрд╣рд╛рдВ рдЬрд╛рддрд╛ рд╣реИ

// рдмреНрд▓реЙрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдореЗрдВ
signature = effective_signer_key.SignCompact(hash);  // рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
```

**рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди:**
```cpp
// VerifyPoCXBlockCompactSignature (рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд) рдореЗрдВ
effective_signer = GetEffectiveSigner(proof.account_id, height, view);
pubkey_account = ExtractAccountIDFromPubKey(block.vchPubKey);
if (pubkey_account != effective_signer) reject;
```

**рдореБрдЦреНрдп рдЧреБрдг:**
- рдкреНрд░рдорд╛рдг рдореЗрдВ рд╣рдореЗрд╢рд╛ рдореВрд▓ plot рдкрддрд╛ рд╣реЛрддрд╛ рд╣реИ
- рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рд╕реЗ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
- Coinbase рдкреНрд░рднрд╛рд╡реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░рдХрд░реНрддрд╛ рдХреЛ рднреБрдЧрддрд╛рди рдХрд░рддрд╛ рд╣реИ
- рд╕рддреНрдпрд╛рдкрди рдмреНрд▓реЙрдХ рдКрдВрдЪрд╛рдИ рдкрд░ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ

---

## рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░рд╕рд╛рд░

### рдмреНрд▓реЙрдХ рдШреЛрд╖рдгрд╛

**рдорд╛рдирдХ Bitcoin P2P рдкреНрд░реЛрдЯреЛрдХреЙрд▓:**
1. `ProcessNewBlock()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлреЛрд░реНрдЬ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдмреНрд▓реЙрдХ рд╕рдмрдорд┐рдЯ
2. рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрд┐рдд рдФрд░ рдЪреЗрди рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛
3. рдиреЗрдЯрд╡рд░реНрдХ рд╕реВрдЪрдирд╛: `GetMainSignals().BlockConnected()`
4. P2P рдкрд░рдд peers рдХреЛ рдмреНрд▓реЙрдХ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░рддреА рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** рдорд╛рдирдХ Bitcoin Core net_processing

### рдмреНрд▓реЙрдХ рд░рд┐рд▓реЗ

**Compact Blocks (BIP 152):**
- рдХреБрд╢рд▓ рдмреНрд▓реЙрдХ рдкреНрд░рд╕рд╛рд░ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ
- рд╢реБрд░реВ рдореЗрдВ рдХреЗрд╡рд▓ transaction IDs рднреЗрдЬреЗ рдЧрдП
- Peers рд▓реБрдкреНрдд рд▓реЗрдирджреЗрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ

**рдкреВрд░реНрдг рдмреНрд▓реЙрдХ рд░рд┐рд▓реЗ:**
- рдЬрдм compact blocks рд╡рд┐рдлрд▓ рд╣реЛрдВ рддреЛ рдлрд╝реЙрд▓рдмреИрдХ
- рдкреВрд░реНрдг рдмреНрд▓реЙрдХ рдбреЗрдЯрд╛ рдкреНрд░реЗрд╖рд┐рдд

### рдЪреЗрди рдкреБрдирд░реНрдЧрдарди

**Reorg рд╣реИрдВрдбрд▓рд┐рдВрдЧ:**
```cpp
// forger рд╡рд░реНрдХрд░ рдереНрд░реЗрдб рдореЗрдВ
if (current_tip_hash != stored_tip_hash) {
    // рдЪреЗрди рдкреБрдирд░реНрдЧрдарди рдХрд╛ рдкрддрд╛ рдЪрд▓рд╛
    reset_forging_state();
    log("Chain tip changed, resetting forging");
}
```

**рдмреНрд▓реЙрдХрдЪреЗрди-рд╕реНрддрд░:**
- рдорд╛рдирдХ Bitcoin Core reorg рд╣реИрдВрдбрд▓рд┐рдВрдЧ
- Chainwork рджреНрд╡рд╛рд░рд╛ рд╕рд░реНрд╡реЛрддреНрддрдо рдЪреЗрди рдирд┐рд░реНрдзрд╛рд░рд┐рдд
- рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рдХрд┐рдП рдЧрдП рдмреНрд▓реЙрдХ mempool рдореЗрдВ рд▓реМрдЯрд╛рдП рдЧрдП

---

## рддрдХрдиреАрдХреА рд╡рд┐рд╡рд░рдг

### рдбреЗрдбрд▓реЙрдХ рд░реЛрдХрдерд╛рдо

**ABBA рдбреЗрдбрд▓реЙрдХ рдкреИрдЯрд░реНрди (рд░реЛрдХрд╛ рдЧрдпрд╛):**
```
Thread A: cs_main тЖТ cs_wallet
Thread B: cs_wallet тЖТ cs_main
```

**рд╕рдорд╛рдзрд╛рди:**
1. **submit_nonce:** рд╢реВрдиреНрдп cs_main рдЙрдкрдпреЛрдЧ
   - `GetNewBlockContext()` рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рд▓реЙрдХрд┐рдВрдЧ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ
   - Forger рд╕рдмрдорд┐рд╢рди рд╕реЗ рдкрд╣рд▓реЗ рд╕рднреА рд╕рддреНрдпрд╛рдкрди

2. **Forger:** рдХрддрд╛рд░-рдЖрдзрд╛рд░рд┐рдд рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░
   - рдПрдХрд▓ рд╡рд░реНрдХрд░ рдереНрд░реЗрдб (рдХреЛрдИ рдереНрд░реЗрдб рдЬреЙрдЗрди рдирд╣реАрдВ)
   - рдкреНрд░рддреНрдпреЗрдХ рдПрдХреНрд╕реЗрд╕ рдкрд░ рддрд╛рдЬрд╝рд╛ рд╕рдВрджрд░реНрдн
   - рдХреЛрдИ рдиреЗрд╕реНрдЯреЗрдб рд▓реЙрдХ рдирд╣реАрдВ

3. **рд╡реЙрд▓реЗрдЯ рдЬрд╛рдВрдЪ:** рдорд╣рдВрдЧреЗ рдСрдкрд░реЗрд╢рди рд╕реЗ рдкрд╣рд▓реЗ рдХреА рдЬрд╛рддреА рд╣реИ
   - рдХреЛрдИ рдХреБрдВрдЬреА рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реЛрдиреЗ рдкрд░ рдЬрд▓реНрджреА рдЕрд╕реНрд╡реАрдХреГрддрд┐
   - рдмреНрд▓реЙрдХрдЪреЗрди рд╕реНрдерд┐рддрд┐ рдПрдХреНрд╕реЗрд╕ рд╕реЗ рдЕрд▓рдЧ

### рдкреНрд░рджрд░реНрд╢рди рдЕрдиреБрдХреВрд▓рди

**рдлрд╛рд╕реНрдЯ-рдлреЗрд▓ рд╕рддреНрдпрд╛рдкрди:**
```cpp
1. рдкреНрд░рд╛рд░реВрдк рдЬрд╛рдВрдЪ (рддрддреНрдХрд╛рд▓)
2. рд╕рдВрджрд░реНрдн рд╕рддреНрдпрд╛рдкрди (рд╣рд▓реНрдХрд╛)
3. рд╡реЙрд▓реЗрдЯ рд╕рддреНрдпрд╛рдкрди (рд╕реНрдерд╛рдиреАрдп)
4. рдкреНрд░рдорд╛рдг рд╕рддреНрдпрд╛рдкрди (рдорд╣рдВрдЧрд╛ SIMD)
```

**рдПрдХрд▓ рд╕рдВрджрд░реНрдн рдлрд╝реЗрдЪ:**
- рдкреНрд░рддрд┐ рд╕рдмрдорд┐рд╢рди рдПрдХ `GetNewBlockContext()` рдХреЙрд▓
- рдХрдИ рдЬрд╛рдВрдЪреЛрдВ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рдгрд╛рдо рдХреИрд╢ рдХрд░реЗрдВ
- рдХреЛрдИ рджреЛрд╣рд░рд╛рдпрд╛ cs_main рдЕрдзрд┐рдЧреНрд░рд╣рдг рдирд╣реАрдВ

**рдХрддрд╛рд░ рджрдХреНрд╖рддрд╛:**
- рд╣рд▓реНрдХреА рд╕рдмрдорд┐рд╢рди рд╕рдВрд░рдЪрдирд╛
- рдХрддрд╛рд░ рдореЗрдВ рдХреЛрдИ base_target/deadline рдирд╣реАрдВ (рддрд╛рдЬрд╝рд╛ рдкреБрдирд░реНрдЧрдгрдирд╛)
- рдиреНрдпреВрдирддрдо рдореЗрдореЛрд░реА рдлрд╝реБрдЯрдкреНрд░рд┐рдВрдЯ

### Staleness рд╣реИрдВрдбрд▓рд┐рдВрдЧ

**"Stupid" Forger рдбрд┐рдЬрд╝рд╛рдЗрди:**
- рдХреЛрдИ рдмреНрд▓реЙрдХрдЪреЗрди рдИрд╡реЗрдВрдЯ рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдирд╣реАрдВ
- рдЬрдм рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рддрдм рдЖрд▓рд╕реА рд╕рддреНрдпрд╛рдкрди
- Stale рд╕рдмрдорд┐рд╢рди рдХрд╛ рдореМрди рддреНрдпрд╛рдЧ

**рд▓рд╛рдн:**
- рд╕рд░рд▓ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░
- рдХреЛрдИ рдЬрдЯрд┐рд▓ рд╕рд┐рдВрдХреНрд░рдирд╛рдЗрдЬрд╝реЗрд╢рди рдирд╣реАрдВ
- рдПрдЬ рдХреЗрд╕ рдХреЗ рдкреНрд░рддрд┐ рдордЬрд╝рдмреВрдд

**рд╕рдВрднрд╛рд▓реЗ рдЧрдП рдПрдЬ рдХреЗрд╕:**
- рдКрдВрдЪрд╛рдИ рдкрд░рд┐рд╡рд░реНрддрди тЖТ рддреНрдпрд╛рдЧ
- Generation signature рдкрд░рд┐рд╡рд░реНрддрди тЖТ рддреНрдпрд╛рдЧ
- Base target рдкрд░рд┐рд╡рд░реНрддрди тЖТ deadline рдкреБрдирд░реНрдЧрдгрдирд╛
- Reorgs тЖТ рдлреЛрд░реНрдЬрд┐рдВрдЧ рд╕реНрдерд┐рддрд┐ рд░реАрд╕реЗрдЯ

### рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рд╡рд┐рд╡рд░рдг

**Generation Signature:**
```cpp
SHA256(prev_generation_signature || prev_miner_pubkey_33bytes)
```

**рдмреНрд▓реЙрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╣реИрд╢:**
```cpp
hash = SHA256(SHA256("POCX Signed Block:\n" || block_hash_hex))
```

**рдХреЙрдореНрдкреИрдХреНрдЯ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рд╛рд░реВрдк:**
- 65 рдмрд╛рдЗрдЯреНрд╕: [recovery_id][r][s]
- рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
- рд╕реНрдерд╛рди рджрдХреНрд╖рддрд╛ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ

**Account ID:**
- рд╕рдВрдкреАрдбрд╝рд┐рдд рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдХрд╛ 20-рдмрд╛рдЗрдЯ HASH160
- Bitcoin рдкрддрд╛ рдкреНрд░рд╛рд░реВрдкреЛрдВ рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ (P2PKH, P2WPKH)

### рднрд╡рд┐рд╖реНрдп рдХреЗ рд╕рдВрд╡рд░реНрджреНрдзрди

**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝рд┐рдд рд╕реАрдорд╛рдПрдВ:**
1. рдХреЛрдИ рдкреНрд░рджрд░реНрд╢рди рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдирд╣реАрдВ (рд╕рдмрдорд┐рд╢рди рджрд░, deadline рд╡рд┐рддрд░рдг)
2. рдорд╛рдЗрдирд░реНрд╕ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╡рд┐рд╕реНрддреГрдд рддреНрд░реБрдЯрд┐ рд╡рд░реНрдЧреАрдХрд░рдг рдирд╣реАрдВ
3. рд╕реАрдорд┐рдд forger рд╕реНрдерд┐рддрд┐ рдХреНрд╡реЗрд░реАрдЗрдВрдЧ (рд╡рд░реНрддрдорд╛рди deadline, рдХрддрд╛рд░ рдЧрд╣рд░рд╛рдИ)

**рд╕рдВрднрд╛рд╡рд┐рдд рд╕реБрдзрд╛рд░:**
- Forger рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП RPC
- рдорд╛рдЗрдирд┐рдВрдЧ рджрдХреНрд╖рддрд╛ рдХреЗ рд▓рд┐рдП рдореЗрдЯреНрд░рд┐рдХреНрд╕
- рдбреАрдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЙрдиреНрдирдд рд▓реЙрдЧрд┐рдВрдЧ
- рдкреВрд▓ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕рдорд░реНрдерди

---

## рдХреЛрдб рд╕рдВрджрд░реНрдн

**рдХреЛрд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:**
- RPC рдЗрдВрдЯрд░рдлрд╝реЗрд╕: `src/pocx/rpc/mining.cpp`
- Forger рдХрддрд╛рд░: `src/pocx/mining/scheduler.cpp`
- рд╕рд╣рдорддрд┐ рд╕рддреНрдпрд╛рдкрди: `src/pocx/consensus/validation.cpp`
- рдкреНрд░рдорд╛рдг рд╕рддреНрдпрд╛рдкрди: `src/pocx/consensus/pocx.cpp`
- Time Bending: `src/pocx/algorithms/time_bending.cpp`
- рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди: `src/validation.cpp` (CheckBlockHeader, ConnectBlock)
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд▓реЙрдЬрд┐рдХ: `src/pocx/consensus/validation.cpp:GetEffectiveSigner()`
- рд╕рдВрджрд░реНрдн рдкреНрд░рдмрдВрдзрди: `src/pocx/node/node.cpp:GetNewBlockContext()`

**рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдПрдВ:**
- рдмреНрд▓реЙрдХ рдкреНрд░рд╛рд░реВрдк: `src/primitives/block.h`
- рд╕рд╣рдорддрд┐ рдкреИрд░рд╛рдореАрдЯрд░: `src/consensus/params.h`
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЯреНрд░реИрдХрд┐рдВрдЧ: `src/coins.h` (CCoinsViewCache рдПрдХреНрд╕рдЯреЗрдВрд╢рди)

---

## рдкрд░рд┐рд╢рд┐рд╖реНрдЯ: рдПрд▓реНрдЧреЛрд░рд┐рдердо рд╡рд┐рдирд┐рд░реНрджреЗрд╢

### Time Bending рд╕реВрддреНрд░

**рдЧрдгрд┐рддреАрдп рдкрд░рд┐рднрд╛рд╖рд╛:**
```
deadline_seconds = quality / base_target  (рд░реЙ)

time_bended_deadline = scale * (deadline_seconds)^(1/3)

рдЬрд╣рд╛рдВ:
  scale = block_time / (cbrt(block_time) * Gamma(4/3))
  Gamma(4/3) тЙИ 0.892979511
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:**
- рдлрд┐рдХреНрд╕реНрдб-рдкреЙрдЗрдВрдЯ рдЕрдВрдХрдЧрдгрд┐рдд (Q42 рдкреНрд░рд╛рд░реВрдк)
- рдкреВрд░реНрдгрд╛рдВрдХ-рдХреЗрд╡рд▓ рдШрди рдореВрд▓ рдЧрдгрдирд╛
- 256-bit рдЕрдВрдХрдЧрдгрд┐рдд рдХреЗ рд▓рд┐рдП рдЕрдиреБрдХреВрд▓рд┐рдд

### рдЧреБрдгрд╡рддреНрддрд╛ рдЧрдгрдирд╛

**рдкреНрд░рдХреНрд░рд┐рдпрд╛:**
1. Generation signature рдФрд░ рдКрдВрдЪрд╛рдИ рд╕реЗ scoop рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ
2. рдЧрдгрдирд╛ рдХрд┐рдП рдЧрдП scoop рдХреЗ рд▓рд┐рдП plot рдбреЗрдЯрд╛ рдкрдврд╝реЗрдВ
3. рд╣реИрд╢: `SHABAL256(generation_signature || scoop_data)`
4. Min рд╕реЗ max рддрдХ рд╕реНрдХреЗрд▓рд┐рдВрдЧ рд╕реНрддрд░реЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ
5. рдорд┐рд▓реА рд╕рд░реНрд╡реЛрддреНрддрдо рдЧреБрдгрд╡рддреНрддрд╛ рд▓реМрдЯрд╛рдПрдВ

**рд╕реНрдХреЗрд▓рд┐рдВрдЧ:**
- рд╕реНрддрд░ X0: POC2 рдмреЗрд╕рд▓рд╛рдЗрди (рд╕реИрджреНрдзрд╛рдВрддрд┐рдХ)
- рд╕реНрддрд░ X1: XOR-transpose рдмреЗрд╕рд▓рд╛рдЗрди
- рд╕реНрддрд░ Xn: 2^(n-1) ├Ч X1 рдХрд╛рд░реНрдп рдПрдореНрдмреЗрдбреЗрдб
- рдЙрдЪреНрдЪ рд╕реНрдХреЗрд▓рд┐рдВрдЧ = рдЕрдзрд┐рдХ plot рдЬрдирд░реЗрд╢рди рдХрд╛рд░реНрдп

### Base Target рд╕рдорд╛рдпреЛрдЬрди

**рдкреНрд░рддреНрдпреЗрдХ рдмреНрд▓реЙрдХ рд╕рдорд╛рдпреЛрдЬрди:**
1. рд╣рд╛рд▓ рдХреЗ base targets рдХреЗ рдореВрд╡рд┐рдВрдЧ рдПрд╡рд░реЗрдЬ рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ
2. рд░реЛрд▓рд┐рдВрдЧ рд╡рд┐рдВрдбреЛ рдХреЗ рд▓рд┐рдП рд╡рд╛рд╕реНрддрд╡рд┐рдХ timespan рдмрдирд╛рдо рд▓рдХреНрд╖реНрдп timespan рдЧрдгрдирд╛ рдХрд░реЗрдВ
3. Base target рдХреЛ рдЖрдиреБрдкрд╛рддрд┐рдХ рд░реВрдк рд╕реЗ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░реЗрдВ
4. рдЕрддреНрдпрдзрд┐рдХ рд╕реНрд╡рд┐рдВрдЧ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓реИрдВрдк рдХрд░реЗрдВ

**рд╕реВрддреНрд░:**
```
avg_base_target = moving_average(recent base targets)
adjustment_factor = actual_timespan / target_timespan
new_base_target = avg_base_target * adjustment_factor
new_base_target = clamp(new_base_target, min, max)
```

---

*рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдЕрдХреНрдЯреВрдмрд░ 2025 рддрдХ рдкреВрд░реНрдг PoCX рд╕рд╣рдорддрд┐ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред*

---

[тЖР рдкрд┐рдЫрд▓рд╛: Plot рдкреНрд░рд╛рд░реВрдк](2-plot-format.md) | [ЁЯУШ рд╡рд┐рд╖рдп-рд╕реВрдЪреА](index.md) | [рдЕрдЧрд▓рд╛: рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ тЖТ](4-forging-assignments.md)
