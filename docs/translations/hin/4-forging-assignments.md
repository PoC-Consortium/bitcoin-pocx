[тЖР рдкрд┐рдЫрд▓рд╛: рд╕рд╣рдорддрд┐ рдФрд░ рдорд╛рдЗрдирд┐рдВрдЧ](3-consensus-and-mining.md) | [ЁЯУШ рд╡рд┐рд╖рдп-рд╕реВрдЪреА](index.md) | [рдЕрдЧрд▓рд╛: рд╕рдордп рд╕рд┐рдВрдХреНрд░рдирд╛рдЗрдЬрд╝реЗрд╢рди тЖТ](5-timing-security.md)

---

# рдЕрдзреНрдпрд╛рдп 4: PoCX рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо

## рдХрд╛рд░реНрдпрдХрд╛рд░реА рд╕рд╛рд░рд╛рдВрд╢

рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ OP_RETURN-рдХреЗрд╡рд▓ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд** PoCX рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИред рд╕рд┐рд╕реНрдЯрдо plot рдорд╛рд▓рд┐рдХреЛрдВ рдХреЛ рдкреВрд░реНрдг reorg рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдкрд░рдорд╛рдгреБ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд╕рд╛рде рдСрди-рдЪреЗрди рд▓реЗрдирджреЗрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрдзрд┐рдХрд╛рд░ рдЕрд▓рдЧ рдкрддреЛрдВ рдХреЛ рдкреНрд░рддреНрдпрд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рддрд╛ рд╣реИред

**рд╕реНрдерд┐рддрд┐:** тЬЕ рдкреВрд░реНрдгрддрдГ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдФрд░ рд╕рдВрдЪрд╛рд▓рдирд░рдд

## рдореВрд▓ рдбрд┐рдЬрд╝рд╛рдЗрди рджрд░реНрд╢рди

**рдореБрдЦреНрдп рд╕рд┐рджреНрдзрд╛рдВрдд:** рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ, рд╕рдВрдкрддреНрддрд┐ рдирд╣реАрдВ

- рдЯреНрд░реИрдХ рдпрд╛ рдЦрд░реНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╡рд┐рд╢реЗрд╖ UTXOs рдирд╣реАрдВ
- UTXO рд╕реЗрдЯ рд╕реЗ рдЕрд▓рдЧ рд╕рдВрдЧреНрд░рд╣реАрдд рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐
- UTXO рдЦрд░реНрдЪ рдирд╣реАрдВ, рд▓реЗрдирджреЗрди рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рджреНрд╡рд╛рд░рд╛ рд╕рд┐рджреНрдз рд╕реНрд╡рд╛рдорд┐рддреНрд╡
- рдкреВрд░реНрдг рдСрдбрд┐рдЯ рдЯреНрд░реЗрд▓ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрдг рдЗрддрд┐рд╣рд╛рд╕ рдЯреНрд░реИрдХрд┐рдВрдЧ
- LevelDB рдмреИрдЪ рд▓реЗрдЦрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд░рдорд╛рдгреБ рдбреЗрдЯрд╛рдмреЗрд╕ рдЕрдкрдбреЗрдЯ

## рд▓реЗрдирджреЗрди рд╕рдВрд░рдЪрдирд╛

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд▓реЗрдирджреЗрди рдкреНрд░рд╛рд░реВрдк

```
Inputs:
  [0]: Plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХреЛрдИ рднреА UTXO (рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз + рд╢реБрд▓реНрдХ рднреБрдЧрддрд╛рди рдХрд░рддрд╛ рд╣реИ)
       Plot рдорд╛рд▓рд┐рдХ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
  [1+]: рд╢реБрд▓реНрдХ рдХрд╡рд░реЗрдЬ рдХреЗ рд▓рд┐рдП рд╡реИрдХрд▓реНрдкрд┐рдХ рдЕрддрд┐рд░рд┐рдХреНрдд inputs

Outputs:
  [0]: OP_RETURN (POCX рдорд╛рд░реНрдХрд░ + plot рдкрддрд╛ + forge рдкрддрд╛)
       рдкреНрд░рд╛рд░реВрдк: OP_RETURN <0x2c> "POCX" <plot_addr_20> <forge_addr_20>
       рдЖрдХрд╛рд░: 46 рдмрд╛рдЗрдЯреНрд╕ рдХреБрд▓ (1 рдмрд╛рдЗрдЯ OP_RETURN + 1 рдмрд╛рдЗрдЯ рд▓рдВрдмрд╛рдИ + 44 рдмрд╛рдЗрдЯреНрд╕ рдбреЗрдЯрд╛)
       рдореВрд▓реНрдп: 0 BTC (рдЕрдЦрд░реНрдЪрдиреАрдп, UTXO рд╕реЗрдЯ рдореЗрдВ рдирд╣реАрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛)

  [1]: рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Change рд╡рд╛рдкрд╕ (рд╡реИрдХрд▓реНрдкрд┐рдХ, рдорд╛рдирдХ P2WPKH)
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/assignments/opcodes.cpp:25-52`

### рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд▓реЗрдирджреЗрди рдкреНрд░рд╛рд░реВрдк

```
Inputs:
  [0]: Plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХреЛрдИ рднреА UTXO (рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз + рд╢реБрд▓реНрдХ рднреБрдЧрддрд╛рди рдХрд░рддрд╛ рд╣реИ)
       Plot рдорд╛рд▓рд┐рдХ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
  [1+]: рд╢реБрд▓реНрдХ рдХрд╡рд░реЗрдЬ рдХреЗ рд▓рд┐рдП рд╡реИрдХрд▓реНрдкрд┐рдХ рдЕрддрд┐рд░рд┐рдХреНрдд inputs

Outputs:
  [0]: OP_RETURN (XCOP рдорд╛рд░реНрдХрд░ + plot рдкрддрд╛)
       рдкреНрд░рд╛рд░реВрдк: OP_RETURN <0x18> "XCOP" <plot_addr_20>
       рдЖрдХрд╛рд░: 26 рдмрд╛рдЗрдЯреНрд╕ рдХреБрд▓ (1 рдмрд╛рдЗрдЯ OP_RETURN + 1 рдмрд╛рдЗрдЯ рд▓рдВрдмрд╛рдИ + 24 рдмрд╛рдЗрдЯреНрд╕ рдбреЗрдЯрд╛)
       рдореВрд▓реНрдп: 0 BTC (рдЕрдЦрд░реНрдЪрдиреАрдп, UTXO рд╕реЗрдЯ рдореЗрдВ рдирд╣реАрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛)

  [1]: рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Change рд╡рд╛рдкрд╕ (рд╡реИрдХрд▓реНрдкрд┐рдХ, рдорд╛рдирдХ P2WPKH)
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/assignments/opcodes.cpp:54-77`

### рдорд╛рд░реНрдХрд░

- **рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдорд╛рд░реНрдХрд░:** `POCX` (0x50, 0x4F, 0x43, 0x58) = "Proof of Capacity neXt"
- **рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдорд╛рд░реНрдХрд░:** `XCOP` (0x58, 0x43, 0x4F, 0x50) = "eXit Capacity OPeration"

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/assignments/opcodes.cpp:15-19`

### рдореБрдЦреНрдп рд▓реЗрдирджреЗрди рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ

- рдорд╛рдирдХ Bitcoin рд▓реЗрдирджреЗрди (рдХреЛрдИ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдкрд░рд┐рд╡рд░реНрддрди рдирд╣реАрдВ)
- OP_RETURN рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рдорд╛рдгрд┐рдд рд░реВрдк рд╕реЗ рдЕрдЦрд░реНрдЪрдиреАрдп рд╣реИрдВ (UTXO рд╕реЗрдЯ рдореЗрдВ рдХрднреА рдирд╣реАрдВ рдЬреЛрдбрд╝реЗ рдЬрд╛рддреЗ)
- Plot рд╕реНрд╡рд╛рдорд┐рддреНрд╡ plot рдкрддреЗ рд╕реЗ input[0] рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рджреНрд╡рд╛рд░рд╛ рд╕рд┐рджреНрдз
- рдХрдо рд▓рд╛рдЧрдд (~200 рдмрд╛рдЗрдЯреНрд╕, рдЖрдорддреМрд░ рдкрд░ <0.0001 BTC рд╢реБрд▓реНрдХ)
- рд╡реЙрд▓реЗрдЯ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП plot рдкрддреЗ рд╕реЗ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ UTXO рдЪреБрдирддрд╛ рд╣реИ

## рдбреЗрдЯрд╛рдмреЗрд╕ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░

### рд╕реНрдЯреЛрд░реЗрдЬ рд╕рдВрд░рдЪрдирд╛

рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдбреЗрдЯрд╛ UTXO рд╕реЗрдЯ (`chainstate/`) рдХреЗ рд╕рдорд╛рди LevelDB рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ, рд▓реЗрдХрд┐рди рдЕрд▓рдЧ рдХреБрдВрдЬреА рдЙрдкрд╕рд░реНрдЧреЛрдВ рдХреЗ рд╕рд╛рде:

```
chainstate/ LevelDB:
тФЬтФА UTXO рд╕реЗрдЯ (Bitcoin Core рдорд╛рдирдХ)
тФВ  тФФтФА 'C' рдЙрдкрд╕рд░реНрдЧ: COutPoint тЖТ Coin
тФВ
тФФтФА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐ (PoCX рдЬреЛрдбрд╝)
   тФФтФА 'A' рдЙрдкрд╕рд░реНрдЧ: (plot_address, assignment_txid) тЖТ ForgingAssignment
       тФФтФА рдкреВрд░реНрдг рдЗрддрд┐рд╣рд╛рд╕: рд╕рдордп рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐ plot рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/txdb.cpp:237-348`

### ForgingAssignment рд╕рдВрд░рдЪрдирд╛

```cpp
struct ForgingAssignment {
    // рдкрд╣рдЪрд╛рди
    std::array<uint8_t, 20> plotAddress;      // Plot рдорд╛рд▓рд┐рдХ (20-рдмрд╛рдЗрдЯ P2WPKH рд╣реИрд╢)
    std::array<uint8_t, 20> forgingAddress;   // рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрдзрд┐рдХрд╛рд░ рдзрд╛рд░рдХ (20-рдмрд╛рдЗрдЯ P2WPKH рд╣реИрд╢)

    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЬреАрд╡рдирдЪрдХреНрд░
    uint256 assignment_txid;                   // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдмрдирд╛рдиреЗ рд╡рд╛рд▓рд╛ рд▓реЗрдирджреЗрди
    int assignment_height;                     // рдирд┐рд░реНрдорд╛рдг рдмреНрд▓реЙрдХ рдКрдВрдЪрд╛рдИ
    int assignment_effective_height;           // рдЬрдм рдпрд╣ рд╕рдХреНрд░рд┐рдп рд╣реЛрддрд╛ рд╣реИ (height + delay)

    // рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдЬреАрд╡рдирдЪрдХреНрд░
    bool revoked;                              // рдХреНрдпрд╛ рдЗрд╕реЗ рдирд┐рд░рд╕реНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ?
    uint256 revocation_txid;                   // рдирд┐рд░рд╕реНрдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд▓реЗрдирджреЗрди
    int revocation_height;                     // рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдмреНрд▓реЙрдХ рдКрдВрдЪрд╛рдИ
    int revocation_effective_height;           // рдЬрдм рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдкреНрд░рднрд╛рд╡реА (height + delay)

    // рд╕реНрдерд┐рддрд┐ рдХреНрд╡реЗрд░реА рд╡рд┐рдзрд┐рдпрд╛рдВ
    ForgingState GetStateAtHeight(int height) const;
    bool IsActiveAtHeight(int height) const;
};
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/coins.h:111-178`

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐рдпрд╛рдВ

```cpp
enum class ForgingState : uint8_t {
    UNASSIGNED = 0,  // рдХреЛрдИ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдореМрдЬреВрдж рдирд╣реАрдВ
    ASSIGNING = 1,   // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдмрдирд╛рдпрд╛ рдЧрдпрд╛, рд╕рдХреНрд░рд┐рдпрдг рд╡рд┐рд▓рдВрдм рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛
    ASSIGNED = 2,    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдХреНрд░рд┐рдп, рдлреЛрд░реНрдЬрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐
    REVOKING = 3,    // рдирд┐рд░рд╕реНрдд, рд▓реЗрдХрд┐рди рд╡рд┐рд▓рдВрдм рдЕрд╡рдзрд┐ рдореЗрдВ рдЕрднреА рднреА рд╕рдХреНрд░рд┐рдп
    REVOKED = 4      // рдкреВрд░реНрдгрддрдГ рдирд┐рд░рд╕реНрдд, рдЕрдм рд╕рдХреНрд░рд┐рдп рдирд╣реАрдВ
};
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/coins.h:98-104`

### рдбреЗрдЯрд╛рдмреЗрд╕ рдХреБрдВрдЬрд┐рдпрд╛рдВ

```cpp
// рдЗрддрд┐рд╣рд╛рд╕ рдХреБрдВрдЬреА: рдкреВрд░реНрдг рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд░рд┐рдХреЙрд░реНрдб рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ
// рдХреБрдВрдЬреА рдкреНрд░рд╛рд░реВрдк: (prefix, plotAddress, assignment_height, assignment_txid)
struct AssignmentHistoryKey {
    uint8_t prefix;                       // DB_ASSIGNMENT_HISTORY = 'A'
    std::array<uint8_t, 20> plotAddress;  // Plot рдкрддрд╛ (20 рдмрд╛рдЗрдЯреНрд╕)
    int assignment_height;                // рд╕реЙрд░реНрдЯрд┐рдВрдЧ рдЕрдиреБрдХреВрд▓рди рдХреЗ рд▓рд┐рдП рдКрдВрдЪрд╛рдИ
    uint256 assignment_txid;              // Transaction ID
};
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/txdb.cpp:245-262`

### рдЗрддрд┐рд╣рд╛рд╕ рдЯреНрд░реИрдХрд┐рдВрдЧ

- рдкреНрд░рддреНрдпреЗрдХ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рд╕рдВрдЧреНрд░рд╣реАрдд (reorg рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХрднреА рдирд╣реАрдВ рд╣рдЯрд╛рдпрд╛ рдЬрд╛рддрд╛)
- рд╕рдордп рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐ plot рдХрдИ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЯреНрд░реИрдХ
- рдкреВрд░реНрдг рдСрдбрд┐рдЯ рдЯреНрд░реЗрд▓ рдФрд░ рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рд╕реНрдерд┐рддрд┐ рдХреНрд╡реЗрд░реА рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ
- рдирд┐рд░рд╕реНрдд рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ `revoked=true` рдХреЗ рд╕рд╛рде рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд░рд╣рддреЗ рд╣реИрдВ

## рдмреНрд▓реЙрдХ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ

### ConnectBlock рдПрдХреАрдХрд░рдг

рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдФрд░ рдирд┐рд░рд╕реНрддреАрдХрд░рдг OP_RETURNs `validation.cpp` рдореЗрдВ рдмреНрд▓реЙрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рджреМрд░рд╛рди рдкреНрд░реЛрд╕реЗрд╕ рд╣реЛрддреЗ рд╣реИрдВ:

```cpp
// рд╕реНрдерд╛рди: рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕рддреНрдпрд╛рдкрди рдХреЗ рдмрд╛рдж, UpdateCoins рд╕реЗ рдкрд╣рд▓реЗ
#ifdef ENABLE_POCX
for (const auto& tx : block.vtx) {
    for (const CTxOut& output : tx.vout) {
        if (IsAssignmentOpReturn(output)) {
            // OP_RETURN рдбреЗрдЯрд╛ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ
            auto [plot_addr, forge_addr] = ParseAssignmentOpReturn(output);

            // рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ (tx plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)
            if (!VerifyPlotOwnership(tx, plot_addr, view))
                return state.Invalid("bad-assignment-ownership");

            // Plot рд╕реНрдерд┐рддрд┐ рдЬрд╛рдВрдЪреЗрдВ (UNASSIGNED рдпрд╛ REVOKED рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)
            ForgingState state = GetPlotForgingState(plot_addr, height, view);
            if (state != UNASSIGNED && state != REVOKED)
                return state.Invalid("plot-not-available-for-assignment");

            // рдирдпрд╛ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдмрдирд╛рдПрдВ
            int activation_height = height + consensus.nForgingAssignmentDelay;
            ForgingAssignment assignment(plot_addr, forge_addr, tx.GetHash(),
                                       height, activation_height);

            view.AddForgingAssignment(assignment);

            // Undo рдбреЗрдЯрд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВ
            blockundo.vforgingundo.emplace_back(UndoType::ADDED, assignment);
        }
        else if (IsRevocationOpReturn(output)) {
            // OP_RETURN рдбреЗрдЯрд╛ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ
            auto plot_addr = ParseRevocationOpReturn(output);

            // рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
            if (!VerifyPlotOwnership(tx, plot_addr, view))
                return state.Invalid("bad-revocation-ownership");

            // рд╡рд░реНрддрдорд╛рди рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
            auto existing = view.GetForgingAssignment(plot_addr, height);
            if (!existing || existing->revoked)
                return state.Invalid("no-assignment-to-revoke");

            // Undo рдХреЗ рд▓рд┐рдП рдкреБрд░рд╛рдиреА рд╕реНрдерд┐рддрд┐ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВ
            blockundo.vforgingundo.emplace_back(UndoType::REVOKED, *existing);

            // рдирд┐рд░рд╕реНрдд рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рд╣реНрдирд┐рдд рдХрд░реЗрдВ
            ForgingAssignment revoked = *existing;
            revoked.revoked = true;
            revoked.revocation_txid = tx.GetHash();
            revoked.revocation_height = height;
            revoked.revocation_effective_height = height + consensus.nForgingRevocationDelay;

            view.UpdateForgingAssignment(revoked);
        }
    }
}
#endif

// UpdateCoins рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдЖрдЧреЗ рдмрдврд╝рддрд╛ рд╣реИ (OP_RETURN рдЖрдЙрдЯрдкреБрдЯ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЫреЛрдбрд╝реЗ рдЬрд╛рддреЗ рд╣реИрдВ)
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/validation.cpp:2775-2878`

### рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рддреНрдпрд╛рдкрди

```cpp
bool VerifyPlotOwnership(const CTransaction& tx,
                        const std::array<uint8_t, 20>& plotAddress,
                        const CCoinsViewCache& view)
{
    // рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХрдо рд╕реЗ рдХрдо рдПрдХ input plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реИ
    for (const auto& input : tx.vin) {
        Coin coin = view.GetCoin(input.prevout);
        if (!coin) continue;

        // рдЧрдВрддрд╡реНрдп рдирд┐рдХрд╛рд▓реЗрдВ
        CTxDestination dest;
        if (!ExtractDestination(coin.out.scriptPubKey, dest)) continue;

        // рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ plot рдкрддреЗ рдХреЛ P2WPKH
        if (auto* witness_addr = std::get_if<WitnessV0KeyHash>(&dest)) {
            if (std::equal(witness_addr->begin(), witness_addr->end(),
                          plotAddress.begin())) {
                // Bitcoin Core рдиреЗ рдкрд╣рд▓реЗ рд╣реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░ рджрд┐рдпрд╛
                return true;
            }
        }
    }
    return false;
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/assignments/opcodes.cpp:217-256`

### рд╕рдХреНрд░рд┐рдпрдг рд╡рд┐рд▓рдВрдм

рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдФрд░ рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдореЗрдВ reorg рд╣рдорд▓реЛрдВ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдпреЛрдЧреНрдп рд╕рдХреНрд░рд┐рдпрдг рд╡рд┐рд▓рдВрдм рд╣реИрдВ:

```cpp
// рд╕рд╣рдорддрд┐ рдкреИрд░рд╛рдореАрдЯрд░ (рдкреНрд░рддрд┐ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдпреЛрдЧреНрдп)
// рдЙрджрд╛рд╣рд░рдг: 30 рдмреНрд▓реЙрдХ = 2-рдорд┐рдирдЯ рдмреНрд▓реЙрдХ рд╕рдордп рдХреЗ рд╕рд╛рде ~1 рдШрдВрдЯрд╛
consensus.nForgingAssignmentDelay;   // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдХреНрд░рд┐рдпрдг рд╡рд┐рд▓рдВрдм
consensus.nForgingRevocationDelay;   // рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд╕рдХреНрд░рд┐рдпрдг рд╡рд┐рд▓рдВрдм
```

**рд╕реНрдерд┐рддрд┐ рд╕рдВрдХреНрд░рдордг:**
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ: `UNASSIGNED тЖТ ASSIGNING (рд╡рд┐рд▓рдВрдм) тЖТ ASSIGNED`
- рдирд┐рд░рд╕реНрддреАрдХрд░рдг: `ASSIGNED тЖТ REVOKING (рд╡рд┐рд▓рдВрдм) тЖТ REVOKED`

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/consensus/params.h`, `src/kernel/chainparams.cpp`

## Mempool рд╕рддреНрдпрд╛рдкрди

рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░рд╕рд╛рд░ рд╕реЗ рдкрд╣рд▓реЗ рдЕрдорд╛рдиреНрдп рд▓реЗрдирджреЗрди рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдФрд░ рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд▓реЗрдирджреЗрди mempool рд╕реНрд╡реАрдХреГрддрд┐ рдкрд░ рд╕рддреНрдпрд╛рдкрд┐рдд рд╣реЛрддреЗ рд╣реИрдВред

### рд▓реЗрдирджреЗрди-рд╕реНрддрд░ рдЬрд╛рдВрдЪ (CheckTransaction)

рдЪреЗрди рд╕реНрдерд┐рддрд┐ рдПрдХреНрд╕реЗрд╕ рдХреЗ рдмрд┐рдирд╛ `src/consensus/tx_check.cpp` рдореЗрдВ рдХреА рдЬрд╛рддреА рд╣реИ:

1. **рдЕрдзрд┐рдХрддрдо рдПрдХ POCX OP_RETURN:** рд▓реЗрдирджреЗрди рдореЗрдВ рдХрдИ POCX/XCOP рдорд╛рд░реНрдХрд░ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/consensus/tx_check.cpp:63-77`

### Mempool рд╕реНрд╡реАрдХреГрддрд┐ рдЬрд╛рдВрдЪ (PreChecks)

рдкреВрд░реНрдг рдЪреЗрди рд╕реНрдерд┐рддрд┐ рдФрд░ mempool рдПрдХреНрд╕реЗрд╕ рдХреЗ рд╕рд╛рде `src/validation.cpp` рдореЗрдВ рдХреА рдЬрд╛рддреА рд╣реИ:

#### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рддреНрдпрд╛рдкрди

1. **Plot рд╕реНрд╡рд╛рдорд┐рддреНрд╡:** рд▓реЗрдирджреЗрди plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
2. **Plot рд╕реНрдерд┐рддрд┐:** Plot UNASSIGNED (0) рдпрд╛ REVOKED (4) рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
3. **Mempool рд╡рд┐рд░реЛрдз:** Mempool рдореЗрдВ рдЗрд╕ plot рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЕрдиреНрдп рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд╣реАрдВ (рдкрд╣рд▓реЗ-рджреЗрдЦрд╛-рдЬреАрддрд╛)

#### рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд╕рддреНрдпрд╛рдкрди

1. **Plot рд╕реНрд╡рд╛рдорд┐рддреНрд╡:** рд▓реЗрдирджреЗрди plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
2. **рд╕рдХреНрд░рд┐рдп рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ:** Plot рдХреЗрд╡рд▓ ASSIGNED (2) рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
3. **Mempool рд╡рд┐рд░реЛрдз:** Mempool рдореЗрдВ рдЗрд╕ plot рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЕрдиреНрдп рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдирд╣реАрдВ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/validation.cpp:898-993`

### рд╕рддреНрдпрд╛рдкрди рдкреНрд░рд╡рд╛рд╣

```
рд▓реЗрдирджреЗрди рдкреНрд░рд╕рд╛рд░рдг
       тЖУ
CheckTransaction() [tx_check.cpp]
  тЬУ рдЕрдзрд┐рдХрддрдо рдПрдХ POCX OP_RETURN
       тЖУ
MemPoolAccept::PreChecks() [validation.cpp]
  тЬУ Plot рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ
  тЬУ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐ рдЬрд╛рдВрдЪреЗрдВ
  тЬУ Mempool рд╡рд┐рд░реЛрдз рдЬрд╛рдВрдЪреЗрдВ
       тЖУ
   рд╡реИрдз тЖТ Mempool рдореЗрдВ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ
   рдЕрдорд╛рдиреНрдп тЖТ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ (рдкреНрд░рд╕рд╛рд░рд┐рдд рди рдХрд░реЗрдВ)
       тЖУ
рдмреНрд▓реЙрдХ рдорд╛рдЗрдирд┐рдВрдЧ
       тЖУ
ConnectBlock() [validation.cpp]
  тЬУ рд╕рднреА рдЬрд╛рдВрдЪ рдкреБрдирдГ-рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ (рдЧрд╣рди рд░рдХреНрд╖рд╛)
  тЬУ рд╕реНрдерд┐рддрд┐ рдкрд░рд┐рд╡рд░реНрддрди рд▓рд╛рдЧреВ рдХрд░реЗрдВ
  тЬУ Undo рдЬрд╛рдирдХрд╛рд░реА рд░рд┐рдХреЙрд░реНрдб рдХрд░реЗрдВ
```

### рдЧрд╣рди рд░рдХреНрд╖рд╛

рд╕рднреА mempool рд╕рддреНрдпрд╛рдкрди рдЬрд╛рдВрдЪ рдЗрдирдХреЗ рд╡рд┐рд░реБрджреНрдз рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП `ConnectBlock()` рдХреЗ рджреМрд░рд╛рди рдкреБрдирдГ-рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддреА рд╣реИрдВ:
- Mempool рдмрд╛рдИрдкрд╛рд╕ рд╣рдорд▓реЗ
- рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдорд╛рдЗрдирд░реНрд╕ рд╕реЗ рдЕрдорд╛рдиреНрдп рдмреНрд▓реЙрдХ
- Reorg рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдХреЗ рджреМрд░рд╛рди рдПрдЬ рдХреЗрд╕

рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди рд╕рд╣рдорддрд┐ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрд╛рд░рд┐рдХ рд░рд╣рддрд╛ рд╣реИред

## рдкрд░рдорд╛рдгреБ рдбреЗрдЯрд╛рдмреЗрд╕ рдЕрдкрдбреЗрдЯ

### рддреАрди-рдкрд░рдд рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ   CCoinsViewCache (рдореЗрдореЛрд░реА рдХреИрд╢)          тФВ  тЖР рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкрд░рд┐рд╡рд░реНрддрди рдореЗрдореЛрд░реА рдореЗрдВ рдЯреНрд░реИрдХ
тФВ   - Coins: cacheCoins                   тФВ
тФВ   - Assignments: pendingAssignments     тФВ
тФВ   - Dirty рдЯреНрд░реИрдХрд┐рдВрдЧ: dirtyPlots          тФВ
тФВ   - Deletions: deletedAssignments       тФВ
тФВ   - рдореЗрдореЛрд░реА рдЯреНрд░реИрдХрд┐рдВрдЧ: cachedAssignmentsUsage тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                    тЖУ Flush()
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ   CCoinsViewDB (рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░рдд)            тФВ  тЖР рдПрдХрд▓ рдкрд░рдорд╛рдгреБ рд▓реЗрдЦрди
тФВ   - BatchWrite(): UTXOs + Assignments   тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                    тЖУ WriteBatch()
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ   LevelDB (рдбрд┐рд╕реНрдХ рд╕реНрдЯреЛрд░реЗрдЬ)               тФВ  тЖР ACID рдЧрд╛рд░рдВрдЯреА
тФВ   - рдкрд░рдорд╛рдгреБ рд▓реЗрдирджреЗрди                       тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### Flush рдкреНрд░рдХреНрд░рд┐рдпрд╛

рдЬрдм рдмреНрд▓реЙрдХ рдХрдиреЗрдХреНрд╢рди рдХреЗ рджреМрд░рд╛рди `view.Flush()` рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

```cpp
bool CCoinsViewCache::Flush() {
    // 1. Coin рдкрд░рд┐рд╡рд░реНрддрди рдмреЗрд╕ рдореЗрдВ рд▓рд┐рдЦреЗрдВ
    auto cursor = CoinsViewCacheCursor(/*...*/, /*will_erase=*/true);
    bool fOk = base->BatchWrite(cursor, hashBlock);

    // 2. рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкрд░рд┐рд╡рд░реНрддрди рдкрд░рдорд╛рдгреБ рд░реВрдк рд╕реЗ рд▓рд┐рдЦреЗрдВ
    if (fOk && !dirtyPlots.empty()) {
        // Dirty рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдПрдХрддреНрд░ рдХрд░реЗрдВ
        ForgingAssignmentsMap assignmentsToWrite;
        PlotAddressAssignmentMap currentToWrite;  // рдЦрд╛рд▓реА - рдЕрдкреНрд░рдпреБрдХреНрдд

        for (const auto& plotAddr : dirtyPlots) {
            auto it = pendingAssignments.find(plotAddr);
            if (it != pendingAssignments.end()) {
                for (const auto& assignment : it->second) {
                    assignmentsToWrite[{plotAddr, assignment}] = assignment;
                }
            }
        }

        // рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд▓рд┐рдЦреЗрдВ
        fOk = base->BatchWriteAssignments(assignmentsToWrite, currentToWrite,
                                         deletedAssignments);

        if (fOk) {
            // рдЯреНрд░реИрдХрд┐рдВрдЧ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
            dirtyPlots.clear();
            deletedAssignments.clear();
        }
    }

    if (fOk) {
        cacheCoins.clear();  // рдореЗрдореЛрд░реА рд░рд┐рд▓реАрдЬрд╝ рдХрд░реЗрдВ
        pendingAssignments.clear();
        cachedAssignmentsUsage = 0;
    }

    return fOk;
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/coins.cpp:278-315`

### рдбреЗрдЯрд╛рдмреЗрд╕ рдмреИрдЪ рд▓реЗрдЦрди

```cpp
bool CCoinsViewDB::BatchWrite(CoinsViewCacheCursor& cursor, const uint256& hashBlock) {
    CDBBatch batch(*m_db);  // рдПрдХрд▓ LevelDB рдмреИрдЪ

    // 1. рд╕рдВрдХреНрд░рдордг рд╕реНрдерд┐рддрд┐ рдЪрд┐рд╣реНрдирд┐рдд рдХрд░реЗрдВ
    batch.Write(DB_HEAD_BLOCKS, Vector(hashBlock, old_tip));

    // 2. рд╕рднреА coin рдкрд░рд┐рд╡рд░реНрддрди рд▓рд┐рдЦреЗрдВ
    for (auto it = cursor.Begin(); it != cursor.End(); it = cursor.NextAndMaybeErase(*it)) {
        if (it->second.coin.IsSpent())
            batch.Erase(CoinKey(it->first));
        else
            batch.Write(CoinKey(it->first), it->second.coin);
    }

    // 3. рд╕реБрд╕рдВрдЧрдд рд╕реНрдерд┐рддрд┐ рдЪрд┐рд╣реНрдирд┐рдд рдХрд░реЗрдВ
    batch.Write(DB_BEST_BLOCK, hashBlock);

    // 4. рдкрд░рдорд╛рдгреБ COMMIT
    bool ret = m_db->WriteBatch(batch);

    return ret;
}

// рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЕрд▓рдЧ рд╕реЗ рд▓реЗрдХрд┐рди рд╕рдорд╛рди рдбреЗрдЯрд╛рдмреЗрд╕ рд▓реЗрдирджреЗрди рд╕рдВрджрд░реНрдн рдореЗрдВ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ
bool CCoinsViewDB::BatchWriteAssignments(
    const ForgingAssignmentsMap& assignments,
    const PlotAddressAssignmentMap& currentAssignments,  // рдЕрдкреНрд░рдпреБрдХреНрдд рдкреИрд░рд╛рдореАрдЯрд░ (API рд╕рдВрдЧрддрддрд╛ рдХреЗ рд▓рд┐рдП рд░рдЦрд╛ рдЧрдпрд╛)
    const DeletedAssignmentsSet& deletedAssignments)
{
    CDBBatch batch(*m_db);  // рдирдпрд╛ рдмреИрдЪ, рд▓реЗрдХрд┐рди рд╕рдорд╛рди рдбреЗрдЯрд╛рдмреЗрд╕

    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЗрддрд┐рд╣рд╛рд╕ рд▓рд┐рдЦреЗрдВ
    for (const auto& [key, assignment] : assignments) {
        const auto& [plot_addr, txid] = key;
        batch.Write(AssignmentHistoryKey(plot_addr, txid), assignment);
    }

    // рдЗрддрд┐рд╣рд╛рд╕ рд╕реЗ рд╣рдЯрд╛рдП рдЧрдП рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдорд┐рдЯрд╛рдПрдВ
    for (const auto& [plot_addr, txid] : deletedAssignments) {
        batch.Erase(AssignmentHistoryKey(plot_addr, txid));
    }

    // рдкрд░рдорд╛рдгреБ COMMIT
    return m_db->WriteBatch(batch);
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/txdb.cpp:332-348`

### рдкрд░рдорд╛рдгреБрддрд╛ рдЧрд╛рд░рдВрдЯреА

тЬЕ **рдХреНрдпрд╛ рдкрд░рдорд╛рдгреБ рд╣реИ:**
- рдПрдХ рдмреНрд▓реЙрдХ рдХреЗ рднреАрддрд░ рд╕рднреА coin рдкрд░рд┐рд╡рд░реНрддрди рдкрд░рдорд╛рдгреБ рд░реВрдк рд╕реЗ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ
- рдПрдХ рдмреНрд▓реЙрдХ рдХреЗ рднреАрддрд░ рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкрд░рд┐рд╡рд░реНрддрди рдкрд░рдорд╛рдгреБ рд░реВрдк рд╕реЗ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ
- рдХреНрд░реИрд╢ рдореЗрдВ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реБрд╕рдВрдЧрдд рд░рд╣рддрд╛ рд╣реИ

тЪая╕П **рд╡рд░реНрддрдорд╛рди рд╕реАрдорд╛:**
- Coins рдФрд░ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ `view.Flush()` рдХреЗ рджреМрд░рд╛рди **рдЕрд▓рдЧ** LevelDB рдмреИрдЪ рдСрдкрд░реЗрд╢рди рдореЗрдВ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ
- рджреЛрдиреЛрдВ рдСрдкрд░реЗрд╢рди `view.Flush()` рдХреЗ рджреМрд░рд╛рди рд╣реЛрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдПрдХрд▓ рдкрд░рдорд╛рдгреБ рд▓реЗрдЦрди рдореЗрдВ рдирд╣реАрдВ
- рд╡реНрдпрд╡рд╣рд╛рд░ рдореЗрдВ: рдбрд┐рд╕реНрдХ fsync рд╕реЗ рдкрд╣рд▓реЗ рджреЛрдиреЛрдВ рдмреИрдЪ рддреЗрдЬрд╝реА рд╕реЗ рдкреВрд░реЗ рд╣реЛрддреЗ рд╣реИрдВ
- рдЬреЛрдЦрд┐рдо рдиреНрдпреВрдирддрдо рд╣реИ: рдХреНрд░реИрд╢ рд░рд┐рдХрд╡рд░реА рдХреЗ рджреМрд░рд╛рди рджреЛрдиреЛрдВ рдХреЛ рдПрдХ рд╣реА рдмреНрд▓реЙрдХ рд╕реЗ рд░рд┐рдкреНрд▓реЗ рдХрд░рдирд╛ рд╣реЛрдЧрд╛

**рдиреЛрдЯ:** рдпрд╣ рдореВрд▓ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдпреЛрдЬрдирд╛ рд╕реЗ рднрд┐рдиреНрди рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХрд▓ рдПрдХреАрдХреГрдд рдмреИрдЪ рдХреА рдорд╛рдВрдЧ рдХреА рдЧрдИ рдереАред рд╡рд░реНрддрдорд╛рди рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рджреЛ рдмреИрдЪ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди Bitcoin Core рдХреЗ рдореМрдЬреВрджрд╛ рдХреНрд░реИрд╢ рд░рд┐рдХрд╡рд░реА рддрдВрддреНрд░ (DB_HEAD_BLOCKS рдорд╛рд░реНрдХрд░) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реБрд╕рдВрдЧрддрддрд╛ рдмрдирд╛рдП рд░рдЦрддрд╛ рд╣реИред

## Reorg рд╣реИрдВрдбрд▓рд┐рдВрдЧ

### Undo рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛

```cpp
struct ForgingUndo {
    enum class UndoType : uint8_t {
        ADDED = 0,      // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рдерд╛ (undo рдкрд░ рд╣рдЯрд╛рдПрдВ)
        MODIFIED = 1,   // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (undo рдкрд░ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ)
        REVOKED = 2     // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд┐рд░рд╕реНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (undo рдкрд░ рдЕрди-рдирд┐рд░рд╕реНрдд рдХрд░реЗрдВ)
    };

    UndoType type;
    ForgingAssignment assignment;  // рдкрд░рд┐рд╡рд░реНрддрди рд╕реЗ рдкрд╣рд▓реЗ рдкреВрд░реНрдг рд╕реНрдерд┐рддрд┐
};

struct CBlockUndo {
    std::vector<CTxUndo> vtxundo;           // UTXO undo рдбреЗрдЯрд╛
    std::vector<ForgingUndo> vforgingundo;  // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ undo рдбреЗрдЯрд╛
};
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/undo.h:63-105`

### DisconnectBlock рдкреНрд░рдХреНрд░рд┐рдпрд╛

рдЬрдм рдПрдХ reorg рдХреЗ рджреМрд░рд╛рди рдмреНрд▓реЙрдХ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рд╣реЛрддрд╛ рд╣реИ:

```cpp
DisconnectResult Chainstate::DisconnectBlock(const CBlock& block,
                                              const CBlockIndex* pindex,
                                              CCoinsViewCache& view)
{
    // ... рдорд╛рдирдХ UTXO рдбрд┐рд╕реНрдХрдиреЗрдХреНрд╢рди ...

    // рдбрд┐рд╕реНрдХ рд╕реЗ undo рдбреЗрдЯрд╛ рдкрдврд╝реЗрдВ
    CBlockUndo blockUndo;
    if (!ReadBlockUndo(blockUndo, *pindex))
        return DISCONNECT_FAILED;

    #ifdef ENABLE_POCX
    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкрд░рд┐рд╡рд░реНрддрди undo рдХрд░реЗрдВ (рдЙрд▓реНрдЯреЗ рдХреНрд░рдо рдореЗрдВ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░реЗрдВ)
    for (auto it = blockUndo.vforgingundo.rbegin();
         it != blockUndo.vforgingundo.rend(); ++it) {

        switch (it->type) {
            case UndoType::ADDED:
                // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рдерд╛ - рдЗрд╕реЗ рд╣рдЯрд╛рдПрдВ
                view.RemoveForgingAssignment(
                    it->assignment.plotAddress,
                    it->assignment.assignment_txid
                );
                break;

            case UndoType::REVOKED:
                // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд┐рд░рд╕реНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ - рдЕ-рдирд┐рд░рд╕реНрдд рд╕реНрдерд┐рддрд┐ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ
                view.RestoreForgingAssignment(it->assignment);
                break;

            case UndoType::MODIFIED:
                // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ - рдкрд┐рдЫрд▓реА рд╕реНрдерд┐рддрд┐ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ
                view.UpdateForgingAssignment(it->assignment);
                break;
        }
    }
    #endif

    return DISCONNECT_OK;
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/validation.cpp:2381-2415`

### Reorg рдХреЗ рджреМрд░рд╛рди рдХреИрд╢ рдкреНрд░рдмрдВрдзрди

```cpp
class CCoinsViewCache {
private:
    // рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдХреИрд╢
    mutable std::map<std::array<uint8_t, 20>, std::vector<ForgingAssignment>> pendingAssignments;
    mutable std::set<std::array<uint8_t, 20>> dirtyPlots;  // рд╕рдВрд╢реЛрдзрд┐рдд plots рдЯреНрд░реИрдХ рдХрд░реЗрдВ
    mutable std::set<std::pair<std::array<uint8_t, 20>, uint256>> deletedAssignments;  // рд╣рдЯрд╛рдиреЗ рдЯреНрд░реИрдХ рдХрд░реЗрдВ
    mutable size_t cachedAssignmentsUsage{0};  // рдореЗрдореЛрд░реА рдЯреНрд░реИрдХрд┐рдВрдЧ

public:
    void AddForgingAssignment(const ForgingAssignment& assignment) {
        pendingAssignments[assignment.plotAddress].push_back(assignment);
        dirtyPlots.insert(assignment.plotAddress);
        cachedAssignmentsUsage += sizeof(ForgingAssignment);
    }

    void RemoveForgingAssignment(const std::array<uint8_t, 20>& plotAddress,
                                 const uint256& assignment_txid) {
        auto key = std::make_pair(plotAddress, assignment_txid);
        deletedAssignments.insert(key);
        dirtyPlots.insert(plotAddress);
        if (cachedAssignmentsUsage >= sizeof(ForgingAssignment)) {
            cachedAssignmentsUsage -= sizeof(ForgingAssignment);
        }
    }

    void RestoreForgingAssignment(const ForgingAssignment& assignment) {
        pendingAssignments[assignment.plotAddress].push_back(assignment);
        dirtyPlots.insert(assignment.plotAddress);
        auto key = std::make_pair(assignment.plotAddress, assignment.assignment_txid);
        deletedAssignments.erase(key);
        if (true) {
            cachedAssignmentsUsage += sizeof(ForgingAssignment);
        }
    }
};
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/coins.cpp:494-565`

## RPC рдЗрдВрдЯрд░рдлрд╝реЗрд╕

### рдиреЛрдб рдХрдорд╛рдВрдб (рдХреЛрдИ рд╡реЙрд▓реЗрдЯ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ)

#### get_assignment
```bash
bitcoin-cli get_assignment "pocx1qplot..."
```

Plot рдкрддреЗ рдХреЗ рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐ рд▓реМрдЯрд╛рддрд╛ рд╣реИ:
```json
{
  "plot_address": "pocx1qplot...",
  "has_assignment": true,
  "state": "ASSIGNED",
  "forging_address": "pocx1qforger...",
  "assignment_txid": "abc123...",
  "assignment_height": 100,
  "activation_height": 244,
  "revoked": false
}
```

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/rpc/assignments.cpp:31-126`

### рд╡реЙрд▓реЗрдЯ рдХрдорд╛рдВрдб (рд╡реЙрд▓реЗрдЯ рдЖрд╡рд╢реНрдпрдХ)

#### create_assignment
```bash
bitcoin-cli create_assignment "pocx1qplot..." "pocx1qforger..."
```

рдПрдХ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд▓реЗрдирджреЗрди рдмрдирд╛рддрд╛ рд╣реИ:
- рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП plot рдкрддреЗ рд╕реЗ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ UTXO рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЪреБрдирддрд╛ рд╣реИ
- OP_RETURN + change рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд╕рд╛рде рд▓реЗрдирджреЗрди рдмрдирд╛рддрд╛ рд╣реИ
- Plot рдорд╛рд▓рд┐рдХ рдХреА рдХреБрдВрдЬреА рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рддрд╛ рд╣реИ
- рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/rpc/assignments_wallet.cpp:29-93`

#### revoke_assignment
```bash
bitcoin-cli revoke_assignment "pocx1qplot..."
```

рдПрдХ рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд▓реЗрдирджреЗрди рдмрдирд╛рддрд╛ рд╣реИ:
- рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП plot рдкрддреЗ рд╕реЗ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ UTXO рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЪреБрдирддрд╛ рд╣реИ
- OP_RETURN + change рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд╕рд╛рде рд▓реЗрдирджреЗрди рдмрдирд╛рддрд╛ рд╣реИ
- Plot рдорд╛рд▓рд┐рдХ рдХреА рдХреБрдВрдЬреА рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рддрд╛ рд╣реИ
- рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/rpc/assignments_wallet.cpp:95-154`

### рд╡реЙрд▓реЗрдЯ рд▓реЗрдирджреЗрди рдирд┐рд░реНрдорд╛рдг

рд╡реЙрд▓реЗрдЯ рд▓реЗрдирджреЗрди рдирд┐рд░реНрдорд╛рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛:

```cpp
1. рдкрддреЗ рдкрд╛рд░реНрд╕ рдФрд░ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ (P2WPKH bech32 рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)
2. Plot рдкрддреЗ рд╕реЗ рд╕рдмрд╕реЗ рдмрдбрд╝рд╛ UTXO рдЦреЛрдЬреЗрдВ (рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рддрд╛ рд╣реИ)
3. рдбрдореА рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд╕рд╛рде рдЕрд╕реНрдерд╛рдпреА рд▓реЗрдирджреЗрди рдмрдирд╛рдПрдВ
4. рд▓реЗрдирджреЗрди рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░реЗрдВ (witness рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рд╕рдЯреАрдХ рдЖрдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ)
5. рдбрдореА рдЖрдЙрдЯрдкреБрдЯ рдХреЛ OP_RETURN рд╕реЗ рдмрджрд▓реЗрдВ
6. рдЖрдХрд╛рд░ рдкрд░рд┐рд╡рд░реНрддрди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╢реБрд▓реНрдХ рдЖрдиреБрдкрд╛рддрд┐рдХ рд░реВрдк рд╕реЗ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░реЗрдВ
7. рдЕрдВрддрд┐рдо рд▓реЗрдирджреЗрди рдкрд░ рдкреБрдирдГ-рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░реЗрдВ
8. рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкреНрд░рд╕рд╛рд░рд┐рдд рдХрд░реЗрдВ
```

**рдореБрдЦреНрдп рдЕрдВрддрд░реНрджреГрд╖реНрдЯрд┐:** рд╡реЙрд▓реЗрдЯ рдХреЛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рд┐рджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП plot рдкрддреЗ рд╕реЗ рдЦрд░реНрдЪ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЙрд╕ рдкрддреЗ рд╕реЗ coin рдЪрдпрди рдХреЛ рдордЬрдмреВрд░ рдХрд░рддрд╛ рд╣реИред

**рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди:** `src/pocx/assignments/transactions.cpp:38-263`

## рдлрд╝рд╛рдЗрд▓ рд╕рдВрд░рдЪрдирд╛

### рдХреЛрд░ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдлрд╝рд╛рдЗрд▓реЗрдВ

```
src/
тФЬтФАтФА coins.h                        # ForgingAssignment struct, CCoinsViewCache рд╡рд┐рдзрд┐рдпрд╛рдВ [710 рдкрдВрдХреНрддрд┐рдпрд╛рдВ]
тФЬтФАтФА coins.cpp                      # рдХреИрд╢ рдкреНрд░рдмрдВрдзрди, рдмреИрдЪ рд▓реЗрдЦрди [603 рдкрдВрдХреНрддрд┐рдпрд╛рдВ]
тФВ
тФЬтФАтФА txdb.h                         # CCoinsViewDB рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╡рд┐рдзрд┐рдпрд╛рдВ [90 рдкрдВрдХреНрддрд┐рдпрд╛рдВ]
тФЬтФАтФА txdb.cpp                       # рдбреЗрдЯрд╛рдмреЗрд╕ рдкрдврд╝рдирд╛/рд▓рд┐рдЦрдирд╛ [349 рдкрдВрдХреНрддрд┐рдпрд╛рдВ]
тФВ
тФЬтФАтФА undo.h                         # Reorgs рдХреЗ рд▓рд┐рдП ForgingUndo рд╕рдВрд░рдЪрдирд╛
тФВ
тФЬтФАтФА validation.cpp                 # ConnectBlock/DisconnectBlock рдПрдХреАрдХрд░рдг
тФВ
тФФтФАтФА pocx/
    тФЬтФАтФА assignments/
    тФВ   тФЬтФАтФА opcodes.h              # OP_RETURN рдкреНрд░рд╛рд░реВрдк, рдкрд╛рд░реНрд╕рд┐рдВрдЧ, рд╕рддреНрдпрд╛рдкрди
    тФВ   тФЬтФАтФА opcodes.cpp            # [259 рдкрдВрдХреНрддрд┐рдпрд╛рдВ] рдорд╛рд░реНрдХрд░ рдкрд░рд┐рднрд╛рд╖рд╛рдПрдВ, OP_RETURN ops, рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдЬрд╛рдВрдЪ
    тФВ   тФЬтФАтФА assignment_state.h     # GetEffectiveSigner, GetAssignmentState рд╕рд╣рд╛рдпрдХ
    тФВ   тФЬтФАтФА assignment_state.cpp   # рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдерд┐рддрд┐ рдХреНрд╡реЗрд░реА рдлрд╝рдВрдХреНрд╢рди
    тФВ   тФЬтФАтФА transactions.h         # рд╡реЙрд▓реЗрдЯ рд▓реЗрдирджреЗрди рдирд┐рд░реНрдорд╛рдг API
    тФВ   тФФтФАтФА transactions.cpp       # create_assignment, revoke_assignment рд╡реЙрд▓реЗрдЯ рдлрд╝рдВрдХреНрд╢рди
    тФВ
    тФЬтФАтФА rpc/
    тФВ   тФЬтФАтФА assignments.h          # рдиреЛрдб RPC рдХрдорд╛рдВрдб (рдХреЛрдИ рд╡реЙрд▓реЗрдЯ рдирд╣реАрдВ)
    тФВ   тФЬтФАтФА assignments.cpp        # get_assignment, list_assignments RPCs
    тФВ   тФЬтФАтФА assignments_wallet.h   # рд╡реЙрд▓реЗрдЯ RPC рдХрдорд╛рдВрдб
    тФВ   тФФтФАтФА assignments_wallet.cpp # create_assignment, revoke_assignment RPCs
    тФВ
    тФФтФАтФА consensus/
        тФФтФАтФА params.h               # nForgingAssignmentDelay, nForgingRevocationDelay
```

## рдкреНрд░рджрд░реНрд╢рди рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ

### рдбреЗрдЯрд╛рдмреЗрд╕ рд╕рдВрдЪрд╛рд▓рди

- **рд╡рд░реНрддрдорд╛рди рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:** O(n) - рд╕рдмрд╕реЗ рд╣рд╛рд▓ рдХрд╛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП plot рдкрддреЗ рдХреЗ рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕реНрдХреИрди рдХрд░реЗрдВ
- **рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЗрддрд┐рд╣рд╛рд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:** O(n) - plot рдХреЗ рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкрд░ iterate рдХрд░реЗрдВ
- **рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдмрдирд╛рдПрдВ:** O(1) - рдПрдХрд▓ insert
- **рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд┐рд░рд╕реНрдд рдХрд░реЗрдВ:** O(1) - рдПрдХрд▓ update
- **Reorg (рдкреНрд░рддрд┐ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ):** O(1) - рд╕реАрдзрд╛ undo рдбреЗрдЯрд╛ рдЕрдиреБрдкреНрд░рдпреЛрдЧ

рдЬрд╣рд╛рдВ n = plot рдХреЗ рд▓рд┐рдП рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдХреА рд╕рдВрдЦреНрдпрд╛ (рдЖрдорддреМрд░ рдкрд░ рдЫреЛрдЯреА, < 10)

### рдореЗрдореЛрд░реА рдЙрдкрдпреЛрдЧ

- **рдкреНрд░рддрд┐ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ:** ~160 рдмрд╛рдЗрдЯреНрд╕ (ForgingAssignment struct)
- **рдХреИрд╢ рдУрд╡рд░рд╣реЗрдб:** Dirty рдЯреНрд░реИрдХрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╣реИрд╢ рдореИрдк рдУрд╡рд░рд╣реЗрдб
- **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдмреНрд▓реЙрдХ:** <10 рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ = <2 KB рдореЗрдореЛрд░реА

### рдбрд┐рд╕реНрдХ рдЙрдкрдпреЛрдЧ

- **рдкреНрд░рддрд┐ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ:** рдбрд┐рд╕реНрдХ рдкрд░ ~200 рдмрд╛рдЗрдЯреНрд╕ (LevelDB рдУрд╡рд░рд╣реЗрдб рдХреЗ рд╕рд╛рде)
- **10000 рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ:** ~2 MB рдбрд┐рд╕реНрдХ рд╕реНрдерд╛рди
- **UTXO рд╕реЗрдЯ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдирдЧрдгреНрдп:** рд╡рд┐рд╢рд┐рд╖реНрдЯ chainstate рдХрд╛ <0.001%

## рд╡рд░реНрддрдорд╛рди рд╕реАрдорд╛рдПрдВ рдФрд░ рднрд╡рд┐рд╖реНрдп рдХрд╛ рдХрд╛рд░реНрдп

### рдкрд░рдорд╛рдгреБрддрд╛ рд╕реАрдорд╛

**рд╡рд░реНрддрдорд╛рди:** `view.Flush()` рдХреЗ рджреМрд░рд╛рди Coins рдФрд░ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЕрд▓рдЧ LevelDB рдмреИрдЪ рдореЗрдВ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ

**рдкреНрд░рднрд╛рд╡:** рдмреИрдЪ рдХреЗ рдмреАрдЪ рдХреНрд░реИрд╢ рд╣реЛрдиреЗ рдкрд░ рдЕрд╕рдВрдЧрддрддрд╛ рдХрд╛ рд╕реИрджреНрдзрд╛рдВрддрд┐рдХ рдЬреЛрдЦрд┐рдо

**рд╢рдорди:**
- рджреЛрдиреЛрдВ рдмреИрдЪ fsync рд╕реЗ рдкрд╣рд▓реЗ рддреЗрдЬрд╝реА рд╕реЗ рдкреВрд░реЗ рд╣реЛрддреЗ рд╣реИрдВ
- Bitcoin Core рдХреА рдХреНрд░реИрд╢ рд░рд┐рдХрд╡рд░реА DB_HEAD_BLOCKS рдорд╛рд░реНрдХрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИ
- рд╡реНрдпрд╡рд╣рд╛рд░ рдореЗрдВ: рдкрд░реАрдХреНрд╖рдг рдореЗрдВ рдХрднреА рдирд╣реАрдВ рджреЗрдЦрд╛ рдЧрдпрд╛

**рднрд╡рд┐рд╖реНрдп рд╕реБрдзрд╛рд░:** рдПрдХрд▓ LevelDB рдмреИрдЪ рдСрдкрд░реЗрд╢рди рдореЗрдВ рдПрдХреАрдХреГрдд рдХрд░реЗрдВ

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЗрддрд┐рд╣рд╛рд╕ рдкреНрд░реВрдирд┐рдВрдЧ

**рд╡рд░реНрддрдорд╛рди:** рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдЕрдирд┐рд╢реНрдЪрд┐рдд рдХрд╛рд▓ рддрдХ рд╕рдВрдЧреНрд░рд╣реАрдд

**рдкреНрд░рднрд╛рд╡:** рдкреНрд░рддрд┐ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ ~200 рдмрд╛рдЗрдЯреНрд╕ рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП

**рднрд╡рд┐рд╖реНрдп:** N рдмреНрд▓реЙрдХ рд╕реЗ рдкреБрд░рд╛рдиреЗ рдкреВрд░реНрдгрддрдГ-рдирд┐рд░рд╕реНрдд рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдХрд╛ рд╡реИрдХрд▓реНрдкрд┐рдХ рдкреНрд░реВрдирд┐рдВрдЧ

**рдиреЛрдЯ:** рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдирд╣реАрдВ - 1 рдорд┐рд▓рд┐рдпрди рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рднреА = 200 MB

## рдкрд░реАрдХреНрд╖рдг рд╕реНрдерд┐рддрд┐

### рд▓рд╛рдЧреВ рдкрд░реАрдХреНрд╖рдг

тЬЕ OP_RETURN рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдФрд░ рд╕рддреНрдпрд╛рдкрди
тЬЕ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕рддреНрдпрд╛рдкрди
тЬЕ ConnectBlock рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд┐рд░реНрдорд╛рдг
тЬЕ ConnectBlock рдирд┐рд░рд╕реНрддреАрдХрд░рдг
тЬЕ DisconnectBlock reorg рд╣реИрдВрдбрд▓рд┐рдВрдЧ
тЬЕ рдбреЗрдЯрд╛рдмреЗрд╕ рдкрдврд╝рдирд╛/рд▓рд┐рдЦрдирд╛ рд╕рдВрдЪрд╛рд▓рди
тЬЕ рд╕реНрдерд┐рддрд┐ рд╕рдВрдХреНрд░рдордг (UNASSIGNED тЖТ ASSIGNING тЖТ ASSIGNED тЖТ REVOKING тЖТ REVOKED)
тЬЕ RPC рдХрдорд╛рдВрдб (get_assignment, create_assignment, revoke_assignment)
тЬЕ рд╡реЙрд▓реЗрдЯ рд▓реЗрдирджреЗрди рдирд┐рд░реНрдорд╛рдг

### рдкрд░реАрдХреНрд╖рдг рдХрд╡рд░реЗрдЬ рдХреНрд╖реЗрддреНрд░

- рдпреВрдирд┐рдЯ рдкрд░реАрдХреНрд╖рдг: `src/test/pocx_*_tests.cpp`
- рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдкрд░реАрдХреНрд╖рдг: `test/functional/feature_pocx_*.py`
- рдПрдХреАрдХрд░рдг рдкрд░реАрдХреНрд╖рдг: Regtest рдХреЗ рд╕рд╛рде рдореИрдиреНрдпреБрдЕрд▓ рдкрд░реАрдХреНрд╖рдг

## рд╕рд╣рдорддрд┐ рдирд┐рдпрдо

### рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдирд┐рд░реНрдорд╛рдг рдирд┐рдпрдо

1. **рд╕реНрд╡рд╛рдорд┐рддреНрд╡:** рд▓реЗрдирджреЗрди plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
2. **рд╕реНрдерд┐рддрд┐:** Plot UNASSIGNED рдпрд╛ REVOKED рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
3. **рдкреНрд░рд╛рд░реВрдк:** POCX рдорд╛рд░реНрдХрд░ + 2x 20-рдмрд╛рдЗрдЯ рдкрддреЛрдВ рдХреЗ рд╕рд╛рде рд╡реИрдз OP_RETURN
4. **рд╡рд┐рд╢рд┐рд╖реНрдЯрддрд╛:** рдПрдХ рд╕рдордп рдореЗрдВ рдкреНрд░рддрд┐ plot рдПрдХ рд╕рдХреНрд░рд┐рдп рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ

### рдирд┐рд░рд╕реНрддреАрдХрд░рдг рдирд┐рдпрдо

1. **рд╕реНрд╡рд╛рдорд┐рддреНрд╡:** рд▓реЗрдирджреЗрди plot рдорд╛рд▓рд┐рдХ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
2. **рдЕрд╕реНрддрд┐рддреНрд╡:** рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдореМрдЬреВрдж рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдкрд╣рд▓реЗ рд╕реЗ рдирд┐рд░рд╕реНрдд рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
3. **рдкреНрд░рд╛рд░реВрдк:** XCOP рдорд╛рд░реНрдХрд░ + 20-рдмрд╛рдЗрдЯ рдкрддреЗ рдХреЗ рд╕рд╛рде рд╡реИрдз OP_RETURN

### рд╕рдХреНрд░рд┐рдпрдг рдирд┐рдпрдо

- **рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рдХреНрд░рд┐рдпрдг:** `assignment_height + nForgingAssignmentDelay`
- **рдирд┐рд░рд╕реНрддреАрдХрд░рдг рд╕рдХреНрд░рд┐рдпрдг:** `revocation_height + nForgingRevocationDelay`
- **рд╡рд┐рд▓рдВрдм:** рдкреНрд░рддрд┐ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдпреЛрдЧреНрдп (рдЬреИрд╕реЗ, 2-рдорд┐рдирдЯ рдмреНрд▓реЙрдХ рд╕рдордп рдХреЗ рд╕рд╛рде 30 рдмреНрд▓реЙрдХ = ~1 рдШрдВрдЯрд╛)

### рдмреНрд▓реЙрдХ рд╕рддреНрдпрд╛рдкрди

- рдЕрдорд╛рдиреНрдп рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ/рдирд┐рд░рд╕реНрддреАрдХрд░рдг тЖТ рдмреНрд▓реЙрдХ рдЕрд╕реНрд╡реАрдХреГрдд (рд╕рд╣рдорддрд┐ рд╡рд┐рдлрд▓рддрд╛)
- OP_RETURN рдЖрдЙрдЯрдкреБрдЯ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ UTXO рд╕реЗрдЯ рд╕реЗ рдмрд╛рд╣рд░ (рдорд╛рдирдХ Bitcoin рд╡реНрдпрд╡рд╣рд╛рд░)
- рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ ConnectBlock рдореЗрдВ UTXO рдЕрдкрдбреЗрдЯ рд╕реЗ рдкрд╣рд▓реЗ рд╣реЛрддреА рд╣реИ

## рдирд┐рд╖реНрдХрд░реНрд╖

рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд PoCX рдлреЛрд░реНрдЬрд┐рдВрдЧ рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ:

тЬЕ **рд╕рд░рд▓рддрд╛:** рдорд╛рдирдХ Bitcoin рд▓реЗрдирджреЗрди, рдХреЛрдИ рд╡рд┐рд╢реЗрд╖ UTXOs рдирд╣реАрдВ
тЬЕ **рд▓рд╛рдЧрдд-рдкреНрд░рднрд╛рд╡реА:** рдХреЛрдИ dust рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ, рдХреЗрд╡рд▓ рд▓реЗрдирджреЗрди рд╢реБрд▓реНрдХ
тЬЕ **Reorg рд╕реБрд░рдХреНрд╖рд╛:** рд╡реНрдпрд╛рдкрдХ undo рдбреЗрдЯрд╛ рд╕рд╣реА рд╕реНрдерд┐рддрд┐ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ
тЬЕ **рдкрд░рдорд╛рдгреБ рдЕрдкрдбреЗрдЯ:** LevelDB рдмреИрдЪ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реБрд╕рдВрдЧрддрддрд╛
тЬЕ **рдкреВрд░реНрдг рдЗрддрд┐рд╣рд╛рд╕:** рд╕рдордп рдХреЗ рд╕рд╛рде рд╕рднреА рдЕрд╕рд╛рдЗрдирдореЗрдВрдЯ рдХрд╛ рдкреВрд░реНрдг рдСрдбрд┐рдЯ рдЯреНрд░реЗрд▓
тЬЕ **рд╕реНрд╡рдЪреНрдЫ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░:** рдиреНрдпреВрдирддрдо Bitcoin Core рд╕рдВрд╢реЛрдзрди, рдкреГрдердХ PoCX рдХреЛрдб
тЬЕ **рдЙрддреНрдкрд╛рджрди рддреИрдпрд╛рд░:** рдкреВрд░реНрдгрддрдГ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд, рдкрд░реАрдХреНрд╖рд┐рдд, рдФрд░ рд╕рдВрдЪрд╛рд▓рдирд░рдд

### рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЧреБрдгрд╡рддреНрддрд╛

- **рдХреЛрдб рд╕рдВрдЧрдарди:** рдЙрддреНрдХреГрд╖реНрдЯ - Bitcoin Core рдФрд░ PoCX рдХреЗ рдмреАрдЪ рд╕реНрдкрд╖реНрдЯ рдкреГрдердХреНрдХрд░рдг
- **рддреНрд░реБрдЯрд┐ рд╣реИрдВрдбрд▓рд┐рдВрдЧ:** рд╡реНрдпрд╛рдкрдХ рд╕рд╣рдорддрд┐ рд╕рддреНрдпрд╛рдкрди
- **рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг:** рдХреЛрдб рдЯрд┐рдкреНрдкрдгрд┐рдпрд╛рдВ рдФрд░ рд╕рдВрд░рдЪрдирд╛ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝рд┐рдд
- **рдкрд░реАрдХреНрд╖рдг:** рдХреЛрд░ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдкрд░реАрдХреНрд╖рд┐рдд, рдПрдХреАрдХрд░рдг рд╕рддреНрдпрд╛рдкрд┐рдд

### рдкреНрд░рдорд╛рдгрд┐рдд рдореБрдЦреНрдп рдбрд┐рдЬрд╝рд╛рдЗрди рдирд┐рд░реНрдгрдп

1. тЬЕ OP_RETURN-рдХреЗрд╡рд▓ рджреГрд╖реНрдЯрд┐рдХреЛрдг (рдмрдирд╛рдо UTXO-рдЖрдзрд╛рд░рд┐рдд)
2. тЬЕ рдЕрд▓рдЧ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реНрдЯреЛрд░реЗрдЬ (рдмрдирд╛рдо Coin extraData)
3. тЬЕ рдкреВрд░реНрдг рдЗрддрд┐рд╣рд╛рд╕ рдЯреНрд░реИрдХрд┐рдВрдЧ (рдмрдирд╛рдо рдХреЗрд╡рд▓-рд╡рд░реНрддрдорд╛рди)
4. тЬЕ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ (рдмрдирд╛рдо UTXO рдЦрд░реНрдЪ)
5. тЬЕ рд╕рдХреНрд░рд┐рдпрдг рд╡рд┐рд▓рдВрдм (reorg рд╣рдорд▓реЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ)

рд╕рд┐рд╕реНрдЯрдо рдПрдХ рд╕реНрд╡рдЪреНрдЫ, рд░рдЦрд░рдЦрд╛рд╡ рдпреЛрдЧреНрдп рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рд╕рд╛рде рд╕рднреА рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░рд▓ рд▓рдХреНрд╖реНрдпреЛрдВ рдХреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред

---

[тЖР рдкрд┐рдЫрд▓рд╛: рд╕рд╣рдорддрд┐ рдФрд░ рдорд╛рдЗрдирд┐рдВрдЧ](3-consensus-and-mining.md) | [ЁЯУШ рд╡рд┐рд╖рдп-рд╕реВрдЪреА](index.md) | [рдЕрдЧрд▓рд╛: рд╕рдордп рд╕рд┐рдВрдХреНрд░рдирд╛рдЗрдЬрд╝реЗрд╢рди тЖТ](5-timing-security.md)
